<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yoursite.com","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.8.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="website">
<meta property="og:title" content="zinego&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="zinego&#39;s blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="zinego">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yoursite.com/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>zinego's blog</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">zinego's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li>
        <li class="menu-item menu-item-github"><a href="https://github.com/zinego" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>Github</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zinego"
      src="/images/default.png">
  <p class="site-author-name" itemprop="name">zinego</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/zinego" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/13/%E5%9F%BA%E4%BA%8EFFmpeg%E7%9A%84%E8%A7%86%E9%A2%91%E6%B0%B4%E5%8D%B0%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/default.png">
      <meta itemprop="name" content="zinego">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zinego's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/13/%E5%9F%BA%E4%BA%8EFFmpeg%E7%9A%84%E8%A7%86%E9%A2%91%E6%B0%B4%E5%8D%B0%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">åŸºäºFFmpegçš„è§†é¢‘æ°´å°å¤„ç†æ–¹æ¡ˆ</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-06-13 16:13:04" itemprop="dateCreated datePublished" datetime="2020-06-13T16:13:04+08:00">2020-06-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-10-31 13:59:30" itemprop="dateModified" datetime="2021-10-31T13:59:30+08:00">2021-10-31</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">è§†é¢‘å¤„ç†</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>2 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ä¸€-èƒŒæ™¯"><a href="#ä¸€-èƒŒæ™¯" class="headerlink" title="ä¸€. èƒŒæ™¯"></a>ä¸€. èƒŒæ™¯</h2><blockquote>
<p>å› æ”¿ç­–éœ€è¦, äº”æœˆåº•æ”¶åˆ°äº†ä¸€ä¸ªåº”æ€¥è§†é¢‘æ°´å°çš„éœ€æ±‚, éœ€è¦å¯¹ä¸‹æ¸¸ç”Ÿäº§å‡ºæ¥çš„è§†é¢‘åœ¨è½¬ç ä¹‹å‰è¿›è¡ŒåŠ æ°´å°çš„å¤„ç†, æ¥å¯¹è§†é¢‘çš„<strong>ä¸åŒç‰‡æ®µ</strong>è¿›è¡Œæ ‡è®°</p>
</blockquote>
<h2 id="äºŒ-æ‰€éœ€å·¥å…·"><a href="#äºŒ-æ‰€éœ€å·¥å…·" class="headerlink" title="äºŒ. æ‰€éœ€å·¥å…·"></a>äºŒ. æ‰€éœ€å·¥å…·</h2><h3 id="1-FFmpeg"><a href="#1-FFmpeg" class="headerlink" title="1. FFmpeg"></a>1. FFmpeg</h3><blockquote>
<p>FFmpegæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯<a target="_blank" rel="noopener" href="https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz">ffmpeg v4.2.3-static</a>, æ–°ç‰ˆæœ¬çš„FFmpegè‡ªå¸¦åŠ æ°´å°åŠŸèƒ½, è€ç‰ˆæœ¬çš„å¯èƒ½éœ€è¦è‡ªå·±ç¼–è¯‘</p>
</blockquote>
<h3 id="2-Linuxå­—ä½“æ”¯æŒ"><a href="#2-Linuxå­—ä½“æ”¯æŒ" class="headerlink" title="2. Linuxå­—ä½“æ”¯æŒ"></a>2. Linuxå­—ä½“æ”¯æŒ</h3><ol>
<li>å®‰è£…fontconfig <code>yum install fontconfig</code>,</li>
<li>å°†å­—ä½“æ–‡ä»¶æ”¾å…¥<code>/usr/share/fonts/chinese</code>ç›®å½•ä¸­</li>
<li>æ‰§è¡Œ<code>fc-list :lang=zh</code>å°±å¯ä»¥çœ‹åˆ°å®‰è£…å¥½çš„å­—ä½“æ–‡ä»¶</li>
</ol>
<h3 id="3-ass-srt-å­—å¹•æ–‡ä»¶"><a href="#3-ass-srt-å­—å¹•æ–‡ä»¶" class="headerlink" title="3. ass(srt)å­—å¹•æ–‡ä»¶"></a>3. ass(srt)å­—å¹•æ–‡ä»¶</h3><h2 id="ä¸‰-FFmpegåŠ æ°´å°è§£å†³æ–¹æ¡ˆ"><a href="#ä¸‰-FFmpegåŠ æ°´å°è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ä¸‰. FFmpegåŠ æ°´å°è§£å†³æ–¹æ¡ˆ"></a>ä¸‰. FFmpegåŠ æ°´å°è§£å†³æ–¹æ¡ˆ</h2><h3 id="1-åŠ å›¾ç‰‡æ°´å°"><a href="#1-åŠ å›¾ç‰‡æ°´å°" class="headerlink" title="1. åŠ å›¾ç‰‡æ°´å°"></a>1. åŠ å›¾ç‰‡æ°´å°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i origin.mp4 -i watermark.png -filter_complex <span class="string">&quot;overlay=x=main_w-overlay_w:y=main_h-overlay_h&quot;</span> pic_watermark.mp4</span><br></pre></td></tr></table></figure>
<p>æ°´å°çš„ä½ç½®ç”±å¦‚ä¸‹å…­ä¸ªå‚æ•°æ¥ç•Œå®š.<br>å›¾ç‰‡æ°´å°çš„ä¼˜ç‚¹æ˜¯æ°´å°çš„æ ¼å¼(å­—ä½“,é¢œè‰²,é€æ˜åº¦ç­‰)å¯ä»¥ç”±UIè€å¸ˆæå‰ç”Ÿæˆ, ä¸ç”¨æ‰§è¡Œå‘½ä»¤æ—¶å»æ§åˆ¶<br>ä½†æ˜¯è¿™ç§æ°´å°æ–¹å¼åŠ å‡ºæ¥éƒ½æ˜¯æ•´ä¸ªè§†é¢‘éƒ½åŠ ä¸Šäº†æ°´å°, å¦‚æœæƒ³è¦æ§åˆ¶æŸä¸ªæ—¶é—´åŒºé—´å»åŠ æ°´å°, ä¸å¤ªå¥½æ§åˆ¶. è¿™æ ·ä¹Ÿå°±æ— æ³•æ»¡è¶³æœ¬æ¬¡éœ€æ±‚, pass. </p>
<ul>
<li>main_hä¸ºè¾“å…¥è§†é¢‘çš„é«˜åº¦, </li>
<li>main_wä¸ºè¾“å…¥è§†é¢‘çš„å®½åº¦, </li>
<li>overlay_hä¸ºä¼ å…¥å›¾ç‰‡çš„é«˜åº¦, </li>
<li>overlay_wä¸ºä¼ å…¥å›¾ç‰‡çš„å®½åº¦,</li>
<li>xä¸ºæ°´å°å·¦è¾¹ç•Œä¸è§†é¢‘å·¦è¾¹ç•Œçš„è·ç¦»</li>
<li>yä¸ºæ°´å°ä¸Šè¾¹ç•Œä¸è§†é¢‘ä¸Šè¾¹ç•Œçš„è·ç¦»</li>
</ul>
<p>åŠ å®Œæ°´å°çš„æ•ˆæœå¦‚ä¸‹å›¾<br><img src="/image/pic_watermark.png" alt="image.png"></p>
<h3 id="2-åŠ å­—å¹•æ°´å°-srt"><a href="#2-åŠ å­—å¹•æ°´å°-srt" class="headerlink" title="2. åŠ å­—å¹•æ°´å°[srt]"></a>2. åŠ å­—å¹•æ°´å°[srt]</h3><blockquote>
<p>å›¾ç‰‡æ°´å°æ— æ³•æ»¡è¶³éœ€æ±‚, æˆ‘ä»¬å†å¯»æ‰¾å…¶ä»–è§£å†³æ–¹æ¡ˆçš„æ—¶å€™å‘ç°<strong>ç»™è§†é¢‘å¤šä¸ªæ—¶é—´åŒºé—´åŠ æ°´å°</strong>ä¸<strong>ç”µå½±å­—å¹•</strong>æ¯”è¾ƒç±»ä¼¼, äºæ˜¯å¼€å§‹å¯»æ‰¾ç»™è§†é¢‘åŠ å­—å¹•çš„è§£å†³æ–¹æ¡ˆ. </p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i origin.mp4 -vf subtitles=watermark.srt srt_watermark.mp4</span><br></pre></td></tr></table></figure>
<p>å­—å¹•å†…å®¹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">00:00:16,266 --&gt; 00:01:00,359</span><br><span class="line">FFMPEG</span><br><span class="line"></span><br><span class="line">2</span><br><span class="line">00:01:16,266 --&gt; 00:10:25,359</span><br><span class="line">FFMPEG</span><br></pre></td></tr></table></figure>
<p>åŠ å‡ºæ¥çš„æ•ˆæœå¦‚ä¸‹å›¾, è¿™ç§æ–¹å¼å¯ä»¥è§£å†³æŒ‰æ—¶é—´åŒºé—´åŠ æ°´å°çš„éœ€æ±‚, ä½†æ˜¯æ— æ³•æŒ‡å®šå­—å¹•æ ¼å¼, æ— æ³•æŒ‡å®šå­—å¹•ä½ç½®, å°±æ˜¯å•çº¯çš„ç”µå½±å­—å¹•(è‡³å°‘æˆ‘æ²¡æ‰¾åˆ°ğŸ¤¦â€â™‚ï¸). è¿™ç§æ–¹å¼ä¹Ÿæ— æ³•æ»¡è¶³éœ€æ±‚, passâ€¦</p>
<p><img src="/image/srt.png" alt="image.png"></p>
<h3 id="3-åŠ å­—å¹•æ°´å°-ass"><a href="#3-åŠ å­—å¹•æ°´å°-ass" class="headerlink" title="3. åŠ å­—å¹•æ°´å°[ass]"></a>3. åŠ å­—å¹•æ°´å°[ass]</h3><p>asså­—å¹•æ–‡ä»¶åŠ æ°´å°å¯ä»¥å®šåˆ¶å¾ˆå¤šä¸ªæ€§åŒ–çš„ä¸œè¥¿, è¯ä¸å¤šè¯´, ä¸Šå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i origin.mp4 -vf <span class="string">&quot;ass=watermark.ass&quot;</span> ass_watermark.mp4</span><br></pre></td></tr></table></figure>
<p>å­—å¹•æ–‡ä»¶å†…å®¹ä¸º:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[Script Info]</span><br><span class="line">Title: YYeTs</span><br><span class="line">Original Script: YYeTs</span><br><span class="line">Original Translation:</span><br><span class="line">Original Timing:</span><br><span class="line">Original Editing:</span><br><span class="line">Script Updated By:</span><br><span class="line">Update Details:</span><br><span class="line">ScriptType: v4.00+</span><br><span class="line">PlayResX: 384</span><br><span class="line">PlayResY: 288</span><br><span class="line">Timer: 100.0000</span><br><span class="line">Synch Point: 0</span><br><span class="line">WrapStyle: 0</span><br><span class="line">ScaledBorderAndShadow: no</span><br><span class="line"></span><br><span class="line">[Aegisub Project Garbage]</span><br><span class="line">Scroll Position: 483</span><br><span class="line">Active Line: 441</span><br><span class="line"></span><br><span class="line">[V4+ Styles]</span><br><span class="line">Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding</span><br><span class="line">Style: Default,HanziPen TC,24,&amp;H00FFFFFF,&amp;H00FFFFFF,&amp;H00FFFFFF,&amp;H00FFFFFF,0,0,0,0,100,100,0,0,1,0,1,3,5,10,10,134</span><br><span class="line"></span><br><span class="line">[Events]</span><br><span class="line">Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text</span><br><span class="line">Dialogue: 0,0:00:00.12,0:10:34.29,Default,NTP,0,0,0,,&#123;\alpha&amp;H72&amp;&#125;å¤§é±¼æµ·æ£ </span><br></pre></td></tr></table></figure>
<p>Asså­—å¹•æ–‡ä»¶æ¯”è¾ƒå¤æ‚, åæ­£æˆ‘æ˜¯è‡ªå·±æ‰‹å†™ä¸å‡ºæ¥, è¿™æ˜¯æˆ‘åœ¨ç½‘ä¸Šä¸‹è½½äº†ä¸€ä¸ªassæ–‡ä»¶, è‡ªå·±æ”¹äº†ä¸€äº›å‚æ•°çš„æœ€ç»ˆæ ·å­.<br>å…¶ä¸­ç¬¬ä¸€éƒ¨åˆ†<code>[Script Info]</code>å’Œç¬¬äºŒéƒ¨åˆ†<code>[Aegisub Project Garbage]</code>çš„æ„ä¹‰è¿™é‡Œä¸å…³æ³¨,<br>ç¬¬ä¸‰éƒ¨åˆ†<code>[V4+ Styles]</code>åŒ…å«äº†æ‰€æœ‰æ ·å¼çš„å®šä¹‰, <code>Format</code>è¡Œä¸<code>Style</code>è¡Œ ä¸ºé”®å€¼å¯¹, Formatä¸ºKey, Styleä¸ºValue, å¯ä»¥å®šä¹‰å¤šä¸ªStyle, æ ¹æ®Style.NameåŒºåˆ†.<br>ç¬¬å››éƒ¨åˆ†<code>[Events]</code>ä¸­, ä¾æ—§æ˜¯Formatä¸ºKey, Dialogueä¸ºæ¯ä¸ªæ—¶é—´åŒºé—´, å­—å¹•çš„å„ç§å‚æ•°, åŒ…æ‹¬èµ·æ­¢æ—¶é—´, æ ·å¼, ä»¥åŠæ–‡æ¡ˆ.<br>å…¶ä¸­ä¸€äº›Format.Keyçš„æ„ä¹‰å¦‚ä¸‹</p>
<ul>
<li>Name: æ ·å¼çš„åå­—</li>
<li>Fontname: å­—ä½“, ä¸­æ–‡å­—ä½“åœ¨Linuxå¯ä»¥é€šè¿‡fc-listæ‰¾åˆ°å¯¹åº”çš„è‹±æ–‡å</li>
<li>Fontsize: å­—ä½“å¤§å°</li>
<li>PrimaryColour: å­—å¹•é¢œè‰²</li>
<li>BackColour: å­—ä½“é˜´å½±é¢œè‰²</li>
<li>Bold: æ˜¯å¦åŠ ç²—</li>
<li>Italic: æ˜¯å¦æ–œä½“</li>
<li>Underline: æ˜¯å¦ä¸‹åˆ’çº¿</li>
<li>StrikeOut: æ˜¯å¦åˆ é™¤çº¿</li>
<li>ScaleX: ä¿®æ”¹å­—ä½“çš„å®½åº¦</li>
<li>ScaleY: ä¿®æ”¹å­—ä½“çš„é«˜åº¦</li>
<li>Spacing: å­—ç¬¦ä¹‹é—´é¢å¤–çš„é—´éš™</li>
<li>BorderStyle: è¾¹æ¡†çš„æ ·å¼ã€‚1 ä¸ºè¾¹æ¡† + é˜´å½±ï¼Œ3 ä¸ºä¸é€æ˜èƒŒæ™¯ã€‚</li>
<li>Outline: å¦‚æœ BorderStyle ä¸º 1ï¼Œå®ƒå®šä¹‰äº†æ–‡å­—è¾¹æ¡†çš„åƒç´ å®½åº¦ã€‚</li>
<li>Alignment: å­—å¹•ä½ç½®: 1,2,3 =&gt; å·¦ä¸‹, ä¸­ä¸‹, å³ä¸‹, 4,5,6 =&gt; å·¦ä¸­, ä¸­ä¸­, å³ä¸­, 7,8,9=&gt; å·¦ä¸Š, ä¸­ä¸Š, å³ä¸Š</li>
<li>MarginL: åˆ°å±å¹•å·¦è¾¹ç¼˜çš„è·ç¦»</li>
<li>MarginR: åˆ°å±å¹•å³è¾¹ç¼˜çš„è·ç¦»</li>
<li>MarginV: å±å¹•å‚ç›´è·ç¦», å¦‚æœæ˜¯åº•éƒ¨å­—å¹•, åˆ™æ˜¯å±å¹•åº•éƒ¨çš„è·ç¦»</li>
<li>Encoding: å®šä¹‰å­—ä½“çš„å­—ç¬¦é›†æˆ–ç¼–ç æ–¹å¼=&gt;0 ä¸ºè‹±æ–‡ï¼Œ134 ä¸ºç®€ä½“ä¸­æ–‡ï¼Œ136 ä¸ºç¹ä½“ä¸­æ–‡</li>
<li>æ ·å¼è¦†å†™ä»£ç : æ ·å¼ç›´æ¥æŒ‡å®šé€æ˜åº¦è¯•äº†å¾ˆå¤šæ¬¡éƒ½ä¸æˆåŠŸ, åªå¥½ä½¿ç”¨æ ·å¼è¦†å†™ä»£ç æ¥æ»¡è¶³é€æ˜åº¦çš„éœ€æ±‚. {\alpha&amp;H72&amp;}ä¸ºæ ·å¼è¦†å†™ä»£ç , å¯ä»¥é‡ç½®æ ·å¼, alphaæŒ‡å®šé€æ˜åº¦, 72/256=28% , å¤§æ¦‚28%çš„é€æ˜åº¦</li>
</ul>
<p>æ°´å°æ•ˆæœå¦‚ä¸‹, ç”¨çš„Macè‡ªå¸¦çš„<code>ç¿©ç¿©ä½“-ç®€</code>, å³ä¸‹, åº•éƒ¨10, å³å±å¹•10<br><img src="/image/ass.png" alt="image.png"></p>
<h2 id="å››-å‚è€ƒèµ„æ–™"><a href="#å››-å‚è€ƒèµ„æ–™" class="headerlink" title="å››. å‚è€ƒèµ„æ–™"></a>å››. å‚è€ƒèµ„æ–™</h2><ol>
<li><a target="_blank" rel="noopener" href="https://moejj.com/ffmpeg-add-subtitles-and-watermark/">ffmpegåŒæ—¶æ·»åŠ æ°´å°å’Œå­—å¹•ï¼Œè¯¦ç»†æ•™ç¨‹</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/weizhenye/ASS/wiki/ASS-%E5%AD%97%E5%B9%95%E6%A0%BC%E5%BC%8F%E8%A7%84%E8%8C%83">ASS å­—å¹•æ ¼å¼è§„èŒƒ</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/Golang%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/default.png">
      <meta itemprop="name" content="zinego">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zinego's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/26/Golang%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF/" class="post-title-link" itemprop="url">Golangå¸¸è§é”™è¯¯</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-05-26 00:30:51" itemprop="dateCreated datePublished" datetime="2020-05-26T00:30:51+08:00">2020-05-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-10-31 13:59:30" itemprop="dateModified" datetime="2021-10-31T13:59:30+08:00">2021-10-31</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1-å˜é•¿interfaceå‚æ•°"><a href="#1-å˜é•¿interfaceå‚æ•°" class="headerlink" title="1. å˜é•¿interfaceå‚æ•°"></a>1. å˜é•¿interfaceå‚æ•°</h3><p>å˜é•¿interfaceä¼ å‚, ä¼ å…¥çš„æ•°ç»„å¦‚æœä¸åŠ <code>...</code>, å¯èƒ½ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªinterface, è€Œä¸ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªinterfaceæ•°ç»„. ä¾‹å¦‚:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calLen</span><span class="params">(src ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="built_in">len</span>(src), src)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test1</span><span class="params">(src ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	calLen(src)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test2</span><span class="params">(src ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	calLen(src...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	calLen(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">	test1(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">	test2(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 3 [1 2 3]</span></span><br><span class="line"><span class="comment">// 1 [[1 2 3]]</span></span><br><span class="line"><span class="comment">// 3 [1 2 3]</span></span><br></pre></td></tr></table></figure>

<h3 id="2-å¾ªç¯åˆå§‹åŒ–-å…¶å®ä¸ç®—å¸¸è§-ç®—è®¾è®¡çš„æ¯”è¾ƒå·®"><a href="#2-å¾ªç¯åˆå§‹åŒ–-å…¶å®ä¸ç®—å¸¸è§-ç®—è®¾è®¡çš„æ¯”è¾ƒå·®" class="headerlink" title="2. å¾ªç¯åˆå§‹åŒ–(å…¶å®ä¸ç®—å¸¸è§, ç®—è®¾è®¡çš„æ¯”è¾ƒå·®)"></a>2. å¾ªç¯åˆå§‹åŒ–(å…¶å®ä¸ç®—å¸¸è§, ç®—è®¾è®¡çš„æ¯”è¾ƒå·®)</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyStruct <span class="keyword">struct</span> &#123;</span><br><span class="line">	call <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line">	a    <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> myStruct = MyStruct&#123;a: <span class="number">1</span>, call: callFunction&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">callFunction</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;....&quot;</span>, myStruct.a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°†ç¼–è¯‘æœŸçš„åˆå§‹åŒ–, æ”¹ä¸ºè¿è¡Œæ—¶çš„åˆå§‹åŒ–(initå‡½æ•°)å³å¯è§£å†³é—®é¢˜:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyStruct <span class="keyword">struct</span> &#123;</span><br><span class="line">	call <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line">	a    <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	myStruct.call = callFunction</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> myStruct = MyStruct&#123;a: <span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">callFunction</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">&quot;....&quot;</span>, myStruct.a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	myStruct.call()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/25/%E5%80%BC%E6%96%B9%E6%B3%95%E8%BF%98%E6%98%AF%E5%BC%95%E7%94%A8%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/default.png">
      <meta itemprop="name" content="zinego">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zinego's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/25/%E5%80%BC%E6%96%B9%E6%B3%95%E8%BF%98%E6%98%AF%E5%BC%95%E7%94%A8%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">å€¼æ–¹æ³•è¿˜æ˜¯å¼•ç”¨æ–¹æ³•</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-05-25 22:28:53" itemprop="dateCreated datePublished" datetime="2020-05-25T22:28:53+08:00">2020-05-25</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-10-31 13:59:30" itemprop="dateModified" datetime="2021-10-31T13:59:30+08:00">2021-10-31</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>703</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>æ–‡ç« æ•´ç†è‡ª<a target="_blank" rel="noopener" href="https://www.qtmuniao.com/2020/01/06/go-value-pointer-method/"><strong>Muniaoâ€™s blog</strong></a>, çº¯å±è‡ªè¡Œç¬”è®°</p>
<h2 id="1-åŒºåˆ«"><a href="#1-åŒºåˆ«" class="headerlink" title="1. åŒºåˆ«"></a>1. åŒºåˆ«</h2><p>å…³äºä¸¤è€…çš„åŒºåˆ«, åœ¨å®˜æ–¹ <a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html#pointers_vs_values">effective go</a> æ–‡æ¡£ä¸­ï¼Œå¯¹ä¸¤è€…åŒºåˆ«å…¶å®æ˜¯æœ‰ç²¾ç¡®æè¿°çš„ï¼š</p>
<blockquote>
<p>The rule about pointers vs. values for receivers is that value methods can be invoked on pointers and values, but pointer methods can only be invoked on pointers.</p>
</blockquote>
<blockquote>
<p>There is a handy exception, though. When the value is addressable, the language takes care of the common case of invoking a pointer method on a value by inserting the address operator automatically.</p>
</blockquote>
<p>å¤§æ„å¦‚ä¸‹ï¼š</p>
<ol>
<li>å€¼æ–¹æ³•ï¼ˆvalue methodsï¼‰å¯ä»¥é€šè¿‡æŒ‡é’ˆå’Œå€¼è°ƒç”¨ï¼Œä½†æ˜¯æŒ‡é’ˆæ–¹æ³•ï¼ˆpointer methodsï¼‰åªèƒ½é€šè¿‡æŒ‡é’ˆæ¥è°ƒç”¨ã€‚</li>
<li>ä½†æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œå¦‚æœæŸä¸ªå€¼æ˜¯å¯å¯»å€çš„ï¼ˆaddressableï¼Œæˆ–è€…è¯´å·¦å€¼ï¼‰ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šåœ¨å€¼è°ƒç”¨æŒ‡é’ˆæ–¹æ³•æ—¶è‡ªåŠ¨æ’å…¥å–åœ°å€ç¬¦ï¼Œä½¿å¾—åœ¨æ­¤æƒ…å½¢ä¸‹çœ‹èµ·æ¥åƒæŒ‡é’ˆæ–¹æ³•ä¹Ÿå¯ä»¥é€šè¿‡å€¼æ¥è°ƒç”¨ã€‚</li>
</ol>
<h2 id="2-å–èˆ"><a href="#2-å–èˆ" class="headerlink" title="2. å–èˆ"></a>2. å–èˆ</h2><p>åœ¨å®šä¹‰ receiver ä¸ºå€¼è¿˜æ˜¯æŒ‡é’ˆæ—¶ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªè€ƒè™‘ç‚¹ï¼š</p>
<ol>
<li><strong>æ–¹æ³•æ˜¯å¦éœ€è¦ä¿®æ”¹ receiver æœ¬èº«ã€‚</strong> å¦‚æœéœ€è¦ï¼Œé‚£ receiver å¿…ç„¶è¦æ˜¯æŒ‡é’ˆäº†ã€‚</li>
<li><strong>æ•ˆç‡é—®é¢˜ã€‚</strong> å¦‚æœ receiver æ˜¯å€¼ï¼Œé‚£åœ¨æ–¹æ³•è°ƒç”¨æ—¶ä¸€å®šä¼šäº§ç”Ÿ struct æ‹·è´ï¼Œè€Œå¤§å¯¹è±¡æ‹·è´ä»£ä»·å¾ˆå¤§å“¦ã€‚</li>
<li><strong>ä¸€è‡´æ€§ã€‚</strong> å¯¹äºåŒä¸€ä¸ª struct çš„æ–¹æ³•ï¼Œvalue method å’Œ pointer method æ··æ‚ç”¨è‚¯å®šæ˜¯ä¸ä¼˜é›…çš„å•¦ã€‚</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/06/Redis%E6%BA%90%E7%A0%81-%E8%B7%B3%E8%B7%83%E8%A1%A8skipList/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/default.png">
      <meta itemprop="name" content="zinego">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zinego's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/03/06/Redis%E6%BA%90%E7%A0%81-%E8%B7%B3%E8%B7%83%E8%A1%A8skipList/" class="post-title-link" itemprop="url">Redisæºç -è·³è·ƒè¡¨skipList</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-03-06 19:35:17" itemprop="dateCreated datePublished" datetime="2019-03-06T19:35:17+08:00">2019-03-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-10-31 13:59:30" itemprop="dateModified" datetime="2021-10-31T13:59:30+08:00">2021-10-31</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>5.7k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>5 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="è·³è·ƒè¡¨"><a href="#è·³è·ƒè¡¨" class="headerlink" title="è·³è·ƒè¡¨"></a>è·³è·ƒè¡¨</h2><h3 id="1-å†…å­˜åˆ†å¸ƒ"><a href="#1-å†…å­˜åˆ†å¸ƒ" class="headerlink" title="1. å†…å­˜åˆ†å¸ƒ"></a>1. å†…å­˜åˆ†å¸ƒ</h3><p><img src="/image/skiplist.png" alt="Alt text"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></span><br><span class="line">    sds ele;                            <span class="comment">// å…ƒç´ </span></span><br><span class="line">    <span class="keyword">double</span> score;                       <span class="comment">// èŠ‚ç‚¹çš„åˆ†æ•°, æ®æ­¤æ’å…¥æ—¶å¯¹èŠ‚ç‚¹è¿›è¡Œæ’åº</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span>     <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span>             <span class="comment">// å­ç»“æ„, å•å±‚</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span>  <span class="comment">// å½“å‰å±‚ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> span;             <span class="comment">// å½“å‰å±‚è·ç¦»ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»</span></span><br><span class="line">    &#125; level[];                          <span class="comment">// å¤šä¸ªå±‚, å…¶ä¸­, å¤´èŠ‚ç‚¹æœ‰64å±‚</span></span><br><span class="line">&#125; zskiplistNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">header</span>, *<span class="title">tail</span>;</span>  <span class="comment">// å¤´å°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> length;                 <span class="comment">// èŠ‚ç‚¹ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">int</span> level;                            <span class="comment">// å±‚æ•°æœ€å¤šçš„èŠ‚ç‚¹çš„å±‚æ•°</span></span><br><span class="line">&#125; zskiplist;</span><br></pre></td></tr></table></figure>

<pre><code>å¤´èŠ‚ç‚¹ä¸è¿›è¡Œå­˜å‚¨
</code></pre>
<h3 id="2-è·³è·ƒè¡¨çš„level"><a href="#2-è·³è·ƒè¡¨çš„level" class="headerlink" title="2. è·³è·ƒè¡¨çš„level"></a>2. è·³è·ƒè¡¨çš„level</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">zslRandomLevel</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> level = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 0xFFFF = 1111111111111111</span></span><br><span class="line"><span class="comment">     * 0xFFFF * 0.25 = 0011111111111111 </span></span><br><span class="line"><span class="comment">     * ä¹Ÿå°±æ˜¯æœ€é«˜ä¸¤ä½æœ‰æŸä½æ˜¯1çš„è¯, level+1, æ¦‚ç‡æ˜¯1/4</span></span><br><span class="line"><span class="comment">     * levelçš„æ•°å­¦æœŸæœ›æ˜¯4/3, æ»¡è¶³å‡ ä½•åˆ†å¸ƒ</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">while</span> ((<span class="built_in">random</span>() &amp; <span class="number">0xFFFF</span>) &lt; (ZSKIPLIST_P * <span class="number">0xFFFF</span>))</span><br><span class="line">        level += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> (level &lt; ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>levelç”±ä»¥ä¸Šä»£ç ç”Ÿæˆ, æ¯æ¬¡level+1çš„æ¦‚ç‡æ˜¯1/4, å‡ºç°3/4çš„æ¦‚ç‡åœæ­¢å¾ªç¯, æ­¤æ—¶æ»¡è¶³å‡ ä½•åˆ†å¸ƒ, 
levelå€¼çš„æœŸæœ›æ˜¯1/(3/4) = 4 / 3
</code></pre>
<h3 id="3-è·³è·ƒè¡¨çš„æŸ¥æ‰¾"><a href="#3-è·³è·ƒè¡¨çš„æŸ¥æ‰¾" class="headerlink" title="3. è·³è·ƒè¡¨çš„æŸ¥æ‰¾"></a>3. è·³è·ƒè¡¨çš„æŸ¥æ‰¾</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = zsl-&gt;level - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</span><br><span class="line">           (x-&gt;level[i].forward-&gt;score &lt; curscore ||</span><br><span class="line">            (x-&gt;level[i].forward-&gt;score == curscore &amp;&amp;</span><br><span class="line">             <span class="built_in">sdscmp</span>(x-&gt;level[i].forward-&gt;ele, ele) &lt; <span class="number">0</span>))) &#123;</span><br><span class="line">        x = x-&gt;level[i].forward;</span><br><span class="line">    &#125;</span><br><span class="line">    update[i] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>ç±»ä¼¼çš„ä»£ç åœ¨è·³è·ƒè¡¨æºç ä¸­å‡ºç°å¾ˆå¤šæ¬¡, æŸ¥æ‰¾çš„æ–¹å¼å¾ˆå·§å¦™.
é¦–å…ˆè·³è·ƒè¡¨çš„åˆ—ä¸åˆ—ä¹‹é—´æ˜¯ä»å°åˆ°å¤§çš„, æ¯ä¸€åˆ—æœ‰ç›¸åŒçš„score
æŸ¥æ‰¾æ—¶ä»é«˜levelæ¥è¿›è¡ŒæŸ¥æ‰¾, è¶…å‡ºscoreå¤§å°åˆ™è¿›è¡Œæ›´ä½levelçš„æŸ¥è¯¢, æ­¤æ—¶ä¼šä»é«˜å±‚è·³è·ƒåˆ°ä½å±‚
levelçš„æœŸæœ›å€¼ä¸º4/3. 
</code></pre>
<h3 id="4-æ’å…¥è·³è·ƒè¡¨"><a href="#4-æ’å…¥è·³è·ƒè¡¨" class="headerlink" title="4. æ’å…¥è·³è·ƒè¡¨"></a>4. æ’å…¥è·³è·ƒè¡¨</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Insert a new node in the skiplist. Assumes the element does not already</span></span><br><span class="line"><span class="comment"> * exist (up to the caller to enforce that). The skiplist takes ownership</span></span><br><span class="line"><span class="comment"> * of the passed SDS string &#x27;ele&#x27;. */</span></span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslInsert</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, sds ele)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * update[i]è¡¨ç¤º ç¬¬iå±‚æ–°æ’å…¥çš„èŠ‚ç‚¹åº”è¯¥æ’å…¥åˆ°åœ¨update[i]åé¢</span></span><br><span class="line"><span class="comment">     * rankä»£è¡¨ç€update[i]ç‚¹ä¸headä¹‹é—´çš„è·ç¦»æ€»å’Œ</span></span><br><span class="line"><span class="comment">     * spanä»£è¡¨ç€å½“å‰levelä¸‹, å½“å‰èŠ‚ç‚¹ä¸ä¸‹ä¸€èŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> rank[ZSKIPLIST_MAXLEVEL];</span><br><span class="line">    <span class="keyword">int</span> i, level;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">serverAssert</span>(!<span class="built_in">isnan</span>(score));</span><br><span class="line">    x = zsl-&gt;header;</span><br><span class="line">    <span class="keyword">for</span> (i = zsl-&gt;level - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">/* store rank that is crossed to reach the insert position */</span></span><br><span class="line">        rank[i] = i == (zsl-&gt;level - <span class="number">1</span>) ? <span class="number">0</span> : rank[i + <span class="number">1</span>];</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å½“x-&gt;level[i]æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹, ä¸”ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å€¼å°äºå½“å‰èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         * å…³äºå°äº:</span></span><br><span class="line"><span class="comment">         * 1. ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å€¼å°äºè¦æ’å…¥çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         * 2. ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å€¼ç­‰äºè¦æ’å…¥çš„èŠ‚ç‚¹, ä¸”ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å­—ç¬¦ä¸²å­—å…¸åºå°äºè¦æ’å…¥çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</span><br><span class="line">               (x-&gt;level[i].forward-&gt;score &lt; score ||</span><br><span class="line">                (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</span><br><span class="line">                 <span class="built_in">sdscmp</span>(x-&gt;level[i].forward-&gt;ele, ele) &lt; <span class="number">0</span>))) &#123;</span><br><span class="line">            <span class="comment">// æ³¨æ„æ˜¯å…ˆåŠ åè¿­ä»£</span></span><br><span class="line">            rank[i] += x-&gt;level[i].span;</span><br><span class="line">            x = x-&gt;level[i].forward;</span><br><span class="line">        &#125;</span><br><span class="line">        update[i] = x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* we assume the element is not already inside, since we allow duplicated</span></span><br><span class="line"><span class="comment">     * scores, reinserting the same element should never happen since the</span></span><br><span class="line"><span class="comment">     * caller of zslInsert() should test in the hash table if the element is</span></span><br><span class="line"><span class="comment">     * already inside or not. */</span></span><br><span class="line">    level = <span class="built_in">zslRandomLevel</span>();</span><br><span class="line">    <span class="keyword">if</span> (level &gt; zsl-&gt;level) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = zsl-&gt;level; i &lt; level; i++) &#123;</span><br><span class="line">            rank[i] = <span class="number">0</span>;</span><br><span class="line">            update[i] = zsl-&gt;header;</span><br><span class="line">            update[i]-&gt;level[i].span = zsl-&gt;length;</span><br><span class="line">        &#125;</span><br><span class="line">        zsl-&gt;level = level;</span><br><span class="line">    &#125;</span><br><span class="line">    x = <span class="built_in">zslCreateNode</span>(level, score, ele);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; level; i++) &#123;</span><br><span class="line">        x-&gt;level[i].forward = update[i]-&gt;level[i].forward;</span><br><span class="line">        update[i]-&gt;level[i].forward = x;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* update span covered by update[i] as x is inserted here */</span></span><br><span class="line">        x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[<span class="number">0</span>] - rank[i]);</span><br><span class="line">        update[i]-&gt;level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* increment span for untouched levels */</span></span><br><span class="line">    <span class="keyword">for</span> (i = level; i &lt; zsl-&gt;level; i++) &#123;</span><br><span class="line">        update[i]-&gt;level[i].span++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿›æ˜¯å¤šæ­¥è¿›, é€€æ˜¯å•æ­¥é€€</span></span><br><span class="line">    x-&gt;backward = (update[<span class="number">0</span>] == zsl-&gt;header) ? <span class="literal">NULL</span> : update[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward)</span><br><span class="line">        x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        zsl-&gt;tail = x;</span><br><span class="line">    zsl-&gt;length++;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/image/1.png" alt="Alt text"><br><img src="/image/2.png" alt="Alt text"></p>
<pre><code>æ’å…¥æ—¶å€™é¦–å…ˆæŸ¥è¯¢åˆ°è¯¥æ’å…¥çš„ä½ç½®, å®é™…ä¸Šæ˜¯ä¸€åˆ—.
ç„¶åè·å–éšæœºçš„level
è¿›è¡ŒèŠ‚ç‚¹çš„æ’å…¥. æ›´æ–°æ¯ä¸€å±‚çš„spanå€¼. 
å…¶ä¸­, å¯¹line54, line55è¡Œçš„è§£é‡Šå¦‚ä¸‹:
å¯¹æ¯”ç¬¬ä¸€å¼ å›¾, åœ¨åˆ—4å’Œåˆ—5ä¹‹é—´æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹, ä»–çš„level=5, æ’å…¥ä¹‹åçš„ç»“æœä¸ºç¬¬äºŒå¼ å›¾, æ–°æ’å…¥çš„æ•°æ®åœ¨ç¬¬äº”åˆ—
é‚£ä¹ˆåœ¨ç¬¬ä¸€ç« å›¾ä¸­, rank[0]=1+1+1+1=4; rank[3]=2+1=3,node[3]-&gt;level[3].span=2
é‚£ä¹ˆæ’å…¥ä¹‹å, x-&gt;level[3].span=update[3]-&gt;level[3].span-(rank[0]-rank[3])=2-(2-1)=1
è§ç¬¬äºŒå¼ å›¾. 
update[3]-&gt;level[3].span=(rank[0]-rank[3])+1=2
ä¸çŸ¥é“æ€ä¹ˆè¯´çš„æ›´æ¸…æ¥š, æˆ‘ä¹Ÿçœ‹äº†å¾ˆä¹…, è§£é‡Šå¦‚æ­¤, è‡ªå·±æ‚Ÿ...
</code></pre>
<h3 id="5-æ›´æ–°æŸèŠ‚ç‚¹"><a href="#5-æ›´æ–°æŸèŠ‚ç‚¹" class="headerlink" title="5. æ›´æ–°æŸèŠ‚ç‚¹"></a>5. æ›´æ–°æŸèŠ‚ç‚¹</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Update the score of an elmenent inside the sorted set skiplist.</span></span><br><span class="line"><span class="comment"> * Note that the element must exist and must match &#x27;score&#x27;.</span></span><br><span class="line"><span class="comment"> * This function does not update the score in the hash table side, the</span></span><br><span class="line"><span class="comment"> * caller should take care of it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that this function attempts to just update the node, in case after</span></span><br><span class="line"><span class="comment"> * the score update, the node would be exactly at the same position.</span></span><br><span class="line"><span class="comment"> * Otherwise the skiplist is modified by removing and re-adding a new</span></span><br><span class="line"><span class="comment"> * element, which is more costly.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The function returns the updated element skiplist node pointer. */</span></span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslUpdateScore</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> curscore, sds ele, <span class="keyword">double</span> newscore)</span> </span>&#123;</span><br><span class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We need to seek to element to update to start: this is useful anyway,</span></span><br><span class="line"><span class="comment">     * we&#x27;ll have to update or remove it. */</span></span><br><span class="line">    x = zsl-&gt;header;</span><br><span class="line">    <span class="keyword">for</span> (i = zsl-&gt;level - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</span><br><span class="line">               (x-&gt;level[i].forward-&gt;score &lt; curscore ||</span><br><span class="line">                (x-&gt;level[i].forward-&gt;score == curscore &amp;&amp;</span><br><span class="line">                 <span class="built_in">sdscmp</span>(x-&gt;level[i].forward-&gt;ele, ele) &lt; <span class="number">0</span>))) &#123;</span><br><span class="line">            x = x-&gt;level[i].forward;</span><br><span class="line">        &#125;</span><br><span class="line">        update[i] = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Jump to our element: note that this function assumes that the</span></span><br><span class="line"><span class="comment">     * element with the matching score exists. */</span></span><br><span class="line">    x = x-&gt;level[<span class="number">0</span>].forward;</span><br><span class="line">    <span class="built_in">serverAssert</span>(x &amp;&amp; curscore == x-&gt;score &amp;&amp; <span class="built_in">sdscmp</span>(x-&gt;ele, ele) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the node, after the score update, would be still exactly</span></span><br><span class="line"><span class="comment">     * at the same position, we can just update the score without</span></span><br><span class="line"><span class="comment">     * actually removing and re-inserting the element in the skiplist. */</span></span><br><span class="line">    <span class="keyword">if</span> ((x-&gt;backward == <span class="literal">NULL</span> || x-&gt;backward-&gt;score &lt; newscore) &amp;&amp;</span><br><span class="line">        (x-&gt;level[<span class="number">0</span>].forward == <span class="literal">NULL</span> || x-&gt;level[<span class="number">0</span>].forward-&gt;score &gt; newscore)) &#123;</span><br><span class="line">        x-&gt;score = newscore;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* No way to reuse the old node: we need to remove and insert a new</span></span><br><span class="line"><span class="comment">     * one at a different place. */</span></span><br><span class="line">    <span class="built_in">zslDeleteNode</span>(zsl, x, update);</span><br><span class="line">    zskiplistNode *newnode = <span class="built_in">zslInsert</span>(zsl, newscore, x-&gt;ele);</span><br><span class="line">    <span class="comment">/* We reused the old node x-&gt;ele SDS string, free the node now</span></span><br><span class="line"><span class="comment">     * since zslInsert created a new one. */</span></span><br><span class="line">    x-&gt;ele = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">zslFreeNode</span>(x);</span><br><span class="line">    <span class="keyword">return</span> newnode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<pre><code>æ›´æ–°èŠ‚ç‚¹scoreæ—¶, å› ä¸ºscoreæ›´æ–°ä¹‹å, ä¸ºäº†ä¿è¯é¡ºåºæ€§, éœ€è¦å¯¹åˆ—è¿›è¡Œè°ƒæ•´, ä¸å¦‚ç›´æ¥åˆ é™¤èŠ‚ç‚¹, 
ç„¶ååœ¨åˆé€‚ä½ç½®æ·»åŠ æ–°çš„åˆ—
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/05/Redis%E6%BA%90%E7%A0%81-%E5%AD%97%E5%85%B8dict/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/default.png">
      <meta itemprop="name" content="zinego">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zinego's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/03/05/Redis%E6%BA%90%E7%A0%81-%E5%AD%97%E5%85%B8dict/" class="post-title-link" itemprop="url">Redisæºç -å­—å…¸dict</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-03-05 11:56:29" itemprop="dateCreated datePublished" datetime="2019-03-05T11:56:29+08:00">2019-03-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-10-31 13:59:30" itemprop="dateModified" datetime="2021-10-31T13:59:30+08:00">2021-10-31</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>5.1k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>4 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="å­—å…¸-å“ˆå¸Œè¡¨"><a href="#å­—å…¸-å“ˆå¸Œè¡¨" class="headerlink" title="å­—å…¸/å“ˆå¸Œè¡¨"></a>å­—å…¸/å“ˆå¸Œè¡¨</h2><h3 id="1-å†…å­˜å¸ƒå±€"><a href="#1-å†…å­˜å¸ƒå±€" class="headerlink" title="1. å†…å­˜å¸ƒå±€"></a>1. å†…å­˜å¸ƒå±€</h3><p><img src="/image/dict.png" alt="Alt text"></p>
<p><strong>è¯¥å›¾æ–°æ ‡ç­¾é¡µæ‰“å¼€çœ‹</strong></p>
<h4 id="1-1-dict"><a href="#1-1-dict" class="headerlink" title="1.1 dict"></a>1.1 dict</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dict</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></span><br><span class="line">    dictType *type;          <span class="comment">// type</span></span><br><span class="line">    <span class="keyword">void</span> *privdata;          <span class="comment">// paivate data</span></span><br><span class="line">    dictht ht[<span class="number">2</span>];            <span class="comment">// hash table</span></span><br><span class="line">    <span class="keyword">long</span> rehashidx;          <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> iterators; <span class="comment">/* number of iterators currently running */</span></span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure>

<pre><code>å…¶ä¸­typeæŒ‡å‘dictType, ä»£è¡¨ç€ä¸åŒç±»å‹çš„è¯å…¸. 
privdata ç§æœ‰æ•°æ®, ä½†æ˜¯æˆ‘æš‚æ—¶æ²¡æ˜ç™½æ˜¯ä»€ä¹ˆæ„æ€.
æ¯ä¸ªè¯å…¸æœ‰ä¸¤ä¸ªhashè¡¨, ä¸€ä¸ªç”¨äºæ­£å¸¸ä½¿ç”¨, ä¸€ä¸ªç”¨äºrehash
rehashidxå¯¹åº”rehashæ—¶åŸhashè¡¨çš„rehashçš„ä¸‹æ ‡, éšç€rehashçš„è¿›è¡Œ, rehashidxç§»åŠ¨
iteratorså¯¹åº”è¿­ä»£å™¨
</code></pre>
<h4 id="1-2-dictht"><a href="#1-2-dictht" class="headerlink" title="1.2 dictht"></a>1.2 dictht</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hash table </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span> &#123;</span></span><br><span class="line">    dictEntry **table;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> used;</span><br><span class="line">&#125; dictht;</span><br></pre></td></tr></table></figure>

<pre><code>æ¯ä¸ªhashè¡¨åŒ…å«ä¸€ä¸ªæ•°ç»„, æ¯ä¸ªæ•°ç»„çš„å…ƒç´ æŒ‡å‘ä¸€ä¸ªé“¾è¡¨, hash çš„æ—¶å€™, å°†key hashæˆi,
é‚£ä¹ˆè¯¥å…ƒç´ å°±ä¼šè¢«æ·»åŠ åˆ°ht[0][i]åé¢.
sizeæŒ‡çš„æ˜¯hashè¡¨ä¸­æ•°ç»„å…ƒç´ çš„ä¸ªæ•°
sizemask=size-1 , å› ä¸ºå…ƒç´ çš„ä¸‹æ ‡æ˜¯ä»0~size-1çš„
usedä»£è¡¨å·²ç»å ç”¨çš„æ¡¶çš„ä¸ªæ•°(æ¡¶=æ•°ç»„å…ƒç´ , æ•°ç»„å…ƒç´ å¯ä»¥çœ‹æˆæ˜¯æ¡¶çš„å…¥å£)
</code></pre>
<h4 id="1-3-dictType"><a href="#1-3-dictType" class="headerlink" title="1.3 dictType"></a>1.3 dictType</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hashè¡¨çš„ç±»å‹, å¯¹äºä¸åŒçš„ç±»å‹, å®ç°çš„æ–¹æ³•ä¸åŒ </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictType</span> &#123;</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * this is a pointer named &#x27;keyDup&#x27;, it point to a function,</span></span><br><span class="line"><span class="comment">     * and that function&#x27;s return type is void*, parameters are two pointers */</span></span><br><span class="line">    <span class="built_in">uint64_t</span> (*hashFunction)(<span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj);</span><br><span class="line">    <span class="built_in"><span class="keyword">int</span></span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);</span><br><span class="line">    <span class="built_in"><span class="keyword">void</span></span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="built_in"><span class="keyword">void</span></span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj);</span><br><span class="line">&#125; dictType;</span><br></pre></td></tr></table></figure>

<pre><code>hashè¡¨çš„ç±»å‹, 
å…¶ä¸­`uint64_t (*hashFunction)(const void *key);`ç±»ä¼¼äºè¿™ç§ç»“æ„, ä»£è¡¨ç€: 
hashFunctionæ˜¯ä¸€ä¸ªæŒ‡é’ˆ, æŒ‡å‘ä¸€ä¸ªå‡½æ•°, è¯¥å‡½æ•°ä»¥uint64_tç±»å‹ä¸ºè¿”å›å€¼, å‚æ•°æ˜¯`const void *key`
</code></pre>
<h4 id="1-4-dictEntry"><a href="#1-4-dictEntry" class="headerlink" title="1.4 dictEntry"></a>1.4 dictEntry</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hash è¡¨ä¸­å•ä¸ªç»“æ„</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *key;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="keyword">void</span> *val;     <span class="comment">//type val(string, struct)</span></span><br><span class="line">        <span class="keyword">uint64_t</span> u64;  <span class="comment">//type unsigned 64</span></span><br><span class="line">        <span class="keyword">int64_t</span> s64;   <span class="comment">//type signed 64</span></span><br><span class="line">        <span class="keyword">double</span> d;      <span class="comment">// type double</span></span><br><span class="line">    &#125; v;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; dictEntry;</span><br></pre></td></tr></table></figure>
<pre><code>ä¸€ä¸ªhashå…ƒç´ 
key = key
v æ˜¯unionç±»å‹, å¯ä»¥å®¹çº³å„ç§ç±»å‹çš„å€¼
nextå¦‚ä¸Šå›¾
</code></pre>
<h3 id="2-hash"><a href="#2-hash" class="headerlink" title="2. hash"></a>2. hash</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * d -&gt; å­—å…¸</span></span><br><span class="line"><span class="comment"> * key -&gt; é”®</span></span><br><span class="line"><span class="comment"> * hash -&gt; è¢«hashçš„key</span></span><br><span class="line"><span class="comment"> * existing -&gt; è¿”å›å­˜åœ¨çš„entry</span></span><br><span class="line"><span class="comment"> * å¦‚æœå·²ç»å­˜åœ¨, è¿”å›-1 </span></span><br><span class="line"><span class="comment"> * å¦‚æœä¸å­˜åœ¨, è¿”å›å¯ä»¥è¢«hashçš„ä¸€ä¸ªæ¡¶çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">long</span> _dictKeyIndex(dict *d, <span class="keyword">const</span> <span class="keyword">void</span> *key, <span class="keyword">uint64_t</span> hash, dictEntry **existing) &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> idx, table;</span><br><span class="line">    dictEntry *he;</span><br><span class="line">    <span class="keyword">if</span> (existing) *existing = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Expand the hash table if needed */</span></span><br><span class="line">    <span class="keyword">if</span> (_dictExpandIfNeeded(d) == DICT_ERR)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (table = <span class="number">0</span>; table &lt;= <span class="number">1</span>; table++) &#123;</span><br><span class="line">        idx = hash &amp; d-&gt;ht[table].sizemask;</span><br><span class="line">        <span class="comment">/* Search if this slot does not already contain the given key */</span></span><br><span class="line">        he = d-&gt;ht[table].table[idx];</span><br><span class="line">        <span class="keyword">while</span> (he) &#123;</span><br><span class="line">            <span class="keyword">if</span> (key == he-&gt;key || <span class="built_in">dictCompareKeys</span>(d, key, he-&gt;key)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (existing) *existing = he;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            he = he-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å¦‚æœæ²¡æœ‰æ­£åœ¨è¢«rehash, é‚£ä¹ˆç›´æ¥é€€å‡º, æ­¤æ—¶æ‰¾åˆ°äº†ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„idx,</span></span><br><span class="line"><span class="comment">         * å¦‚æœæ­£åœ¨è¢«rehash, é‚£ä¹ˆåˆ°ht[1]ä¸­å¯»æ‰¾, æ‰¾ä¸åˆ°çš„è¯, è¿”å›ä¸€ä¸ªht[1]ä¸­å¯ä»¥ä½¿ç”¨çš„idx,</span></span><br><span class="line"><span class="comment">         * ä¿è¯äº†ä¸ä¼šæ–°å¢çš„æ•°æ®ä¸ä¼šè¢«hashåˆ°ht[0]ä¸­</span></span><br><span class="line"><span class="comment">         **/</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">dictIsRehashing</span>(d)) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> idx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¦‚æœkeyå·²ç»å­˜åœ¨, è¿”å›NULL, è€Œä¸”å¦‚æœexistingéç©º, å®ƒä¼šè¢«å¡«å……ä¸ºå·²ç»å­˜åœ¨çš„entry, </span></span><br><span class="line"><span class="comment"> * å¦‚æœkeyè¢«æ·»åŠ , è¿”å›è¢«æ·»åŠ çš„hash entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">dictEntry *<span class="title">dictAddRaw</span><span class="params">(dict *d, <span class="keyword">void</span> *key, dictEntry **existing)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> index;</span><br><span class="line">    dictEntry *entry;</span><br><span class="line">    dictht *ht;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">dictIsRehashing</span>(d)) _dictRehashStep(d);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Get the index of the new element, or -1 if</span></span><br><span class="line"><span class="comment">     * the element already exists. */</span></span><br><span class="line">    <span class="keyword">if</span> ((index = _dictKeyIndex(d, key, <span class="built_in">dictHashKey</span>(d, key), existing)) == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate the memory and store the new entry.</span></span><br><span class="line"><span class="comment">     * Insert the element in top, with the assumption that in a database</span></span><br><span class="line"><span class="comment">     * system it is more likely that recently added entries are accessed</span></span><br><span class="line"><span class="comment">     * more frequently. */</span></span><br><span class="line">    ht = <span class="built_in">dictIsRehashing</span>(d) ? &amp;d-&gt;ht[<span class="number">1</span>] : &amp;d-&gt;ht[<span class="number">0</span>];</span><br><span class="line">    entry = <span class="built_in">zmalloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(*entry));</span><br><span class="line">    entry-&gt;next = ht-&gt;table[index];</span><br><span class="line">    ht-&gt;table[index] = entry;</span><br><span class="line">    ht-&gt;used++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the hash entry fields. */</span></span><br><span class="line">    <span class="built_in">dictSetKey</span>(d, entry, key);</span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<pre><code>å…³äºhash , ä¸åŒç±»å‹è°ƒç”¨çš„æ˜¯ä¸åŒçš„hashæ–¹æ³•(è§dictType)
å­—ç¬¦ä¸²ç±»å‹, è°ƒç”¨çš„æ˜¯siphash, å…³äºè¿™ç§hashæ–¹æ³•, æˆ‘ä¹Ÿæ²¡çœ‹æ‡‚... 
å…³äºå­˜å‚¨, ä¸€ä¸ªkeyè¢«hashæˆintç±»å‹çš„å€¼h,
h&amp;sizemaskè·å¾—ä¸€ä¸ªå¯ä»¥å­˜å‚¨åœ¨hashtableä¸­çš„ä¸€ä¸ªæ¡¶çš„ä¸‹æ ‡.
ç„¶åå¼€è¾Ÿç©ºé—´, èµ‹å€¼, å°†entryæ·»åŠ åˆ°æ¡¶çš„èµ·å§‹ä½ç½®
</code></pre>
<h3 id="3-rehash"><a href="#3-rehash" class="headerlink" title="3. rehash"></a>3. rehash</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictRehash</span><span class="params">(dict *d, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> empty_visits = n * <span class="number">10</span>; <span class="comment">/* Max number of empty buckets to visit. */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">dictIsRehashing</span>(d)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (n-- &amp;&amp; d-&gt;ht[<span class="number">0</span>].used != <span class="number">0</span>) &#123;</span><br><span class="line">        dictEntry *de, *nextde;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Note that rehashidx can&#x27;t overflow as we are sure there are more</span></span><br><span class="line"><span class="comment">         * elements because ht[0].used != 0 */</span></span><br><span class="line">        <span class="built_in">assert</span>(d-&gt;ht[<span class="number">0</span>].size &gt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>)d-&gt;rehashidx);</span><br><span class="line">        <span class="keyword">while</span> (d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            d-&gt;rehashidx++;</span><br><span class="line">            <span class="keyword">if</span> (--empty_visits == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        de = d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx];</span><br><span class="line">        <span class="comment">/* Move all the keys in this bucket from the old to the new hash HT */</span></span><br><span class="line">        <span class="keyword">while</span> (de) &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> h;</span><br><span class="line"></span><br><span class="line">            nextde = de-&gt;next;</span><br><span class="line">            <span class="comment">/* Get the index in the new hash table */</span></span><br><span class="line">            h = <span class="built_in">dictHashKey</span>(d, de-&gt;key) &amp; d-&gt;ht[<span class="number">1</span>].sizemask;</span><br><span class="line">            de-&gt;next = d-&gt;ht[<span class="number">1</span>].table[h];</span><br><span class="line">            d-&gt;ht[<span class="number">1</span>].table[h] = de;</span><br><span class="line">            d-&gt;ht[<span class="number">0</span>].used--;</span><br><span class="line">            d-&gt;ht[<span class="number">1</span>].used++;</span><br><span class="line">            de = nextde;</span><br><span class="line">        &#125;</span><br><span class="line">        d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx] = <span class="literal">NULL</span>;</span><br><span class="line">        d-&gt;rehashidx++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if we already rehashed the whole table... */</span></span><br><span class="line">    <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].used == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">zfree</span>(d-&gt;ht[<span class="number">0</span>].table);</span><br><span class="line">        d-&gt;ht[<span class="number">0</span>] = d-&gt;ht[<span class="number">1</span>];</span><br><span class="line">        _dictReset(&amp;d-&gt;ht[<span class="number">1</span>]);</span><br><span class="line">        d-&gt;rehashidx = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* More to rehash... */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>







<pre><code>å½“hashè¡¨ç©ºé—´è¿›è¡Œresize/expandæ—¶, éœ€è¦rehash, rehashçš„è¿‡ç¨‹å¦‚ä¸‹: 
1.  å°†ht[1]æŒ‡å‘æ–°å¼€è¾Ÿçš„ç©ºé—´
2.  å°†ht[0]è¿ç§»åˆ°ht[1]ä¸­, è¿ç§»å‰å, åŒä¸€ä¸ªå…ƒç´ è·å¾—çš„æ¡¶çš„ä¸‹æ ‡å¯èƒ½å˜åŒ–(å› ä¸ºsizemaskçš„å˜åŒ–)
3.  rehashæ˜¯ä¸€æ¡¶ä¸€æ¡¶çš„è¿ç§»çš„, ä¼´éšç€rehashidxçš„å¢åŠ , ä¿è¯ht[0]ä¸­å°äºrehashidxçš„æ¡¶ä¸­æ— å…ƒç´ 
4.  å¯¹äºrehashè¿‡ç¨‹ä¸­æ–°å¢çš„å…ƒç´ , å¦‚æœht[0]ä¸­å·²ç»å­˜åœ¨è¯¥key, é‚£ä¹ˆå°±è¿”å›, å¦‚æœä¸å­˜åœ¨,
    é‚£ä¹ˆå°±åœ¨ht[1]ä¸­æ–°å¢è¯¥key,è¯¦æƒ…è§dictAddRawå’Œ_dictKeyIndexæ–¹æ³•
5.  rehashè¿‡ç¨‹å‘ç”Ÿåœ¨å¯¹dictè¿›è¡Œå¢åˆ æ”¹æŸ¥æ—¶, æ¯æ¬¡æ‰§è¡Œ_dictRehashStepä¸€æ¬¡,
    æ—¢ä¿è¯äº†rehashè¿‡ç¨‹çš„è¿›è¡Œ, åˆå°†è€—æ—¶æ¯”è¾ƒé•¿çš„æ•´ä¸ªrehashè¿‡ç¨‹å‡åˆ†åˆ°æ¯æ¬¡æ“ä½œä¸­
6.  rehashè¿‡ç¨‹æ‰§è¡Œå®Œæˆä¹‹å, ht[0]è¢«é‡Šæ”¾, ç„¶åht[0]æŒ‡å‘ht[1], ht[1]æŒ‡å‘ç©º,
    rehashidxè¢«ç½®ä¸ºé›¶, rehashç»“æŸ, ht[0]åˆæˆä¸ºå”¯ä¸€ä½¿ç”¨ä¸­çš„hashè¡¨
</code></pre>
<h3 id="4-å­—å…¸çš„éå†"><a href="#4-å­—å…¸çš„éå†" class="headerlink" title="4. å­—å…¸çš„éå†"></a>4. å­—å…¸çš„éå†</h3><p>è¯¦æƒ…è§<a target="_blank" rel="noopener" href="https://blog.csdn.net/gqtcgq/article/details/50533336">Redisæºç è§£æï¼š04å­—å…¸çš„éå†dictScan</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/28/Redis%E6%BA%90%E7%A0%81-%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2sds/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/default.png">
      <meta itemprop="name" content="zinego">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zinego's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/02/28/Redis%E6%BA%90%E7%A0%81-%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2sds/" class="post-title-link" itemprop="url">Redisæºç -åŠ¨æ€å­—ç¬¦ä¸²sds</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-02-28 18:41:08" itemprop="dateCreated datePublished" datetime="2019-02-28T18:41:08+08:00">2019-02-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-10-31 13:59:30" itemprop="dateModified" datetime="2021-10-31T13:59:30+08:00">2021-10-31</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>4.3k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>4 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="åŠ¨æ€å­—ç¬¦ä¸²sds"><a href="#åŠ¨æ€å­—ç¬¦ä¸²sds" class="headerlink" title="åŠ¨æ€å­—ç¬¦ä¸²sds"></a>åŠ¨æ€å­—ç¬¦ä¸²sds</h2><h3 id="å†…å­˜å¸ƒå±€"><a href="#å†…å­˜å¸ƒå±€" class="headerlink" title="å†…å­˜å¸ƒå±€"></a>å†…å­˜å¸ƒå±€</h3><p><img src="/image/sds.png" alt="Alt text"></p>
<h3 id="sdså¤´ç»“æ„"><a href="#sdså¤´ç»“æ„" class="headerlink" title="sdså¤´ç»“æ„"></a>sdså¤´ç»“æ„</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span> *sds;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Note: sdshdr5 is never used, we just access the flags byte directly.</span></span><br><span class="line"><span class="comment"> * However is here to document the layout of type 5 SDS strings. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) <span class="title">sdshdr5</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, and 5 msb of string length */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) <span class="title">sdshdr8</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> len;         <span class="comment">/* used */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> alloc;       <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) <span class="title">sdshdr16</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> len;        <span class="comment">/* used */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> alloc;      <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) <span class="title">sdshdr32</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> len;        <span class="comment">/* used */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> alloc;      <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) <span class="title">sdshdr64</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> len;        <span class="comment">/* used */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> alloc;      <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<pre><code>sdshdræ˜¯å­˜å‚¨sdså­—ç¬¦ä¸²çš„ä¿¡æ¯
å…¶ä¸­lenä¸ºå­—ç¬¦ä¸²çš„é•¿åº¦, 
allocå­˜å‚¨çš„æ˜¯bufæŒ‡é’ˆåˆ†é…ç©ºé—´çš„å¤§å°, 
flagsè¡¨ç¤ºå­—ç¬¦ä¸²çš„ç±»å‹,5,8,16,32,64 
å…¶ä¸­sdshdr5ä¸ä½¿ç”¨
</code></pre>
<hr>
<pre><code>__attribute__æœºåˆ¶: 
æ˜¯gnuçš„ä¸€å¤§ç‰¹è‰², å¯ä»¥è®¾ç½®å‡½æ•°å±æ€§, å˜é‡å±æ€§å’Œç±»å‹å±æ€§
å…¶ä½ç½®çº¦æŸä¸€èˆ¬æ”¾åœ¨å£°æ˜çš„å°¾éƒ¨`;`ä¹‹å‰
packedé€‰é¡¹ä»£è¡¨è¯¥ç»“æ„ä½¿ç”¨æœ€å°çš„å¯¹é½æ–¹å¼
</code></pre>
<hr>
<pre><code>lenä¸ºå·²ä½¿ç”¨çš„å­—ç¬¦ä¸²çš„é•¿åº¦
allocæ˜¯åˆ†é…çš„æ€»ç©ºé—´çš„é•¿åº¦(ä¸åŒ…æ‹¬header)
flagsæ˜¯ç±»å‹, flagsçš„å€¼ä¸º0,1,2,3,4 , åˆ†åˆ«å¯¹åº”sdshdr5, sdshdr8, sdshdr16, sdshdr32, sdshdr64
bufæ˜¯å­—ç¬¦ä¸²æŒ‡é’ˆèµ·ç‚¹, ä½¿ç”¨ç©ºæ•°ç»„, ä¸å ç”¨ç»“æ„ä½“ç©ºé—´, ä»£è¡¨headeræœ«å°¾, å­—ç¬¦ä¸²èµ·ç‚¹
</code></pre>
<h3 id="headerçš„éƒ¨åˆ†å®"><a href="#headerçš„éƒ¨åˆ†å®" class="headerlink" title="headerçš„éƒ¨åˆ†å®"></a>headerçš„éƒ¨åˆ†å®</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDS_HDR_VAR(T, s) struct sdshdr##T *sh = (void *)((s) - (sizeof(struct sdshdr##T)));</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDS_HDR(T, s) ((struct sdshdr##T *)((s) - (sizeof(struct sdshdr##T))))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDS_TYPE_5_LEN(f) ((f) &gt;&gt; SDS_TYPE_BITS)</span></span><br><span class="line"><span class="comment">/** è®¡ç®—é•¿åº¦, fæ˜¯flag, åªå­˜å‚¨ä¸‰ä½, ç§»åŠ¨ä¹‹åä¸º0, å› ä¸ºsdshdrä¸ä½¿ç”¨, ç›´æ¥è¿”å›0 **/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>SDS_HDR_VAR</strong></p>
<pre><code>å£°æ˜ä¸€ä¸ªsh, æŒ‡å‘sçš„å¤´èµ·å§‹åœ°å€
## å°†ä¸¤ä¸ªå®å‚æ•°æ‹¼æ¥
æ¯”å¦‚, å¦‚æœè°ƒç”¨SDS_HDR_VAR(8,s)
é‚£ä¹ˆè°ƒç”¨å®çš„ç»“æœæ˜¯:  
struct sdshdr8 *sh = (void *)((s) - (sizeof(struct sdshdr8)));
this is amazing!!! 
è¯¥å®çš„ä½œç”¨æ˜¯è®¡ç®—sdsèµ·å§‹åœ°å€
</code></pre>
<hr>
<p><strong>SDS_HDR</strong></p>
<pre><code>ç›´æ¥è¿”å›ä¸€ä¸ªsh, æŒ‡å‘sçš„å¤´èµ·å§‹åœ°å€
</code></pre>
<hr>
<p><strong>SDS_TYPE_5_LEN</strong></p>
<pre><code>è®¡ç®—é•¿åº¦, fæ˜¯flag, åªå­˜å‚¨ä¸‰ä½, ç§»åŠ¨ä¹‹åä¸º0, å› ä¸ºsdshdr5ä¸ä½¿ç”¨, ç›´æ¥è¿”å›0
</code></pre>
<h3 id="headerçš„éƒ¨åˆ†å‡½æ•°"><a href="#headerçš„éƒ¨åˆ†å‡½æ•°" class="headerlink" title="headerçš„éƒ¨åˆ†å‡½æ•°"></a>headerçš„éƒ¨åˆ†å‡½æ•°</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">size_t</span> <span class="title">sdslen</span><span class="params">(<span class="keyword">const</span> sds s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags = s[<span class="number">-1</span>];</span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (flags &amp; SDS_TYPE_MASK) &#123;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_5:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">SDS_TYPE_5_LEN</span>(flags);</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_8:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">SDS_HDR</span>(<span class="number">8</span>, s)-&gt;len;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_16:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">SDS_HDR</span>(<span class="number">16</span>, s)-&gt;len;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_32:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">SDS_HDR</span>(<span class="number">32</span>, s)-&gt;len;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_64:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">SDS_HDR</span>(<span class="number">64</span>, s)-&gt;len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>è¿”å›sçš„å­—ç¬¦ä¸²é•¿åº¦
å…³äºs[-1]:
    1. sæŒ‡å‘çš„æ˜¯å­—ç¬¦ä¸²çš„ä½ç½®, åœ¨è¿™é‡Œå°±æ˜¯sdshdrä¸­bufçš„åœ°å€
    2. ç»“æ„ä½“ä¸­ç©ºæ•°ç»„ä¸å ç”¨å­˜å‚¨ç©ºé—´, æ•°ç»„æŒ‡å‘ä¸€ä¸ªåœ°å€, åœ¨è¿™é‡Œå°±æ˜¯sçš„èµ·å§‹åœ°å€.
    3. æ‰€ä»¥s=buf, s[-1]=flag
    4. s[-1]æ˜¯çœŸçš„éªšæ“ä½œ...
</code></pre>
<h3 id="sdsçš„å‡½æ•°æ€»ç»“"><a href="#sdsçš„å‡½æ•°æ€»ç»“" class="headerlink" title="sdsçš„å‡½æ•°æ€»ç»“"></a>sdsçš„å‡½æ•°æ€»ç»“</h3><h4 id="å¼€è¾Ÿ"><a href="#å¼€è¾Ÿ" class="headerlink" title="å¼€è¾Ÿ"></a>å¼€è¾Ÿ</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆå§‹åŒ–ä¸€ä¸ªsds, initä¸ºå­—ç¬¦ä¸²èµ·å§‹åœ°å€, initlenä¸ºé•¿åº¦</span></span><br><span class="line"><span class="function">sds <span class="title">sdsnewlen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *init, <span class="keyword">size_t</span> initlen)</span></span>; </span><br><span class="line"><span class="comment">//åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„sds</span></span><br><span class="line"><span class="function">sds <span class="title">sdsempty</span><span class="params">(<span class="keyword">void</span>)</span></span>; </span><br><span class="line"><span class="comment">//newä¸€ä¸ªsds, å­—ç¬¦ä¸²çš„å€¼ä¸ºinit</span></span><br><span class="line"><span class="function">sds <span class="title">sdsnew</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *init)</span></span>;</span><br><span class="line"><span class="comment">//å¤åˆ¶ä¸€ä¸ªsds</span></span><br><span class="line"><span class="function">sds <span class="title">sdsdup</span><span class="params">(<span class="keyword">const</span> sds s)</span> </span>;</span><br><span class="line"><span class="comment">//ä½¿sdsä¸­çš„free spaceèƒ½å®¹çº³addlené•¿åº¦çš„å­—ç¬¦ä¸². ä¸å¤Ÿå¼€è¾Ÿç©ºé—´, è¶³å¤Ÿä¸å¼€è¾Ÿ</span></span><br><span class="line"><span class="function">sds <span class="title">sdsMakeRoomFor</span><span class="params">(sds s, <span class="keyword">size_t</span> addlen)</span> </span>;</span><br></pre></td></tr></table></figure>



<h4 id="é‡Šæ”¾"><a href="#é‡Šæ”¾" class="headerlink" title="é‡Šæ”¾"></a>é‡Šæ”¾</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é‡Šæ”¾sdsç©ºé—´</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsfree</span><span class="params">(sds s)</span></span>;</span><br><span class="line"><span class="comment">//æ¸…é™¤æ‰æœ«å°¾çš„ç©ºé—²ç©ºé—´, ä»¥å…ç©ºé—´å ç”¨è¿‡å¤š</span></span><br><span class="line"><span class="function">sds <span class="title">sdsRemoveFreeSpace</span><span class="params">(sds s)</span></span>;</span><br><span class="line"><span class="comment">//æ¸…é™¤sdsä¸­çš„å­—ç¬¦ä¸², å³å°†stringéƒ¨åˆ†å˜æˆfree space</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsclear</span><span class="params">(sds s)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="æ›´æ–°-amp-è·å–header"><a href="#æ›´æ–°-amp-è·å–header" class="headerlink" title="æ›´æ–°&amp;è·å–header"></a>æ›´æ–°&amp;è·å–header</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é€šè¿‡ç±»å‹è·å¾—ç»“æ„ä½“å¤§å°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">sdsHdrSize</span><span class="params">(<span class="keyword">char</span> type)</span></span>; </span><br><span class="line"><span class="comment">//é€šè¿‡å­—ç¬¦ä¸²é•¿åº¦è·å¾—ç±»å‹</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">char</span> <span class="title">sdsReqType</span><span class="params">(<span class="keyword">size_t</span> string_size)</span></span>; </span><br><span class="line"><span class="comment">//æ›´æ–°sdsä¸­çš„lenå­—æ®µ, ä»…ä»…æ˜¯æ›´æ–°è¯¥å­—æ®µ. </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsupdatelen</span><span class="params">(sds s)</span></span>;</span><br><span class="line"><span class="comment">//è·å–åŒ…æ‹¬sdså¤´åœ¨å†…çš„å ç”¨ç©ºé—´æ€»é‡</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">sdsAllocSize</span><span class="params">(sds s)</span></span>;</span><br><span class="line"><span class="comment">//è·å–è·å¾—hdrçš„èµ·å§‹åœ°å€</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">sdsAllocPtr</span><span class="params">(sds s)</span> </span>;</span><br><span class="line"><span class="comment">//æ ¹æ®incr(å¯æ­£å¯è´Ÿ), è°ƒæ•´lenå¤§å°. æ›´æ–°lenå’Œç»“å°¾&#x27;\0&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsIncrLen</span><span class="params">(sds s, <span class="keyword">ssize_t</span> incr)</span> </span>;</span><br><span class="line"><span class="comment">//ä½¿å¾—sdsä¸­çš„stringå¢é•¿åˆ°lençš„é•¿åº¦, å¤šå‡ºçš„éƒ¨åˆ†é‡ç½®ä¸º0, å¦‚æœlenè¾ƒå°, ä¸æ“ä½œ</span></span><br><span class="line"><span class="function">sds <span class="title">sdsgrowzero</span><span class="params">(sds s, <span class="keyword">size_t</span> len)</span></span>;</span><br></pre></td></tr></table></figure>


<h4 id="æ‹¼æ¥"><a href="#æ‹¼æ¥" class="headerlink" title="æ‹¼æ¥"></a>æ‹¼æ¥</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdscatlen</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">void</span> *t, <span class="keyword">size_t</span> len)</span> </span>;</span><br><span class="line"><span class="function">sds <span class="title">sdscat</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *t)</span> </span>;</span><br><span class="line"><span class="function">sds <span class="title">sdscatsds</span><span class="params">(sds s, <span class="keyword">const</span> sds t)</span> </span>;</span><br><span class="line"><span class="comment">//è½¬ä¹‰æ‹¼æ¥</span></span><br><span class="line"><span class="function">sds <span class="title">sdscatrepr</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *p, <span class="keyword">size_t</span> len)</span> </span></span><br></pre></td></tr></table></figure>


<h4 id="æ‹·è´"><a href="#æ‹·è´" class="headerlink" title="æ‹·è´"></a>æ‹·è´</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdscpylen</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *t, <span class="keyword">size_t</span> len)</span> </span>;</span><br><span class="line"><span class="function">sds <span class="title">sdscpy</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *t)</span> </span>;</span><br></pre></td></tr></table></figure>



<h4 id="æ•´å‹è½¬sds"><a href="#æ•´å‹è½¬sds" class="headerlink" title="æ•´å‹è½¬sds"></a>æ•´å‹è½¬sds</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sdsll2str</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">long</span> <span class="keyword">long</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sdsull2str</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> v)</span></span>;</span><br><span class="line"><span class="function">sds <span class="title">sdsfromlonglong</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> value)</span> </span>;</span><br></pre></td></tr></table></figure>


<h4 id="æ ¼å¼åŒ–è¾“å‡º"><a href="#æ ¼å¼åŒ–è¾“å‡º" class="headerlink" title="æ ¼å¼åŒ–è¾“å‡º"></a>æ ¼å¼åŒ–è¾“å‡º</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdscatvprintf</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, va_list ap)</span> </span>;</span><br><span class="line"><span class="function">sds <span class="title">sdscatprintf</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>;</span><br><span class="line"><span class="comment">// ç±»ä¼¼äºsdscatprintf, ä½†æ˜¯æ¯”sdscatprintfå¿«, åŠŸèƒ½ä»…é™äºä¸Šé¢çš„ç±»å‹</span></span><br><span class="line"><span class="function">sds <span class="title">sdscatfmt</span><span class="params">(sds s, <span class="keyword">char</span> <span class="keyword">const</span> *fmt, ...)</span> </span>;</span><br></pre></td></tr></table></figure>



<h4 id="å­—ç¬¦ä¸²å¸¸ç”¨æ“ä½œ"><a href="#å­—ç¬¦ä¸²å¸¸ç”¨æ“ä½œ" class="headerlink" title="å­—ç¬¦ä¸²å¸¸ç”¨æ“ä½œ"></a>å­—ç¬¦ä¸²å¸¸ç”¨æ“ä½œ</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdstrim</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *cset)</span> </span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsrange</span><span class="params">(sds s, <span class="keyword">ssize_t</span> start, <span class="keyword">ssize_t</span> end)</span> </span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdstolower</span><span class="params">(sds s)</span> </span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdstoupper</span><span class="params">(sds s)</span> </span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sdscmp</span><span class="params">(<span class="keyword">const</span> sds s1, <span class="keyword">const</span> sds s2)</span> </span>;</span><br><span class="line"><span class="function">sds *<span class="title">sdssplitlen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">ssize_t</span> len, <span class="keyword">const</span> <span class="keyword">char</span> *sep, <span class="keyword">int</span> seplen, <span class="keyword">int</span> *count)</span> </span>;</span><br><span class="line"><span class="comment">//é‡Šæ”¾ç”±sdssplitlenå¼€è¾Ÿçš„ç©ºé—´</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsfreesplitres</span><span class="params">(sds *tokens, <span class="keyword">int</span> count)</span> </span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_hex_digit</span><span class="params">(<span class="keyword">char</span> c)</span> </span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hex_digit_to_int</span><span class="params">(<span class="keyword">char</span> c)</span> </span>;</span><br><span class="line"><span class="function">sds *<span class="title">sdssplitargs</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *line, <span class="keyword">int</span> *argc)</span> </span>;</span><br><span class="line"><span class="comment">// å°†å­—ç¬¦ä¸²ä¸­çš„formå­—ç¬¦æ›¿æ¢æˆto</span></span><br><span class="line"><span class="function">sds <span class="title">sdsmapchars</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *from, <span class="keyword">const</span> <span class="keyword">char</span> *to, <span class="keyword">size_t</span> setlen)</span> </span>;</span><br><span class="line"><span class="function">sds <span class="title">sdsjoin</span><span class="params">(<span class="keyword">char</span> **argv, <span class="keyword">int</span> argc, <span class="keyword">char</span> *sep)</span> </span>;</span><br><span class="line"><span class="function">sds <span class="title">sdsjoinsds</span><span class="params">(sds *argv, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> *sep, <span class="keyword">size_t</span> seplen)</span> </span>;</span><br></pre></td></tr></table></figure>


<pre><code>
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/28/C%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/default.png">
      <meta itemprop="name" content="zinego">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zinego's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/02/28/C%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-02-28 15:55:16" itemprop="dateCreated datePublished" datetime="2019-02-28T15:55:16+08:00">2019-02-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-10-31 13:59:30" itemprop="dateModified" datetime="2021-10-31T13:59:30+08:00">2021-10-31</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">Cè¯­è¨€</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>918</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>æœ¬æ–‡è½¬è½½è‡ª<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_3fe961ae0100nf1l.html">Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°</a></strong></p>
<h3 id="Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°"><a href="#Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°" class="headerlink" title="Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°"></a>Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°</h3><pre><code>Cè¯­è¨€ä¸­å¯å˜å‚æ•°åˆ—è¡¨æ˜¯é€šè¿‡å®æ¥å®ç°çš„ï¼Œè¿™äº›å®å®šä¹‰äºstdarg.hå¤´æ–‡ä»¶ï¼Œå®ƒæ˜¯æ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ã€‚
Cè¯­è¨€çš„å¯å˜å‚æ•°å‡½æ•°ä¸»è¦è¦ç”¨åˆ°äº†ä¸€ä¸ªç±»å‹va_listå’Œä¸‰ä¸ªå®â€”â€”va_startã€va_argå’Œva_endã€‚
Cè¯­è¨€çš„å¯å˜å‚æ•°å‡½æ•°å¿…é¡»ä»¥æŸç§æ–¹å¼æä¾›å‚æ•°çš„ä¸ªæ•°ã€‚

æˆ‘ä»¬å¯ä»¥å£°æ˜ä¸€ä¸ªç±»å‹ä¸ºva_listçš„å˜é‡ï¼Œä¸è¿™å‡ ä¸ªå®é…åˆä½¿ç”¨ï¼Œè®¿é—®å‚æ•°çš„å€¼ã€‚è¿™ä¸ªå˜é‡é€šè¿‡è°ƒç”¨va_startæ¥åˆå§‹åŒ–ã€‚
å®ƒçš„ç¬¬1ä¸ªå‚æ•°æ˜¯va_listå˜é‡çš„åå­—ï¼Œ
ç¬¬2ä¸ªå‚æ•°æ˜¯çœç•¥å·å‰æœ€åä¸€ä¸ªæœ‰åå­—çš„å‚æ•°ã€‚
åˆå§‹åŒ–è¿‡ç¨‹æŠŠvar_argå˜é‡è®¾ç½®ä¸ºæŒ‡å‘å¯å˜å‚æ•°éƒ¨åˆ†çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚
ä¸ºäº†è®¿é—®å‚æ•°ï¼Œéœ€è¦ä½¿ç”¨va_argï¼Œè¿™ä¸ªå®æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šva_listå˜é‡å’Œå‚æ•°åˆ—è¡¨ä¸­ä¸‹ä¸€ä¸ªå‚æ•°çš„ç±»å‹ã€‚
va_argè¿”å›è¿™ä¸ªå‚æ•°çš„å€¼ï¼Œå¹¶ä½¿var_argæŒ‡å‘ä¸‹ä¸€ä¸ªå¯å˜å‚æ•°ã€‚
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯å˜å‚æ•°å¿…é¡»ä»å¤´åˆ°å°¾æŒ‰ç…§é¡ºåºè®¿é—®ï¼Œä¸å¯ä»¥ä¸€å¼€å§‹å°±è®¿é—®å‚æ•°åˆ—è¡¨ä¸­é—´çš„å‚æ•°ã€‚
å½“è®¿é—®å®Œæ¯•æœ€åä¸€ä¸ªå¯å˜å‚æ•°ä¹‹åï¼Œéœ€è¦è°ƒç”¨va_endã€‚
ç»™ä¸€æ®µç¤ºä¾‹ä»£ç ï¼š
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="comment">//å‡½æ•°è‡³å°‘éœ€è¦ä¸€ä¸ªç¡®å®šçš„å‚æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">average</span><span class="params">(<span class="keyword">int</span> n_values,...)</span></span>&#123;</span><br><span class="line">    va_list var_arg;</span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    <span class="keyword">float</span> sum=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–ï¼Œå‡†å¤‡è®¿é—®å¯å˜å‚æ•°ï¼Œå®ƒçš„ç¬¬1ä¸ªå‚æ•°æ˜¯va_listå˜é‡çš„åå­—ï¼Œç¬¬2ä¸ªå‚æ•°æ˜¯çœç•¥å·å‰æœ€åä¸€ä¸ªæœ‰åå­—çš„å‚æ•°ã€‚</span></span><br><span class="line">    <span class="built_in">va_start</span>(var_arg,n_values);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å–å„ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="keyword">for</span>(count=<span class="number">0</span>;count&lt;n_values;count++)&#123;</span><br><span class="line">        sum+=<span class="built_in">va_arg</span>(var_arg,<span class="keyword">int</span>);        </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®Œæˆ</span></span><br><span class="line">    <span class="built_in">va_end</span>(var_arg);</span><br><span class="line">    <span class="keyword">return</span> sum/n_values; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%f\n&quot;</span>,<span class="built_in">average</span>(<span class="number">5</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">5</span>));</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/28/%E5%85%B3%E4%BA%8E__attribute__%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/default.png">
      <meta itemprop="name" content="zinego">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zinego's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/02/28/%E5%85%B3%E4%BA%8E__attribute__%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">å…³äº__attribute__æœºåˆ¶</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-02-28 15:26:12" itemprop="dateCreated datePublished" datetime="2019-02-28T15:26:12+08:00">2019-02-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-10-31 13:59:30" itemprop="dateModified" datetime="2021-10-31T13:59:30+08:00">2021-10-31</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">Cè¯­è¨€</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>3.5k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>3 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="attribute-æœºåˆ¶"><a href="#attribute-æœºåˆ¶" class="headerlink" title="__attribute__æœºåˆ¶"></a>__attribute__æœºåˆ¶</h2><p><strong>æœ¬æ–‡è½¬è½½è‡ª:<a target="_blank" rel="noopener" href="http://rungame.me/blog/2016/09/21/attribute-syntax/">GNU C ä¸­çš„__attribute__æœºåˆ¶</a></strong></p>
<pre><code>__attribute__ æ˜¯ GCC æä¾›çš„ä¸€ç§è¯­æ³•,å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨ç¼–è¯‘æ—¶å¯¹å£°æ˜çš„å‡½æ•°ã€å˜é‡å’Œç±»å‹åšä¸€äº›ç‰¹æ®Šå¤„ç†æˆ–è€…æ˜¯æ£€æŸ¥æ“ä½œã€‚

__attribute__ çš„è¯­æ³•æ ¼å¼ä¸º: __attribute__ ((attribute-list)) , 
attribute-list æ˜¯æŒ‡ä»¤é›† , __attribute__ å‡ºç°åœ¨å‡½æ•°ã€å˜é‡å’Œç±»å‹å£°æ˜çš„ â€œ;â€ å‰ã€‚

__attribute__ æœ‰ä¸‰ç±»,åˆ†åˆ«ä¸º
    1. å‡½æ•°å±æ€§(Function Attribute) 
    2. å˜é‡å±æ€§(Variable Attribute) 
    3. ç±»å‹å±æ€§(Type Attribute)
</code></pre>
<h3 id="ä¸€-å‡½æ•°å±æ€§"><a href="#ä¸€-å‡½æ•°å±æ€§" class="headerlink" title="ä¸€. å‡½æ•°å±æ€§"></a>ä¸€. å‡½æ•°å±æ€§</h3><h4 id="1-format-archetype-string-index-first-to-check"><a href="#1-format-archetype-string-index-first-to-check" class="headerlink" title="1. format (archetype, string-index, first-to-check)"></a>1. format (archetype, string-index, first-to-check)</h4><pre><code>format å±æ€§é€šè¿‡æŒ‡å®š printf, scanf, strftime æˆ– strfmon ç­‰æ–¹æ³•æ¥æ£€æµ‹å‡½æ•°çš„å‚æ•°æ˜¯å¦åŒæ ·é€‚ç”¨äºè¿™äº›æŒ‡å®šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ–¹æ³•
,å¦‚æœä¸é€‚ç”¨,ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶çš„å°±ä¼šå‘å‡ºè­¦å‘Š,ä»è€Œå‘ç°é”™è¯¯ã€‚
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">my_printf</span> <span class="params">(<span class="keyword">int</span> value, <span class="keyword">const</span> <span class="keyword">char</span> *my_format, ...)</span> __<span class="title">attribute__</span> <span class="params">((format (printf, <span class="number">2</span>, <span class="number">3</span>)))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">my_printf</span>(<span class="number">0</span>, <span class="string">&quot;age = %d\n&quot;</span>,<span class="number">17</span>);</span><br><span class="line">    <span class="built_in">my_printf</span>(<span class="number">0</span>, <span class="string">&quot;age = %d\n&quot;</span>,<span class="string">&quot;17&quot;</span>);</span><br><span class="line">    <span class="built_in">my_printf</span>(<span class="number">0</span>, <span class="string">&quot;age = %d name = %s\n&quot;</span>,<span class="number">17</span>,<span class="string">&quot;sbxfc&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>ä¸Šé¢ç¤ºä¾‹ä¸­, format å±æ€§çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šäº†ä¸€ä¸ª printf æ–¹æ³•,
ç¬¬äºŒä¸ªå‚æ•° string-index è¡¨ç¤ºå‡½æ•° my_printf é‡Œæ ¼å¼åŒ–å‚æ•°æ˜¯æ€»å‚æ•°çš„ç¬¬å‡ ä¸ª,è¿™é‡Œæˆ‘ä»¬çš„æ ¼å¼åŒ–å‚æ•° my_format æ˜¯ç¬¬2ä¸ªå‚æ•°,
format å±æ€§çš„ç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤º,å‚æ•°é›†åˆ (â€¦) ä»å‡½æ•° my_printf çš„ç¬¬å‡ ä¸ªå‚æ•°å¼€å§‹å‡ºç°ã€‚

å¦‚æ— æ„å¤–,ä¸Šè¿°ç¤ºä¾‹åœ¨ gcc ç¼–è¯‘æ—¶ä¼šæç¤ºä»¥ä¸‹è­¦å‘Šä¿¡æ¯:
å»æ‰__attribute__å±æ€§,è¯¥ç¤ºä¾‹åˆ™ä¸ä¼šæç¤ºé”™è¯¯,ä½†è¿è¡Œæ—¶ä¼šå‡ºé”™ã€‚
</code></pre>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -c main.c</span><br><span class="line">main.c:12:31: warning: format specifies <span class="built_in">type</span> <span class="string">&#x27;int&#x27;</span> but the argument has <span class="built_in">type</span></span><br><span class="line">  <span class="string">&#x27;char *&#x27;</span> [-Wformat]</span><br><span class="line">my_printf(0, <span class="string">&quot;age = %d\n&quot;</span>,<span class="string">&quot;17&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="2-noreturn"><a href="#2-noreturn" class="headerlink" title="2. noreturn"></a>2. noreturn</h4><pre><code>noreturn å±æ€§è¡¨ç¤ºå…¶æŒ‡å®šçš„å‡½æ•°æ²¡æœ‰è¿”å›å€¼,å½“ç¼–è¯‘å™¨æ‰§è¡Œåˆ°è¿™æ—¶,è¦é¢å¯¹ç°å®,ä¸è¦å¤§æƒŠå°æ€ª(~æ…Œå¿™æŠ¥é”™~)ã€‚
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="comment">/*__attribute__((noreturn))*/</span> <span class="built_in">onExit</span>();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onExit</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (state == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">onExit</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">test</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨gcc -c -Wall test.cç¼–è¯‘</span></span><br></pre></td></tr></table></figure>

<h4 id="3-deprecated"><a href="#3-deprecated" class="headerlink" title="3. deprecated"></a>3. deprecated</h4><pre><code>deprecated å±æ€§å¯ä»¥ç”¨æ¥æ ‡è¯†ä¸€ä¸ªé¢„è®¡å°†ä¼šè¢«å¼ƒç”¨çš„å‡½æ•°,å¦‚æœå¼€å‘è€…ä½¿ç”¨è¯¥å‡½æ•°,ç¼–è¯‘æ—¶å°±ä¼šå‘å‡ºè­¦å‘Š,
å¹¶æç¤ºå‡ºé”™çš„è¡Œæ•°ã€‚è­¦å‘Šä¿¡æ¯åªä¼šåœ¨å¼€å‘è€…è°ƒç”¨è¯¥å‡½æ•°æ—¶æ‰ä¼šæç¤º,
deprecated ä¹Ÿå¯ä»¥ç”¨äºå˜é‡å’Œç±»å‹ã€‚
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">old_fn</span> <span class="params">()</span> __<span class="title">attribute__</span> <span class="params">((deprecated))</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">old_fn</span> <span class="params">()</span></span>;</span><br><span class="line"><span class="built_in"><span class="keyword">int</span></span> (*fn_ptr)() = old_fn;</span><br></pre></td></tr></table></figure>

<pre><code>åœ¨ä¸Šé¢ç¤ºä¾‹ä¸­,åªä¼šåœ¨ç¬¬3è¡Œæå‡ºè­¦å‘Š:
</code></pre>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">main.c:7:19: warning: <span class="string">&#x27;old_fn&#x27;</span> is deprecated [-Wdeprecated-declarations]</span><br><span class="line">int (*fn_ptr)() = old_fn;</span><br><span class="line">                    ^</span><br><span class="line">main.c:6:5: note: <span class="string">&#x27;old_fn&#x27;</span> has been explicitly marked deprecated here</span><br><span class="line">int old_fn ();</span><br></pre></td></tr></table></figure>

<h4 id="4-constructor-amp-destructor"><a href="#4-constructor-amp-destructor" class="headerlink" title="4. constructor &amp; destructor"></a>4. constructor &amp; destructor</h4><pre><code>è®¾ç½® constructor å±æ€§å¯ä»¥ä½¿å‡½æ•°åœ¨ main æ–¹æ³•ä¹‹å‰æ‰§è¡Œ,è€Œè®¾ç½® destructor å¯ä»¥ä½¿å‡½æ•°åœ¨ main æ–¹æ³•ä¹‹åæ‰§è¡Œã€‚
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__((constructor)) <span class="function"><span class="keyword">void</span> <span class="title">before_func</span> <span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;before \n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((destructor)) <span class="function"><span class="keyword">void</span> <span class="title">after_func</span> <span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;after \n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;main func \n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>constructor ã€ destructor å‡½æ•°ä¹Ÿå¯ä»¥è®¾ç½®æ‰§è¡Œçš„ä¼˜å…ˆçº§:
__attribute__((constructor(PRIORITY)))
__attribute__((destructor(PRIORITY)))
</code></pre>
<h3 id="äºŒ-å˜é‡å±æ€§"><a href="#äºŒ-å˜é‡å±æ€§" class="headerlink" title="äºŒ. å˜é‡å±æ€§"></a>äºŒ. å˜é‡å±æ€§</h3><h4 id="1-aligned-alignment"><a href="#1-aligned-alignment" class="headerlink" title="1. aligned (alignment)"></a>1. aligned (alignment)</h4><pre><code>aligned å±æ€§è®©å…¶æŒ‡å®šçš„å˜é‡æˆ–ç»“æ„ä½“æˆå‘˜æŒ‰ alignment å­—èŠ‚å¤§å°å¯¹é½ã€‚
å¦‚æœå…¶ä¸­å¯¹é½é•¿åº¦æœ‰é•¿åº¦å¤§äº alignmentçš„,åˆ™æŒ‰ç…§æœ€å¤§å¯¹é½é•¿åº¦æ¥å¯¹é½ã€‚
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»“æ„ä½“çš„å¯¹é½å€¼ä¸º8</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span> a;</span><br><span class="line">  <span class="keyword">int</span> x[<span class="number">2</span>] __attribute__ ((<span class="built_in">aligned</span> (<span class="number">8</span>)));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> s0 = <span class="built_in"><span class="keyword">sizeof</span></span>(struct foo);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;s0 = %d\n&quot;</span>,s0);<span class="comment">//print s0 = 16</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-packed"><a href="#2-packed" class="headerlink" title="2. packed"></a>2. packed</h4><pre><code>packed å±æ€§ç”¨äºè®¾ç½®å˜é‡æˆ–ç»“æ„ä½“æˆå‘˜ä»¥æœ€å°çš„å¯¹é½æ–¹å¼å¯¹é½ã€‚
åœ¨ä¸‹é¢çš„ç»“æ„ä½“ä¸­,ç”±äº x å·²ç»ä½¿ç”¨ packed è¿›è¡Œå¯¹é½,æ‰€ä»¥æ­¤æ—¶ç»“æ„ä½“ä»¥ a çš„sizeæ¥å¯¹é½:
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span>&#123;</span></span><br><span class="line">  <span class="keyword">char</span> a;</span><br><span class="line">  <span class="keyword">int</span> x[<span class="number">2</span>] __attribute__ ((packed));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> s0 = <span class="built_in"><span class="keyword">sizeof</span></span>(struct foo);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;s0 = %d\n&quot;</span>,s0);<span class="comment">//print s0 = 9</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="ä¸‰-ç±»å‹å±æ€§"><a href="#ä¸‰-ç±»å‹å±æ€§" class="headerlink" title="ä¸‰. ç±»å‹å±æ€§"></a>ä¸‰. ç±»å‹å±æ€§</h3><h4 id="1-packed"><a href="#1-packed" class="headerlink" title="1. packed"></a>1. packed</h4><pre><code>å¦‚æœ packed å±æ€§ç”¨åœ¨ struct æˆ– union ä¸Š,è¡¨ç¤ºè¯¥ç»“æ„çš„æˆå‘˜å˜é‡æŒ‰ç…§ç´§å‡‘æ¨¡å¼å¯¹é½,
å³ä»¥å˜é‡çš„å®é™…å ç”¨å­—èŠ‚å¯¹é½,ä¸ç”¨ç¼–è¯‘å™¨è¿›è¡Œä¼˜åŒ–å¯¹é½ã€‚å¦‚æœç”¨åœ¨ enum ä¸Š,åˆ™è¡¨ç¤ºä½¿ç”¨æœ€å°çš„æ•´æ•°æ¥å­˜å‚¨æšä¸¾ç±»å‹ã€‚
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">my_unpacked_struct</span>&#123;</span></span><br><span class="line">  <span class="keyword">char</span> c;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">my_packed_struct</span> &#123;</span></span><br><span class="line">   <span class="keyword">char</span> c;</span><br><span class="line">   <span class="keyword">int</span>  i;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">my_unpacked_struct</span> <span class="title">s</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> s0 = <span class="built_in"><span class="keyword">sizeof</span></span>(struct my_unpacked_struct);</span><br><span class="line">  <span class="keyword">int</span> s1 = <span class="built_in"><span class="keyword">sizeof</span></span>(struct my_packed_struct);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;s0 = %d,s1 = %d\n&quot;</span>,s0,s1);<span class="comment">//print s0 = 8,s1 = 13</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/28/APUE-%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/default.png">
      <meta itemprop="name" content="zinego">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zinego's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/02/28/APUE-%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6/" class="post-title-link" itemprop="url">APUE é˜…è¯»ç¬”è®° ç¬¬å…«ç«  è¿›ç¨‹æ§åˆ¶</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-02-28 10:38:47" itemprop="dateCreated datePublished" datetime="2019-02-28T10:38:47+08:00">2019-02-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-10-31 13:59:30" itemprop="dateModified" datetime="2021-10-31T13:59:30+08:00">2021-10-31</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/APUE%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">APUEé˜…è¯»ç¬”è®°</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>8k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>7 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="APUE-ç¬¬å…«ç« -è¿›ç¨‹æ§åˆ¶"><a href="#APUE-ç¬¬å…«ç« -è¿›ç¨‹æ§åˆ¶" class="headerlink" title="APUE ç¬¬å…«ç«  è¿›ç¨‹æ§åˆ¶"></a>APUE ç¬¬å…«ç«  è¿›ç¨‹æ§åˆ¶</h2><h3 id="8-1-å¼•è¨€"><a href="#8-1-å¼•è¨€" class="headerlink" title="8.1 å¼•è¨€"></a>8.1 å¼•è¨€</h3><pre><code>æœ¬ç« å†…å®¹:
    1. åˆ›å»ºæ–°è¿›ç¨‹, æ‰§è¡Œç¨‹åºå’Œè¿›ç¨‹ç»ˆæ­¢
    2. è¯´æ˜è¿›ç¨‹å±æ€§çš„å„ç§ID-å®é™…,æœ‰æ•ˆå’Œä¿å­˜çš„ç”¨æˆ·IDå’Œç»„ID.
    3. å¦‚ä½•å—åˆ°è¿›ç¨‹æ§åˆ¶åŸè¯­çš„å½±å“
    4. è§£é‡Šå™¨æ–‡ä»¶å’Œsystemå‡½æ•°
</code></pre>
<h3 id="8-2-è¿›ç¨‹æ ‡è¯†"><a href="#8-2-è¿›ç¨‹æ ‡è¯†" class="headerlink" title="8.2 è¿›ç¨‹æ ‡è¯†"></a>8.2 è¿›ç¨‹æ ‡è¯†</h3><pre><code>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªéè´Ÿæ•´å‹è¡¨ç¤ºçš„å”¯ä¸€è¿›ç¨‹ID. 
ä½†åŒæ—¶ä¹Ÿæ˜¯å¯ä»¥æœç”¨çš„, å½“è¿›ç¨‹ç»ˆæ­¢å, å…¶è¿›ç¨‹IDå°±æˆä¸ºæœç”¨çš„å€™é€‰è€…, é‡‡ç”¨å»¶è¿Ÿå¤ç”¨ç®—æ³•
IDä¸º0 çš„è¿›ç¨‹é€šå¸¸æ˜¯è°ƒåº¦è¿›ç¨‹, è¢«ç§°ä¸ºäº¤æ¢è¿›ç¨‹
IDä¸º1 çš„è¿›ç¨‹é€šå¸¸æ˜¯initè¿›ç¨‹, åœ¨è‡ªä¸¾ç»“æŸæ—¶ç”±å†…æ ¸è°ƒç”¨, è´Ÿè´£å¯åŠ¨ä¸€ä¸ªUNIXç³»ç»Ÿ. æ˜¯ä¸€ä¸ªæ™®é€šç”¨æˆ·è¿›ç¨‹, ä½†æ˜¯ç”±è¶…çº§ç”¨æˆ·ç‰¹æƒè¿è¡Œ.ssh
åœ¨æŸäº›UNIXç³»ç»Ÿçš„è™šæ‹Ÿå­˜å‚¨å™¨å®ç°ä¸­, è¿›ç¨‹ID2æ˜¯é¡µå®ˆæŠ¤è¿›ç¨‹, æ­¤è¿›ç¨‹è´Ÿè´£æ”¯æŒè™šæ‹Ÿå­˜å‚¨å™¨ç³»ç»Ÿ.
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">getpid</span><span class="params">()</span></span>; <span class="comment">// è¿”å›è¿›ç¨‹ID</span></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">getppid</span><span class="params">()</span></span>; <span class="comment">// è¿”å›çˆ¶è¿›ç¨‹ID</span></span><br><span class="line"><span class="function"><span class="keyword">uid_t</span> <span class="title">getuid</span><span class="params">()</span></span>; <span class="comment">// è¿”å›è¿›ç¨‹çš„ç”¨æˆ·ID</span></span><br><span class="line"><span class="function"><span class="keyword">uid_t</span> <span class="title">geteuid</span><span class="params">()</span></span>;<span class="comment">// è¿”å›è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ·ID</span></span><br><span class="line"><span class="function"><span class="keyword">gid_t</span> <span class="title">getgid</span><span class="params">()</span></span>; <span class="comment">// è¿”å›è¿›ç¨‹çš„ç»„ID</span></span><br><span class="line"><span class="function"><span class="keyword">gid_t</span> <span class="title">getegid</span><span class="params">()</span></span>; <span class="comment">// è¿”å›è¿›ç¨‹çš„æœ‰æ•ˆç»„ID</span></span><br></pre></td></tr></table></figure>


<h3 id="8-3-å‡½æ•°fork"><a href="#8-3-å‡½æ•°fork" class="headerlink" title="8.3 å‡½æ•°fork"></a>8.3 å‡½æ•°fork</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">fork</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<pre><code>ç”±å‡½æ•°forkåˆ›å»ºçš„æ–°è¿›ç¨‹è¢«ç§°ä¸ºå­è¿›ç¨‹. forkå‡½æ•°è¢«è°ƒç”¨ä¸€æ¬¡, ä½†æ˜¯è¿”å›ä¸¤æ¬¡.
ä¸¤æ¬¡è¿”å›çš„åŒºåˆ«æ˜¯å­è¿›ç¨‹çš„è¿”å›å€¼æ˜¯0, è€Œçˆ¶è¿›ç¨‹çš„è¿”å›å€¼åˆ™æ˜¯å­è¿›ç¨‹çš„è¿›ç¨‹ID. 
å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹ç»§ç»­æ‰§è¡Œforkè°ƒç”¨ä¹‹åçš„æŒ‡ä»¤, å­è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹çš„å‰¯æœ¬. å…±äº«æ­£æ–‡æ®µ, ä½†æ˜¯å¹¶ä¸å…±äº«å †æ ˆå’Œæ•°æ®ç©ºé—´
</code></pre>
<p><strong>å†™æ—¶å¤åˆ¶</strong></p>
<pre><code>çˆ¶è¿›ç¨‹çš„æ•°æ®æ®µ, å †æ ˆç”±å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å…±äº«, ä½†æ­¤æ—¶å†…æ ¸å°†ä»–ä»¬çš„è®¿é—®æƒé™æ”¹ä¸ºåªè¯». å¦‚æœçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸­çš„ä»»ä¸€ä¸ªè¯•å›¾ä¿®æ”¹è¿™ä¸ªåŒºåŸŸ, åˆ™å†…æ ¸åªä¸ºä¿®æ”¹åŒºåŸŸçš„é‚£å—å†…å­˜åˆ¶ä½œä¸€ä¸ªå‰¯æœ¬. 
</code></pre>
<p><strong>æ–‡ä»¶å…±äº«</strong></p>
<pre><code>forkçš„ä¸€ä¸ªç‰¹å¾æ˜¯çˆ¶è¿›ç¨‹çš„æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦éƒ½è¢«å¤åˆ¶åˆ°å­è¿›ç¨‹ä¸­. å°±å¥½åƒæ‰§è¡Œäº†dupå‡½æ•°. 
é‡è¦çš„æ˜¯, å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å…±äº«åŒä¸€ä¸ªæ–‡ä»¶åç§»é‡. 
</code></pre>
<p><img src="/image/%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB.png" alt="Alt text"></p>
<p><strong>å…¶ä»–ç»§æ‰¿</strong></p>
<pre><code>1. å®é™…ç”¨æˆ·ID, å®é™…ç»„ID, æœ‰æ•ˆç”¨æˆ·ID, æœ‰æ•ˆç»„ID
2. é™„å±ç»„ID
3. è¿›ç¨‹ç»„ID
4. ä¼šè¯ID
5. æ§åˆ¶ç»ˆç«¯
6. è®¾ç½®ç”¨æˆ·IDæ ‡å¿—å’Œè®¾ç½®ç»„IDæ ‡å¿—
7. å½“å‰å·¥ä½œç›®å½•
8. æ ¹ç›®å½•
9. æ–‡ä»¶åˆ›å»ºå±è”½å­—
10. ä¿¡å·å±è”½å’Œå®‰æ’
11. å¯¹ä»»ä¸€æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦æ‰§è¡Œæ—¶å…³é—­æ ‡å¿—
12. ç¯å¢ƒ
13. è¿æ¥çš„å…±äº«å­˜å‚¨æ®µ
14. å­˜å‚¨æ˜ åƒ
15. èµ„æºé™åˆ¶
</code></pre>
<p><strong>å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹çš„åŒºåˆ«</strong></p>
<pre><code>1. forkè¿”å›å€¼ä¸åŒ
2. è¿›ç¨‹IDä¸åŒ, çˆ¶è¿›ç¨‹IDä¸åŒ
3. å­è¿›ç¨‹çš„tms_utime,tms_stime,tms_cutimeå’Œtms_ustimeçš„å€¼è¢«è®¾ç½®ä¸º0
4. å­è¿›ç¨‹ä¸ç»§æ‰¿çˆ¶è¿›ç¨‹è®¾ç½®çš„æ–‡ä»¶é”
5. å­è¿›ç¨‹çš„æœªå¤„ç†é—¹é’Ÿè¢«æ¸…é™¤
6. å­è¿›ç¨‹çš„æœªå¤„ç†ä¿¡å·é›†è¢«è®¾ç½®ä¸ºç©ºé›†
</code></pre>
<h3 id="8-4-å‡½æ•°vfork"><a href="#8-4-å‡½æ•°vfork" class="headerlink" title="8.4 å‡½æ•°vfork"></a>8.4 å‡½æ•°vfork</h3><pre><code>vforkå‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹, è€Œè¯¥æ–°è¿›ç¨‹çš„ç›®çš„æ˜¯execä¸€ä¸ªæ–°çš„ç¨‹åº. 
ä½†æ˜¯å¹¶ä¸å°†çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´å®Œå…¨å¤åˆ¶åˆ°å­è¿›ç¨‹ä¸­., ä½†æ˜¯åœ¨å­è¿›ç¨‹è°ƒç”¨ç”¨execæˆ–è€… exitä¹‹å‰,
åœ¨çˆ¶è¿›ç¨‹çš„ç©ºé—´ä¸­è¿è¡Œ. ä½†æ˜¯å¦‚æœä¿®æ”¹æ•°æ®, è¿›è¡Œå‡½æ•°è°ƒç”¨,
æˆ–è€…æ²¡æœ‰è°ƒç”¨execæˆ–è€…exitå°±è¿”å›å°±å¯èƒ½å¸¦æ¥æœªçŸ¥çš„ç»“æœ
vforkä¿è¯å­è¿›ç¨‹å…ˆè¿è¡Œ. è°ƒç”¨exitæˆ–è€…execä¹‹å, çˆ¶è¿›ç¨‹ æ‰å¯èƒ½è¢«è°ƒåº¦è¿è¡Œ.
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;apue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> globval = <span class="number">6</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> var;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    var = <span class="number">88</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;before vfork\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((pid = <span class="built_in">vfork</span>()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">err_sys</span>(<span class="string">&quot;vfork error&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        globval++;</span><br><span class="line">        var++;</span><br><span class="line">        _exit(<span class="number">0</span>);  <span class="comment">// æ­¤å¤„å¦‚æœè°ƒç”¨exit, ç»“æœæ˜¯ä¸ç¡®å®šçš„.å› ä¸ºä¾èµ–äºæ ‡å‡†IOåº“çš„å®ç°</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pid = %ld, glob = %d, var = %d\n&quot;</span>, (<span class="keyword">long</span>)<span class="built_in">getpid</span>(), globval, var);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="8-5-å‡½æ•°exit"><a href="#8-5-å‡½æ•°exit" class="headerlink" title="8.5 å‡½æ•°exit"></a>8.5 å‡½æ•°exit</h3><p><strong>æ­£å¸¸ç»ˆæ­¢</strong></p>
<pre><code>1. è°ƒç”¨return 0, ç›¸å½“äºè°ƒç”¨exit(0) 
2. è°ƒç”¨exit å‡½æ•°, å…¶æ“ä½œåŒ…æ‹¬è°ƒç”¨å„ç»ˆæ­¢å¤„ç†ç¨‹åº(atexit), å…³é—­æ‰€æœ‰æ ‡å‡†IOæµ.
3. è°ƒç”¨_exitæˆ–è€…_Exitå‡½æ•°, ç›®çš„æ˜¯ä¸ºè¿›ç¨‹æä¾›ä¸€ç§æ— éœ€è¿è¡Œç»ˆæ­¢å¤„ç†ç¨‹åºæˆ–ä¿¡å·å¤„ç†ç¨‹åºè€Œç»ˆæ­¢çš„æ–¹æ³•. åœ¨UNIXä¸­,_exitå’Œ_Exitæ˜¯åŒä¹‰çš„, å¹¶ä¸å†²æ´—æ ‡å‡†IOæµ
4. è¿›ç¨‹çš„æœ€åä¸€ä¸ªçº¿ç¨‹åœ¨å…¶å¯åŠ¨ä¾‹ç¨‹ä¸­æ‰§è¡Œreturnè¯­å¥, ä½†æ˜¯è¯¥çº¿ç¨‹çš„è¿”å›å€¼ä¸ä½œä¸ºè¿›ç¨‹çš„è¿”å›å€¼.
5. è¿›ç¨‹çš„æœ€åä¸€ä¸ªçº¿ç¨‹è°ƒç”¨pehread_exitå‡½æ•°, è¿™ç§æƒ…å†µä¸‹,è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€æ€»æ˜¯0. 
</code></pre>
<p><strong>å¼‚å¸¸ç»ˆæ­¢</strong></p>
<pre><code>1. è°ƒç”¨abort, äº§ç”ŸSIGABRTä¿¡å·, è¿™æ˜¯ä¸‹ä¸€ç§å¼‚å¸¸ç»ˆæ­¢çš„ä¸€ç§ç‰¹ä¾‹
2. æ¥æ”¶åˆ°ä¸€ä¸ªä¿¡å·. ä¿¡å·å¯ä»¥ç”±è¿›ç¨‹è‡ªèº«, å…¶ä»–è¿›ç¨‹æˆ–è€…å†…æ ¸äº§ç”Ÿ.
3. æœ€åä¸€ä¸ªçº¿ç¨‹å¯¹å–æ¶ˆè¯·æ±‚åšå‡ºå“åº”. é»˜è®¤æƒ…å†µä¸‹,å–æ¶ˆä»¥å»¶è¿Ÿæ–¹å¼å‘ç”Ÿ: ä¸€ä¸ªçº¿ç¨‹è¦æ±‚å–æ¶ˆå¦ä¸€ä¸ªçº¿ç¨‹, è‹¥å¹²æ—¶é—´å, ç›®æ ‡çº¿ç¨‹ç»ˆæ­¢.

ä¸ç®¡è¿›ç¨‹å¦‚ä½•ç»ˆæ­¢, éƒ½ä¼šæ‰§è¡Œå†…æ ¸ä¸­çš„åŒä¸€æ®µä»£ç , è¿™æ®µä»£ç ä¸ºç›¸åº”è¿›ç¨‹å…³é—­æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦. é‡Šæ”¾å®ƒæ‰€ä½¿ç”¨çš„å­˜å‚¨å™¨. 
</code></pre>
<p><strong>ç»ˆæ­¢é€šçŸ¥çˆ¶è¿›ç¨‹</strong></p>
<pre><code>å¯¹äºä¸‰ä¸ªç»ˆæ­¢å‡½æ•°, å°†å…¶é€€å‡ºçŠ¶æ€ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°. å¼‚å¸¸ç»ˆæ­¢æ—¶, å†…æ ¸äº§ç”Ÿä¸€ä¸ªæŒ‡ç¤ºå…¶å¼‚å¸¸ç»ˆæ­¢åŸå› çš„ç»ˆæ­¢çŠ¶æ€.
åœ¨ä»»æ„ä¸€ç§æƒ…å†µä¸‹, è¯¥ç»ˆæ­¢è¿›ç¨‹çš„çˆ¶è¿›ç¨‹éƒ½èƒ½ç”¨waitæˆ–è€…waitpidå‡½æ•°å–å¾—å…¶ç»ˆæ­¢çŠ¶æ€.
å¦‚æœå­è¿›ç¨‹`å®Œå…¨æ¶ˆå¤±`äº†, é‚£ä¹ˆçˆ¶è¿›ç¨‹æ˜¯æ— æ³•è·å–ç»ˆæ­¢çŠ¶æ€çš„.
å®é™…ä¸Šå†…æ ¸ä¸ºæ¯ä¸ªç»ˆæ­¢è¿›ç¨‹ä¿å­˜äº†ä¸€å®šé‡çš„ä¿¡æ¯, æ‰€ä»¥å½“ç»ˆæ­¢è¿›ç¨‹çš„çˆ¶è¿›ç¨‹è°ƒç”¨waitæˆ–è€…waitpidæ—¶, å¯ä»¥å¾—åˆ°è¿™äº›ä¿¡æ¯. 
è¿™äº›ä¿¡æ¯è‡³å°‘åŒ…æ‹¬è¿›ç¨‹ID, è¯¥è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€,ä»¥åŠè¯¥è¿›ç¨‹ä½¿ç”¨çš„CPUæ—¶é—´æ€»é‡.
</code></pre>
<p><strong>åƒµæ­»è¿›ç¨‹</strong></p>
<pre><code>ä¸€ä¸ªå·²ç»ç»ˆæ­¢, ä½†æ˜¯å…¶çˆ¶è¿›ç¨‹å°šæœªå¯¹å…¶è¿›è¡Œå–„åå¤„ç†çš„è¿›ç¨‹è¢«ç§°ä¸ºåƒµæ­»è¿›ç¨‹
å–„åå¤„ç†åŒ…æ‹¬: è·å–ç»ˆæ­¢å­è¿›ç¨‹çš„æœ‰å…³ä¿¡æ¯, é‡Šæ”¾å®ƒçš„èµ„æº
</code></pre>
<p><strong>çˆ¶è¿›ç¨‹ç»ˆæ­¢</strong></p>
<pre><code>å¯¹äºçˆ¶è¿›ç¨‹å·²ç»ç»ˆæ­¢çš„æ‰€æœ‰è¿›ç¨‹, ä»–ä»¬çš„çˆ¶è¿›ç¨‹éƒ½æ”¹å˜ä¸ºinitè¿›ç¨‹. æˆ‘ä»¬ç§°è¢«initè¿›ç¨‹æ”¶å…»
å½“ä¸€ä¸ªè¿›ç¨‹ç»ˆæ­¢æ˜¯, å†…æ ¸é€ä¸ªæ£€æŸ¥æ‰€æœ‰çš„æ´»åŠ¨è¿›ç¨‹, ä»¥åˆ¤æ–­å®ƒæ˜¯å¦æ˜¯è¦ç»ˆæ­¢è¿›ç¨‹çš„å­è¿›ç¨‹, å¦‚æœæ˜¯,è¯¥ è¿›ç¨‹çš„çˆ¶è¿›ç¨‹IDå°±æ”¹ä¸º1
</code></pre>
<h3 id="8-6-å‡½æ•°waitå’Œwaitpid"><a href="#8-6-å‡½æ•°waitå’Œwaitpid" class="headerlink" title="8.6 å‡½æ•°waitå’Œwaitpid"></a>8.6 å‡½æ•°waitå’Œwaitpid</h3><pre><code>å½“ä¸€ä¸ªè¿›ç¨‹æ­£å¸¸æˆ–è€…å¼‚å¸¸ç»ˆæ­¢æ—¶, å†…æ ¸å°±å‘å…¶çˆ¶è¿›ç¨‹å‘é€SIGCHLDä¿¡å·.
å› ä¸ºå­è¿›ç¨‹ç»ˆæ­¢æ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶, æ‰€ä»¥è¿™æ€»ä¿¡å·ä¹Ÿæ˜¯å†…æ ¸å‘çˆ¶è¿›ç¨‹å‘çš„å¼‚æ­¥é€šçŸ¥. 
çˆ¶è¿›ç¨‹å¯ä»¥é€‰æ‹©å¿½ç•¥è¯¥ä¿¡å·, æˆ–è€…æä¾›ä¸€ä¸ªè¯¥ä¿¡å·å‘ç”Ÿæ—¶å³è¢«è°ƒç”¨æ‰§è¡Œçš„å‡½æ•°.
è°ƒç”¨waitæˆ–è€…waitpidä¼šå‘ç”Ÿä»€ä¹ˆ: 
1. å¦‚æœå…¶æ‰€æœ‰å­è¿›ç¨‹éƒ½è¿˜åœ¨è¿è¡Œ, åˆ™é˜»å¡
2. å¦‚æœä¸€ä¸ªå­è¿›ç¨‹å·²ç»ˆæ­¢, æ­£ç­‰å¾…çˆ¶è¿›ç¨‹è·å–å…¶ç»ˆæ­¢è£…å¡«, åˆ™å–å¾—è¯¥å­è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€ç«‹å³è¿”å›
3. å¦‚æœå®ƒæ²¡æœ‰ä»»ä½•å­è¿›ç¨‹, åˆ™ç«‹å³å‡ºé”™è¿”å›
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">wait</span><span class="params">(<span class="keyword">int</span> *statloc)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">waitpid</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span> *statloc, <span class="keyword">int</span> options)</span></span>;</span><br></pre></td></tr></table></figure>

<pre><code>statloc æ˜¯ä¸€ä¸ªæ•´å‹æŒ‡é’ˆ, å¦‚æœè¯´statlocä¸æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆ,
åˆ™ç»ˆæ­¢è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€å°±å­˜æ”¾åœ¨å®ƒæ‰€æŒ‡å‘çš„å•å…ƒå†…. 
</code></pre>
<p><img src="/image/wait.png" alt="Alt text"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;apue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pr_exit</span><span class="params">(<span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WIFEXITED</span>(status)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;normal termination, exit status = %d\n&quot;</span>, <span class="built_in">WEXITSTATUS</span>(status));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">WIFSIGNALED</span>(status)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;abnormal termination, signal num = %d %s\n&quot;</span>, <span class="built_in">WTERMSIG</span>(status),</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WCOREDUMP</span></span><br><span class="line">               <span class="built_in">WCOREDUMP</span>(status) ? <span class="string">&quot;(core file generated)&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">               <span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">WIFSTOPPED</span>(status)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;child stoped, signal number = %d\n&quot;</span>, <span class="built_in">WSTOPSIG</span>(status));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">if</span> ((pid = fork()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">err_sys</span>(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">7</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">wait</span>(&amp;status) != pid) &#123;</span><br><span class="line">        <span class="built_in">err_sys</span>(<span class="string">&quot;wait error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">pr_exit</span>(status);</span><br><span class="line">    <span class="keyword">if</span> ((pid = fork()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">err_sys</span>(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">abort</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">wait</span>(&amp;status) != pid) &#123;</span><br><span class="line">        <span class="built_in">err_sys</span>(<span class="string">&quot;wait error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">pr_exit</span>(status);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((pid = fork()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">err_sys</span>(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        status /= <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">wait</span>(&amp;status) != pid) &#123;</span><br><span class="line">        <span class="built_in">err_sys</span>(<span class="string">&quot;wait error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">pr_exit</span>(status);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>waitpid</strong></p>
<pre><code>pid==-1 ç­‰å¾…ä»»ä¸€ä¸ªå­è¿›ç¨‹
pi &gt; 0 ç­‰å¾…è¿›ç¨‹IDå’Œpidç›¸ç­‰çš„å­è¿›ç¨‹
pid==0 ç­‰å¾…ç»„IDç­‰äºè°ƒç”¨è¿›ç¨‹ç»„IDçš„ä»»ä¸€å­è¿›ç¨‹
pid&lt; -1 ç­‰å¾…ç»„IDç­‰äºpidç»å¯¹å€¼çš„ä»»ä¸€è¿›ç¨‹

option æ˜¯æˆ‘ä»¬è¿›ä¸€æ­¥æ§åˆ¶waitpidçš„æ“ä½œ, æ­¤å‚æ•°æˆ–è€…æ˜¯0, æˆ–è€…æ˜¯ä¸‹å›¾å¸¸é‡æŒ‰ä½æˆ–è¿ç®—çš„ç»“æœ
</code></pre>
<p><img src="/image/wait_option.png" alt="Alt text"></p>
<h3 id="8-7-å‡½æ•°waitpid"><a href="#8-7-å‡½æ•°waitpid" class="headerlink" title="8.7 å‡½æ•°waitpid"></a>8.7 å‡½æ•°waitpid</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">waitid</span><span class="params">(<span class="keyword">idtype_t</span> idtype, <span class="keyword">id_t</span> id, <span class="keyword">siginfo_t</span> *infop, <span class="keyword">int</span> options)</span></span>;</span><br></pre></td></tr></table></figure>
<pre><code>waitid å…è®¸ä¸€ä¸ªè¿›ç¨‹æŒ‡å®šè¦ç­‰å¾…çš„å­è¿›ç¨‹. 
ä½†å®ƒä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„å‚æ•°æ ‡è¯†è¦ç­‰å¾…çš„å­è¿›ç¨‹æ‰€å±çš„ç±»å‹,è€Œä¸æ˜¯å°†æ­¤ä¸è¿›ç¨‹IDæˆ–è€…è¿›ç¨‹ç»„IDç»„åˆæˆä¸€ä¸ªå‚æ•°. 
idå‚æ•°çš„ä½œç”¨äºidtypeçš„å€¼æœ‰å…³, è¯¥å‡½æ•°æ”¯æŒçš„IDtypeç±»å‹çš„å€¼å¦‚ä¸‹
</code></pre>
<p><img src="/image/waitid.png" alt="Alt text"></p>
<pre><code>optionå‚æ•°æ˜¯ä¸‹å›¾å„æ ‡å¿—çš„æŒ‰ä½æˆ–è¿ç®—.
</code></pre>
<p><img src="/image/waitid_option.png" alt="Alt text"></p>
<pre><code>WCONTINUED, WEXITEDæˆ–è€…WSTOPPEDä¸‰ä¸ªå¸¸é‡ä¹‹ä¸€å¿…é¡»åœ¨optionså‚æ•°ä¸­æŒ‡å®š.
infoå‚æ•°æ˜¯æŒ‡å‘siginfoç»“æ„çš„æŒ‡é’ˆ, è¯¥ç»“æ„åŒ…å«äº†é€ æˆå­è¿›ç¨‹çŠ¶æ€æ”¹å˜æœ‰å…³ä¿¡å·çš„è¯¦ç»†ä¿¡æ¯
</code></pre>
<h3 id="8-8-å‡½æ•°wait3æˆ–è€…å‡½æ•°wait4"><a href="#8-8-å‡½æ•°wait3æˆ–è€…å‡½æ•°wait4" class="headerlink" title="8.8 å‡½æ•°wait3æˆ–è€…å‡½æ•°wait4"></a>8.8 å‡½æ•°wait3æˆ–è€…å‡½æ•°wait4</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;resource.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">wait3</span><span class="params">(<span class="keyword">int</span> *statloc, <span class="keyword">int</span> options, struct rusage *rusage)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">wait4</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span> *statloc, <span class="keyword">int</span> options, struct rusage *rusage)</span></span>;</span><br></pre></td></tr></table></figure>

<pre><code>æ¯”waitå’Œwaitpidçš„åŠŸèƒ½å¤šä¸€ä¸ª, è¿™ä¸é™„åŠ å‚æ•°æœ‰å…³. 
è¯¥é™„åŠ å‚æ•°å…è®¸å†…æ ¸è¿”å›ç”±ç»ˆæ­¢è¿›ç¨‹ä»¥åŠå…¶æ‰€æœ‰å­è¿›ç¨‹ä½¿ç”¨çš„èµ„æºæ¦‚å†µ
èµ„æºæ¦‚å†µåŒ…æ‹¬: ç”¨æˆ·CPUæ—¶é—´æ€»é‡, ç³»ç»ŸCPUæ—¶é—´æ€»é‡, ç¼ºé¡µæ¬¡æ•°, æ¥æ”¶åˆ°ä¿¡å·çš„æ¬¡æ•°ç­‰. 
å…·ä½“çœ‹ `man getrusage`
</code></pre>
<h3 id="8-9-ç«äº‰æ¡ä»¶"><a href="#8-9-ç«äº‰æ¡ä»¶" class="headerlink" title="8.9 ç«äº‰æ¡ä»¶"></a>8.9 ç«äº‰æ¡ä»¶</h3><pre><code>å½“å¤šä¸ªè¿›ç¨‹éƒ½ä¼å›¾å¯¹å…±äº«æ•°æ®è¿›è¡ŒæŸç§å¤„ç†, è€Œæœ€åçš„ç»“æœåˆå–å†³äºè¿›ç¨‹è¿è¡Œçš„é¡ºåˆ©æ—¶, æˆ‘ä»¬å°±è®¤ä¸ºå‘ç”Ÿäº†ç«äº‰æ¡ä»¶. 
å¦‚æœå­è¿›ç¨‹éœ€è¦ç­‰å¾…çˆ¶è¿›ç¨‹ç»“æŸ, å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="built_in">getpid</span>() != <span class="number">1</span>)&#123; <span class="comment">// çˆ¶è¿›ç¨‹ç»“æŸ, å­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹å˜ä¸ºinitè¿›ç¨‹</span></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>ä¹Ÿå¯ä»¥ä½¿ç”¨ä¿¡å·æœºåˆ¶/è¿›ç¨‹é—´é€šä¿¡
</code></pre>
<h3 id="8-10-å‡½æ•°exec"><a href="#8-10-å‡½æ•°exec" class="headerlink" title="8.10 å‡½æ•°exec"></a>8.10 å‡½æ•°exec</h3><pre><code>8.3èŠ‚æåˆ°çš„forkå‡½æ•°åˆ›å»ºæ–°çš„å­è¿›ç¨‹å, å­è¿›ç¨‹å¾€å¾€è¦è°ƒç”¨ä¸€ç§execå‡½æ•°ä¸€éæ‰§è¡Œå¦ä¸€ä¸ªç¨‹åº. 
å½“è¿›ç¨‹è°ƒç”¨ä¸€ç§execå‡½æ•°, è¯¥è¿›ç¨‹æ‰§è¡Œçš„ç¨‹åºå®Œå…¨æ›¿æ¢ä¸ºæ–°ç¨‹åº, è€Œæ–°ç¨‹åºåˆ™ä»å…¶mainå‡½æ•°å¼€å§‹æ‰§è¡Œ. 
execå¹¶ä¸åˆ›å»ºæ–°è¿›ç¨‹, æ‰€æœ‰å‰åçš„è¿›ç¨‹IDå¹¶æœªæ”¹å˜. 
æœ‰7ä¸ªä¸ç”¨çš„execå‡½æ•°å¯ä»¥ä¾›ä½¿ç”¨. 
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execl</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">const</span> <span class="keyword">char</span> *arg0, ... )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execv</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">char</span> *<span class="keyword">const</span> argv[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execle</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">const</span> <span class="keyword">char</span> *arg0, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execve</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, , <span class="keyword">char</span> *<span class="keyword">const</span> argv[], <span class="keyword">char</span> *<span class="keyword">const</span> envp[])</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execlp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">const</span> <span class="keyword">char</span> *arg0, .. )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execvp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">char</span> *<span class="keyword">const</span> argv[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fexecve</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">char</span> *<span class="keyword">const</span> argv[], <span class="keyword">char</span> *<span class="keyword">const</span> envp[])</span></span>;</span><br></pre></td></tr></table></figure>


<p><strong>ç¬¬ä¸€ä¸ªåŒºåˆ«</strong></p>
<pre><code>å½“æŒ‡å®šfilenameä½œä¸ºå‚æ•°æ—¶: 
1. å¦‚æœfilenameä¸­åŒ…å«/ , åˆ™å°±å°†å…¶è§†ä¸ºè·¯å¾„å
2. å¦åˆ™å°±æŒ‰PATHç¯å¢ƒå˜é‡, åœ¨å®ƒæŒ‡å®šçš„å„ç›®å½•ä¸­æœå¯»å¯æ‰§è¡Œæ–‡ä»¶

å¦‚æœexeclpå’Œexecvpä½¿ç”¨è·¯å¾„å‰ç¼€ä¸­çš„ä¸€ä¸ªæ‰¾åˆ°äº†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶,
ä½†æ˜¯è¯¥æ–‡ä»¶ä¸æ˜¯ç”±è¿æ¥ç¼–è¾‘å™¨äº§ç”Ÿçš„æœºå™¨å¯æ‰§è¡Œæ–‡ä»¶, åˆ™å°±è®¤ä¸ºè¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ªshellè„šæœ¬.
äºæ˜¯è¯•ç€è°ƒç”¨/bin/sh, å¹¶ä»¥filename ä½œä¸ºshellçš„è¾“å…¥.
</code></pre>
<hr>
<p><strong>ç¬¬äºŒä¸ªåŒºåˆ«</strong></p>
<pre><code>å‚æ•°è¡¨çš„ä¼ é€’, lè¡¨ç¤ºåˆ—è¡¨, vè¡¨ç¤ºvector. 
å‡½æ•°execl,execlpå’Œexecleè¦æ±‚å°†æ–°ç¨‹åºçš„æ¯ä¸ªå‘½ä»¤è¡Œå‚æ•°éƒ½è¯´æ˜ä¸ºä¸€ä¸ªå•ç‹¬çš„å‚æ•°. è¿™ç§å‚æ•°è¡¨ä»¥ç©ºæŒ‡é’ˆç»“å°¾.
å¯¹äºå¦å¤–çš„å››ä¸ªå‡½æ•°, åˆ™åº”è¯¥å…ˆæ„é€ å‡ºä¸€ä¸ªæŒ‡å‘å„å‚æ•°çš„æŒ‡é’ˆæ•°ç»„, ç„¶åå°†è¯¥æ•°ç»„åœ°å€ä½œä¸ºè¿™å››ä¸ªå‡½æ•°çš„å‚æ•°
</code></pre>
<hr>
<p><strong>ç¬¬ä¸‰ä¸ªåŒºåˆ«</strong></p>
<pre><code>æœ€åä¸€ä¸ªåŒºåˆ«ä¸æƒ³æ–°ç¨‹åºä¼ é€’ç¯å¢ƒè¡¨ç›¸å…³. 
ä»¥eç»“å°¾çš„ä¸‰ä¸ªå‡½æ•°, å¯ä»¥ä¼ é€’ä¸€ä¸ªçº¸ç®±ç¯å¢ƒå­—ç¬¦ä¸²æŒ‡é’ˆæ•°ç»„çš„æŒ‡é’ˆ. 
å…¶ä»–å››ä¸ªå‡½æ•°åˆ™ä½¿ç”¨è°ƒç”¨è¿‡ç¨‹ä¸­çš„environå˜é‡ä¸ºæ–°ç¨‹åºå¤åˆ¶ç°æœ‰çš„ç¯å¢ƒ.
</code></pre>
<hr>
<pre><code>å‰é¢æåŠ, åœ¨æ‰§è¡Œexecå, è¿›ç¨‹IDæ²¡æœ‰æ”¹å˜, ä½†æ˜¯æ–°ç¨‹åºä»è°ƒç”¨è¿›ç¨‹ç»§æ‰¿äº†ä¸‹åˆ—å±æ€§:
1. è¿›ç¨‹IDå’Œçˆ¶è¿›ç¨‹ID
2. å®é™…ç”¨æˆ·IDå’Œå®é™…ç»„ID
3. é™„å±ç»„ID
4. è¿›ç¨‹ç»„ID
5. ä¼šè¯ID
6. æ§åˆ¶ç»ˆç«¯
7. é—¹é’Ÿå°šä½™ç•™çš„æ—¶é—´
8. å½“å‰å·¥ä½œç›®å½•
9. æ ¹ç›®å½•
10. æ–‡ä»¶æ¨¡å¼åˆ›å»ºå±è”½å­—
11. æ–‡ä»¶é”
12. è¿›ç¨‹ä¿¡å·å±è”½
13. æœªå¤„ç†ä¿¡å·
14. èµ„æºé™åˆ¶
15. niceå€¼
16. tms_utime,tms_stime,tms_cutimeå’Œtms_ustimeçš„å€¼
</code></pre>
<hr>
<p><strong>FD_CLOEXECæ ‡å¿—(3.14)</strong></p>
<pre><code>è¿›ç¨‹ä¸­æ¯ä¸ªæ‰“å¼€æ–‡ä»¶æè¿°ç¬¦éƒ½æœ‰ä¸€ä¸ªæ‰§è¡Œæ—¶å…³é—­æ ‡å¿—. è‹¥è®¾ç½®äº†è¯¥æ ‡å¿—, åˆ™åœ¨æ‰§è¡Œexecæ—¶å…³é—­è¯¥æè¿°ç¬¦, å¦åˆ™è¯¥æè¿°ç¬¦ä»ç„¶æ‰“å¼€. 
</code></pre>
<hr>
<p><strong>è®¾ç½®ç”¨æˆ·/ç»„ID</strong></p>
<pre><code>å®é™…ç”¨æˆ·IDå’Œå®é™…ç»„IDä¿æŒä¸å˜. è€Œæœ‰æ•ˆIDæ˜¯å¦æ”¹å˜å–å†³äºæ‰€æ‰§è¡Œç¨‹åºæ–‡ä»¶çš„è®¾ç½®ç”¨æˆ·IDä½å’Œè®¾ç½®ç»„IDä½æ˜¯å¦è®¾ç½®. (å‚è§4.4)
</code></pre>
<hr>
<p><strong>ä¸ƒä¸ªå‡½æ•°ä¹‹é—´çš„å…³ç³»</strong><br><img src="/image/exec-1.png" alt="Alt text"></p>
<h3 id="8-11-æ›´æ”¹ç”¨æˆ·IDå’Œæ›´æ”¹ç»„ID"><a href="#8-11-æ›´æ”¹ç”¨æˆ·IDå’Œæ›´æ”¹ç»„ID" class="headerlink" title="8.11 æ›´æ”¹ç”¨æˆ·IDå’Œæ›´æ”¹ç»„ID"></a>8.11 æ›´æ”¹ç”¨æˆ·IDå’Œæ›´æ”¹ç»„ID</h3><pre><code>ä¸€èˆ¬è€Œè¨€, åœ¨è®¾è®¡åº”ç”¨æ—¶, æˆ‘ä»¬æ€»æ˜¯è¯•å›¾ä½¿ç”¨æœ€å°ç‰¹æƒæ¨¡å‹. ç¨‹åºåº”å½“åªæœ‰ä¸ºå®Œæˆç»™å®šä»»åŠ¡æ‰€éœ€çš„æœ€å°ç‰¹æƒ.
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setuid</span><span class="params">(<span class="keyword">uid_t</span> uid)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setgid</span><span class="params">(<span class="keyword">gid_t</span> gid)</span></span>;</span><br></pre></td></tr></table></figure>


<pre><code>1. è‹¥è¿›ç¨‹æ‹¥æœ‰è¶…çº§ç”¨æˆ·æƒé™, åˆ™setuidå‡½æ•°å°†å®é™…ç”¨æˆ·ID, æœ‰æ•ˆç”¨æˆ·IDä»¥åŠä¿å­˜çš„è®¾ç½®ç”¨æˆ·IDè®¾ç½®ä¸ºuid
2. è‹¥è¿›ç¨‹æ²¡æœ‰è¶…çº§ç”¨æˆ·ç‰¹æƒ, ä½†æ˜¯uidç­‰äºå®é™…ç”¨æˆ·IDæˆ–ä¿å­˜çš„è®¾ç½®ç”¨æˆ·ID, åˆ™setuidåªå°†æœ‰æ•ˆç”¨æˆ·IDè®¾ç½®ä¸ºuid, ä¸æ›´æ”¹å®é™…ç”¨æˆ·IDå’Œä¿å­˜çš„è®¾ç½®ç”¨æˆ·ID
3. å¦‚æœä¸Šé¢ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³, åˆ™errnoè®¾ç½®ä¸ºEPERM, å¹¶è¿”å›-1
</code></pre>
<p><strong>å‡½æ•°setreuidå’Œsetregid</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setreuid</span><span class="params">(<span class="keyword">uid_t</span> ruid, <span class="keyword">uid_t</span> euid)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setregid</span><span class="params">(<span class="keyword">gid_t</span> rgid, <span class="keyword">gid_t</span> egid)</span></span>;</span><br></pre></td></tr></table></figure>

<pre><code>å…¶åŠŸèƒ½æ˜¯äº¤æ¢æœ‰æ•ˆç”¨æˆ·IDå’Œå®é™…ç”¨æˆ·ID
</code></pre>
<p><strong>å‡½æ•°seteuidå’Œsetegid</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">seteuid</span><span class="params">(<span class="keyword">uid_t</span> uid)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setegid</span><span class="params">(<span class="keyword">gid_t</span> gid)</span></span>;</span><br></pre></td></tr></table></figure>

<pre><code>ç±»ä¼¼äºsetuidå’Œsetgid, ä½†æ˜¯åªæ›´æ”¹æœ‰æ•ˆç”¨æˆ·IDå’Œæœ‰æ•ˆç»„ID
</code></pre>
<h3 id="8-12-è§£é‡Šå™¨æ–‡ä»¶"><a href="#8-12-è§£é‡Šå™¨æ–‡ä»¶" class="headerlink" title="8.12 è§£é‡Šå™¨æ–‡ä»¶"></a>8.12 è§£é‡Šå™¨æ–‡ä»¶</h3><pre><code>æ²¡ä»€ä¹ˆå¥½å†™çš„
</code></pre>
<h3 id="8-13-å‡½æ•°system"><a href="#8-13-å‡½æ•°system" class="headerlink" title="8.13 å‡½æ•°system"></a>8.13 å‡½æ•°system</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">system</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *cmdstring)</span></span>;</span><br></pre></td></tr></table></figure>
<pre><code>å¦‚æœcmdstringæ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆ, é‚£ä¹ˆè¿”å›é0å€¼
systemåœ¨å…¶å®ç°ä¸­è°ƒç”¨äº†fork, exec, waitpid, å› æ­¤æœ‰ä¸‰ç§è¿”å›å€¼
1. forkå¤±è´¥æˆ–è€…waitpidè¿”å›é™¤äº†EINTRä¹‹å¤–çš„é”™è¯¯, åˆ™systemè¿”å›-1, å¹¶ä¸”è®¾ç½®errnoä»¥æŒ‡ç¤ºé”™è¯¯ç±»å‹.
2. å¦‚æœexecå¤±è´¥, åˆ™å…¶è¿”å›å€¼å¦‚åŒshellæ‰§è¡Œäº†exit(127)ä¸€æ ·
3. å¦åˆ™ä¸‰ä¸ªå‡½æ•°éƒ½æ‰§è¡ŒæˆåŠŸ, è¿”å›å€¼æ˜¯shellçš„ç»ˆæ­¢çŠ¶æ€(åœ¨waitpidä¸­å·²ç»è¯´æ˜)
</code></pre>
<h3 id="8-14-è¿›ç¨‹ä¼šè®¡"><a href="#8-14-è¿›ç¨‹ä¼šè®¡" class="headerlink" title="8.14 è¿›ç¨‹ä¼šè®¡"></a>8.14 è¿›ç¨‹ä¼šè®¡</h3><pre><code>å¤§å¤šæ•°UNIXç³»ç»Ÿéƒ½æä¾›äº†ä¸€ä¸ªé€‰é¡¹ï¸ä»¥è¿›è¡Œè¿›ç¨‹ä¼šè®¡å¤„ç†. å¯ç”¨è¯¥é€‰é¡¹å,æ¯å½“è¿›ç¨‹ç»“æŸæ—¶å†…æ ¸å°±å†™ä¸€ä¸ªä¼šè®¡è®°å½•.
</code></pre>
<h3 id="8-15-ç”¨æˆ·æ ‡è¯†"><a href="#8-15-ç”¨æˆ·æ ‡è¯†" class="headerlink" title="8.15 ç”¨æˆ·æ ‡è¯†"></a>8.15 ç”¨æˆ·æ ‡è¯†</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">getlogin</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>







<h3 id="8-16-è¿›ç¨‹è°ƒåº¦"><a href="#8-16-è¿›ç¨‹è°ƒåº¦" class="headerlink" title="8.16 è¿›ç¨‹è°ƒåº¦"></a>8.16 è¿›ç¨‹è°ƒåº¦</h3><pre><code>UNIXå†å²ä¸Šå¯¹äºè¿›ç¨‹æä¾›çš„åªæ˜¯åŸºäºè°ƒåº¦ä¼˜å…ˆçº§çš„ç²—ç²’åº¦çš„æ§åˆ¶. 
è°ƒåº¦ç­–ç•¥å’Œè°ƒåº¦ä¼˜å…ˆçº§æ˜¯ç”±å†…æ ¸ç¡®å®šçš„, è¿›ç¨‹å¯ä»¥é€šè¿‡è°ƒæ•´niceå€¼é€‰æ‹©ä»¥æ›´ä½ä¼˜å…ˆçº§è¿è¡Œ.
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nice</span><span class="params">(<span class="keyword">int</span> incr)</span></span>;</span><br></pre></td></tr></table></figure>

<pre><code>è¿›ç¨‹ä½¿ç”¨niceå‡½æ•°è·å–æˆ–è€…æ›´æ”¹å®ƒçš„niceå€¼, è¿›ç¨‹åªèƒ½å½±å“åˆ°è‡ªå·±çš„å€¼, ä¸èƒ½å½±å“åˆ°å…¶ä»–çš„è¿›ç¨‹.
incrå‚æ•°è¢«å¢åŠ åˆ°è°ƒç”¨è¿›ç¨‹çš„niceå€¼ä¸Šé¢, å¦‚æœincrå¤ªå¤§/å¤ªå°, ç³»ç»Ÿç›´æ¥æŠŠå®ƒé™åˆ°æœ€å¤§/æœ€å°åˆæ³•å€¼, ä¸ç»™å‡ºæç¤º.  ç”±äº-1æ˜¯åˆæ³•çš„æˆåŠŸè¿”å›å€¼, æ‰€ä»¥è°ƒç”¨ä¹‹å‰éœ€è¦æ¸…é™¤errno. 
</code></pre>
<p><strong>è·å–ä¸€ç»„ç›¸å…³è¿›ç¨‹çš„niceå€¼</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getpriority</span><span class="params">(<span class="keyword">int</span> which, <span class="keyword">id_t</span> who)</span></span>;</span><br></pre></td></tr></table></figure>

<pre><code>whichå‚æ•°å¯ä»¥å–ä¸€ä¸‹ä¸‰ä¸ªå€¼ä¹‹ä¸€: 
1. PRIO_PROCESS æ ‡è¯†è¿›ç¨‹
2. PRIO_PGRP æ ‡è¯†è¿›ç¨‹ç»„
3. PRIO_USER æ ‡è¯†ç”¨æˆ·ID
å¦‚æœwhichä½œç”¨äºå¤šä¸ªè¿›ç¨‹,è¿”å›ä¼˜å…ˆçº§æœ€é«˜çš„. 
</code></pre>
<p><strong>è®¾ç½®ä¸€ç»„ç›¸å…³è¿›ç¨‹çš„niceå€¼</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setpriority</span><span class="params">(<span class="keyword">int</span> which, <span class="keyword">id_t</span> who, <span class="keyword">int</span> value)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="8-17è¿›ç¨‹æ—¶é—´"><a href="#8-17è¿›ç¨‹æ—¶é—´" class="headerlink" title="8.17è¿›ç¨‹æ—¶é—´"></a>8.17è¿›ç¨‹æ—¶é—´</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/times.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">clock_t</span> <span class="title">times</span><span class="params">(struct tms *buf)</span></span>;</span><br></pre></td></tr></table></figure>

























      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/19/APUE-%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%B8%83%E7%AB%A0-%E8%BF%9B%E7%A8%8B%E7%8E%AF%E5%A2%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/default.png">
      <meta itemprop="name" content="zinego">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zinego's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/02/19/APUE-%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%B8%83%E7%AB%A0-%E8%BF%9B%E7%A8%8B%E7%8E%AF%E5%A2%83/" class="post-title-link" itemprop="url">APUE é˜…è¯»ç¬”è®° ç¬¬ä¸ƒç«  è¿›ç¨‹ç¯å¢ƒ</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-02-19 17:35:05" itemprop="dateCreated datePublished" datetime="2019-02-19T17:35:05+08:00">2019-02-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-10-31 13:59:30" itemprop="dateModified" datetime="2021-10-31T13:59:30+08:00">2021-10-31</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/APUE%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">APUEé˜…è¯»ç¬”è®°</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>4.5k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>4 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ç¬¬ä¸ƒç« -è¿›ç¨‹ç¯å¢ƒ"><a href="#ç¬¬ä¸ƒç« -è¿›ç¨‹ç¯å¢ƒ" class="headerlink" title="ç¬¬ä¸ƒç«  è¿›ç¨‹ç¯å¢ƒ"></a>ç¬¬ä¸ƒç«  è¿›ç¨‹ç¯å¢ƒ</h2><h3 id="7-1-å¼•è¨€"><a href="#7-1-å¼•è¨€" class="headerlink" title="7.1 å¼•è¨€"></a>7.1 å¼•è¨€</h3><pre><code>æœ¬ç« å†…å®¹: 
    1. è¿›ç¨‹æ‰§è¡Œæ—¶,å…¶mainå‡½æ•°æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„.
    2. å‘½ä»¤è¡Œå‚æ•°æ˜¯å¦‚ä½•ä¼ é€’ç»™æ–°ç¨‹åºçš„
    3. å…¸å‹çš„å­˜å‚¨ç©ºé—´å¸ƒå±€æ˜¯ä»€ä¹ˆæ ·å­çš„
    4. å¦‚ä½•åˆ†é…å¦å¤–çš„å­˜å‚¨ç©ºé—´
    5. è¿›ç¨‹å¦‚ä½•ä½¿ç”¨ç¯å¢ƒå˜é‡
    6. è¿›ç¨‹çš„å„ç§ä¸åŒç»ˆæ­¢æ–¹æ¡ˆ
</code></pre>
<h3 id="7-2-mainå‡½æ•°"><a href="#7-2-mainå‡½æ•°" class="headerlink" title="7.2 mainå‡½æ•°"></a>7.2 mainå‡½æ•°</h3><pre><code>å½“å†…æ ¸æ‰§è¡Œcç¨‹åºæ—¶(ä½¿ç”¨execæ‰§è¡Œ), åœ¨è°ƒç”¨mainå‡½æ•°å‰å…ˆè°ƒç”¨ä¸€ä¸ªç‰¹æ®Šçš„å¯åŠ¨ä¾‹ç¨‹.
å¯æ‰§è¡Œç¨‹åºæ–‡ä»¶å°†æ­¤å¯åŠ¨ä¾‹ç¨‹æŒ‡å®šä¸ºç¨‹åºçš„èµ·å§‹åœ°å€---è¿™æ˜¯ç”±è¿æ¥ç¼–è¾‘å™¨è®¾ç½®çš„.
è€Œè¿æ¥ç¼–è¾‘å™¨åˆ™ç”±Cç¼–è¯‘å™¨è°ƒç”¨. 
</code></pre>
<h3 id="7-3-è¿›ç¨‹ç»ˆæ­¢"><a href="#7-3-è¿›ç¨‹ç»ˆæ­¢" class="headerlink" title="7.3 è¿›ç¨‹ç»ˆæ­¢"></a>7.3 è¿›ç¨‹ç»ˆæ­¢</h3><p><strong>æ­£å¸¸ç»ˆæ­¢</strong></p>
<pre><code>1. ä»mainå‡½æ•°è¿”å›
2. è°ƒç”¨exit
3. è°ƒç”¨_exitæˆ–è€…_Exit
4. æœ€åä¸€ä¸ªçº¿ç¨‹ä»å¯å¯åŠ¨ä¾‹ç¨‹è¿”å›
5. ä»æœ€åä¸€ä¸ªçº¿ç¨‹è°ƒç”¨pthread_exit
</code></pre>
<p><strong>å¼‚å¸¸ç»ˆæ­¢</strong></p>
<pre><code>1. è°ƒç”¨abort
2. æ¥æ”¶åˆ°ä¸€ä¸ªä¿¡å·
3. æœ€åä¸€ä¸ªçº¿ç¨‹å¯¹å–æ¶ˆè¯·æ±‚åšå‡ºå“åº”
</code></pre>
<h4 id="1-é€€å‡ºå‡½æ•°"><a href="#1-é€€å‡ºå‡½æ•°" class="headerlink" title="1. é€€å‡ºå‡½æ•°"></a>1. é€€å‡ºå‡½æ•°</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exit</span><span class="params">(<span class="keyword">int</span> status)</span></span>;</span><br><span class="line"><span class="keyword">void</span> _Exit(<span class="keyword">int</span> status);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">void</span> _exit(<span class="keyword">int</span> status);</span><br></pre></td></tr></table></figure>

<pre><code>exit å‡½æ•°æ€»æ˜¯æ‰§è¡Œä¸€ä¸ªæ ‡å‡†IOåº“çš„æ¸…ç†å…³é—­æ“ä½œ: å¯¹äºæ‰€æœ‰æ‰“å¼€æµè°ƒç”¨fcloseå‡½æ•°. 
å³: è¾“å‡ºç¼“å†²ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½è¢«å†²æ´—
</code></pre>
<p><strong>ç»ˆæ­¢çŠ¶æ€æœªå®šä¹‰</strong></p>
<pre><code>a. è°ƒç”¨ä»¥ä¸Šå‡½æ•°ä¸å¸¦ç»ˆæ­¢çŠ¶æ€
b. mainæ‰§è¡Œäº†ä¸€ä¸ªæ— è¿”å›å€¼çš„return
c. mainæ²¡æœ‰å£°æ˜è¿”å›ç±»å‹ä¸ºæ•´å‹
</code></pre>
<h4 id="2-å‡½æ•°atexit"><a href="#2-å‡½æ•°atexit" class="headerlink" title="2. å‡½æ•°atexit"></a>2. å‡½æ•°atexit</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">atexit</span><span class="params">(<span class="keyword">void</span> (*func)(<span class="keyword">void</span>))</span></span>;</span><br></pre></td></tr></table></figure>

<pre><code>è¿›ç¨‹å¯ä»¥ç™»è®°å¤šåˆ°32ä¸ªå‡½æ•°, å°†ç”±exitè°ƒç”¨, è¿™äº›å‡½æ•°è¢«ç§°ä¸ºç»ˆæ­¢å¤„ç†ç¨‹åº
å…¶ä¸­, atexitå‡½æ•°çš„å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°åœ°å€, è°ƒç”¨è¯¥å‡½æ•°ä¸éœ€è¦å‘å®ƒä¼ é€’ä»»ä½•å‚æ•°, ä¹Ÿæ²¡è¿”å›å€¼. 
ç™»è®°é¡ºåºå’Œè°ƒç”¨é¡ºåºç›¸å, ç™»è®°å¤šæ¬¡ä¹Ÿä¼šè¢«è°ƒç”¨å¤šæ¬¡.
</code></pre>
<p><strong>å’Œgolangä¸­çš„deferç±»ä¼¼</strong></p>
<pre><code>å¦‚æœç¨‹åºè°ƒç”¨execå‡½æ•°æ—ä¸­çš„ä»»ä¸€å‡½æ•°, åˆ™å°†æ¸…é™¤æ‰€æœ‰å·²ç»å®‰è£…çš„ä¸­ç»ˆæ­¢å¤„ç†ç¨‹åº
</code></pre>
<p><img src="/image/exec.png" alt="Alt text"></p>
<h3 id="7-4-å‘½ä»¤è¡Œå‚æ•°"><a href="#7-4-å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="7.4 å‘½ä»¤è¡Œå‚æ•°"></a>7.4 å‘½ä»¤è¡Œå‚æ•°</h3><pre><code>æ²¡å•¥å¥½å†™çš„...
</code></pre>
<h3 id="7-5-ç¯å¢ƒè¡¨"><a href="#7-5-ç¯å¢ƒè¡¨" class="headerlink" title="7.5 ç¯å¢ƒè¡¨"></a>7.5 ç¯å¢ƒè¡¨</h3><pre><code>å…¨å±€å˜é‡environåŒ…å«äº†è¯¥æŒ‡é’ˆæ•°ç»„çš„åœ°å€
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span> **environ</span><br></pre></td></tr></table></figure>

<h3 id="7-6-Cç¨‹åºçš„å­˜å‚¨ç©ºé—´å¸ƒå±€"><a href="#7-6-Cç¨‹åºçš„å­˜å‚¨ç©ºé—´å¸ƒå±€" class="headerlink" title="7.6 Cç¨‹åºçš„å­˜å‚¨ç©ºé—´å¸ƒå±€"></a>7.6 Cç¨‹åºçš„å­˜å‚¨ç©ºé—´å¸ƒå±€</h3><pre><code>Cç¨‹åºä¸€ç›´ç”±ä¸‹åˆ—å‡ éƒ¨åˆ†ç»„æˆ:
1. æ­£æ–‡æ®µ: è¿™æ˜¯ç”±CPUæ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤éƒ¨åˆ†. åªè¯»ä¸”å¯å…±äº«. 
2. åˆå§‹åŒ–`æ•°æ®æ®µ`: åŒ…å«äº†ç¨‹åºä¸­éœ€è¦æ˜ç¡®åœ°èµ‹åˆå€¼çš„å˜é‡. 
3. æœªåˆå§‹åŒ–æ•°æ®æ®µ: é€šå¸¸ç§°ä¸ºbssæ®µ. ç¨‹åºå¼€å§‹ä¹‹å‰, å†…æ ¸å°†æ­¤æ®µç»ˆç«¯æ•°æ®åˆå§‹åŒ–ä¸º0æˆ–è€…ç©ºæŒ‡é’ˆ. 
4. æ ˆ: è‡ªåŠ¨å˜é‡ä»¥åŠæ¯æ¬¡å‡½æ•°è°ƒç”¨æ—¶æ‰€éœ€è¦ä¿å­˜çš„ä¿¡æ¯éƒ½å­˜æ”¾åœ¨æ­¤æ®µä¸­. 
5. å †: åŠ¨æ€å­˜å‚¨åˆ†é…. 
</code></pre>
<p><img src="/image/memory.png" alt="Alt text"></p>
<h3 id="7-7-å…±äº«åº“"><a href="#7-7-å…±äº«åº“" class="headerlink" title="7.7 å…±äº«åº“"></a>7.7 å…±äº«åº“</h3><pre><code>å…±äº«åº“ä½¿å¾—å¯æ‰§è¡Œæ–‡ä»¶ä¸­ä¸éœ€è¦åŒ…å«å…¬ç”¨çš„åº“å‡½æ•°, åªéœ€è¦åœ¨æ‰€æœ‰è¿›ç¨‹éƒ½å¯ä»¥å¼•ç”¨çš„å­˜å‚¨åŒºä¸­ä¿å­˜è¿™ç§åº“ä¾‹ç¨‹çš„ä¸€ä¸ªå‰¯æœ¬.
ç¨‹åºç¬¬ä¸€æ¬¡æ‰§è¡Œæˆ–è€…ç¬¬ä¸€æ¬¡è°ƒç”¨æŸä¸ªåº“å‡½æ•°æ—¶, ä½¿ç”¨åŠ¨æ€é“¾æ¥çš„æ–¹æ³•å°†ç¨‹åºä¸å…±äº«åº“è¿æ¥. 
è¿™å‡å°‘äº†æ¯ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„é•¿åº¦, æ€èƒ½å¢åŠ äº†ä¸€äº›è¿è¡Œæ—¶é—´å¼€é”€.
å¦ä¸€ä¸ªä¼˜ç‚¹æ˜¯ä½¿ç”¨åº“çš„æ–°ç‰ˆæœ¬ä»£æ›¿è€ç‰ˆæœ¬æ—¶ä¸éœ€è¦å†å¯¹ä½¿ç”¨è¯¥åº“çš„ç¨‹åºé‡æ–°è¿æ¥ç¼–è¾‘
ä½¿ç”¨`-static` é˜»æ­¢gccä½¿ç”¨å…±äº«åº“
</code></pre>
<h3 id="7-8-å­˜å‚¨ç©ºé—´åˆ†é…"><a href="#7-8-å­˜å‚¨ç©ºé—´åˆ†é…" class="headerlink" title="7.8 å­˜å‚¨ç©ºé—´åˆ†é…"></a>7.8 å­˜å‚¨ç©ºé—´åˆ†é…</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span>; </span><br><span class="line"><span class="comment">// åˆ†é…æŒ‡å®šå­—èŠ‚æ•°çš„å­˜å‚¨åŒº, åˆå§‹å€¼ä¸ç¡®å®š </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">calloc</span><span class="params">(<span class="keyword">size_t</span> nobj, <span class="keyword">size_t</span> size)</span></span>; </span><br><span class="line"><span class="comment">//ä¸ºæŒ‡å®šæ•°é‡æŒ‡å®šé•¿åº¦çš„å¯¹è±¡åˆ†é…å­˜å‚¨ç©ºé—´, æ¯ä¸€ä½(bit)éƒ½åˆå§‹åŒ–ä¸º0</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">realloc</span><span class="params">(<span class="keyword">void</span> *ptr, <span class="keyword">size_t</span> newsize)</span></span>;</span><br><span class="line"><span class="comment">// å¢åŠ æˆ–è€…å‡å°‘ä»¥å‰åˆ†é…åŒºçš„é•¿åº¦, å¯èƒ½å‘ç”Ÿæ‹·è´, åˆå§‹å€¼ä¸ç¡®å®š</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span>;</span><br></pre></td></tr></table></figure>




<h3 id="7-9-ç¯å¢ƒå˜é‡"><a href="#7-9-ç¯å¢ƒå˜é‡" class="headerlink" title="7.9 ç¯å¢ƒå˜é‡"></a>7.9 ç¯å¢ƒå˜é‡</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">getenv</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br></pre></td></tr></table></figure>
<pre><code>è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡é’ˆ, æŒ‡å‘name=valueå­—ç¬¦ä¸²ä¸­çš„value,
æˆ‘ä»¬åº”å½“ä½¿ç”¨getenvä»ç¯å¢ƒä¸­å»ä¸€ä¸ªæŒ‡å®šç¯å¢ƒå˜é‡çš„å€¼, è€Œä¸æ˜¯ç›´æ¥å»è®¿é—®environ
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">putenv</span><span class="params">(<span class="keyword">char</span> *str)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setenv</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *value, <span class="keyword">int</span> rewrite)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">unsetenv</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line"><span class="comment">// ä»¥ä¸Šå‡½æ•°åªæ”¯æŒéƒ¨åˆ†ç³»ç»Ÿ</span></span><br></pre></td></tr></table></figure>


<pre><code>1. putenvå–å½¢å¼ä¸ºname=valueçš„å­—ç¬¦ä¸²å°†å…¶æ”¾åˆ°ç¯å¢ƒè¡¨ä¸­, å¦‚æœnameå·²ç»å­˜åœ¨, åˆ™åˆ é™¤ä¹‹å‰çš„å®šä¹‰.
2. setenvå°†nameè®¾ç½®ä¸ºvalue,  å¦‚æœå·²ç»å­˜åœ¨name, ä¸”rewriteé0, é¦–å…ˆåˆ é™¤å…¶ç°åœ¨çš„å®šä¹‰, å¦åˆ™ä¸åˆ é™¤
3. unsetenvåˆ é™¤nameçš„å®šä¹‰, å³ä½¿ä¸å­˜åœ¨è¿™ç§å®šä¹‰ä¹Ÿä¸ç®—é”™è¯¯
</code></pre>
<h4 id="ä¿®æ”¹ç¯å¢ƒå˜é‡å¯¼è‡´çš„å†…å­˜å˜åŒ–"><a href="#ä¿®æ”¹ç¯å¢ƒå˜é‡å¯¼è‡´çš„å†…å­˜å˜åŒ–" class="headerlink" title="ä¿®æ”¹ç¯å¢ƒå˜é‡å¯¼è‡´çš„å†…å­˜å˜åŒ–"></a>ä¿®æ”¹ç¯å¢ƒå˜é‡å¯¼è‡´çš„å†…å­˜å˜åŒ–</h4><pre><code>1. åˆ é™¤å­—ç¬¦ä¸²: åœ¨ç¯å¢ƒè¡¨ä¸­æ‰¾åˆ°è¯¥æŒ‡é’ˆ, ç„¶åå°†æ‰€æœ‰åç»­æŒ‡é’ˆéƒ½å‘ç¯å¢ƒè¡¨é¦–éƒ¨é¡ºæ¬¡ç§»åŠ¨ä¸€ä¸ªä½ç½®. 
2. ä¿®æ”¹å­—ç¬¦ä¸²: 
    1. å¦‚æœæ–°çš„valueçš„é•¿åº¦å°‘äºæˆ–è€…ç­‰äºç°æœ‰valueçš„é•¿åº¦, åˆ™åªéœ€è¦å°†æ–°å­—ç¬¦ä¸²å¤åˆ¶åˆ°åŸå­—ç¬¦ä¸²æ‰€åœ¨ç©ºé—´ä¸­
    2. å¦‚æœæ–°çš„valueçš„é•¿åº¦å¤§äºç°æœ‰çš„valueçš„é•¿åº¦, è°ƒç”¨mallocåˆ†é…ç©ºé—´, å¹¶å°†å­—ç¬¦ä¸²å¤åˆ¶åˆ°è¯¥ç©ºé—´, ä½¿ç¯å¢ƒè¡¨é’ˆå¯¹nameçš„æŒ‡é’ˆæŒ‡å‘æ–°åˆ†é…åŒº
3. å¦‚æœè¦å¢åŠ ä¸€ä¸ªæ–°çš„name, è°ƒç”¨mallocä¸ºname=valueçš„å­—ç¬¦ä¸²åˆ†é…ç©ºé—´, ç„¶åå°†å­—ç¬¦ä¸²å¤åˆ¶åˆ°è¯¥ç©ºé—´ä¸­
    1.  å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¢åŠ ä¸€ä¸ªæ–°name, åˆ™å¿…é¡»è°ƒç”¨mallocä¸ºæ–°çš„æŒ‡é’ˆè¡¨åˆ†é…ç©ºé—´, 
        æ¥ç€, å°†åŸæ¥çš„ç¯å¢ƒè¡¨å¤åˆ¶åˆ°æ–°çš„åˆ†é…åŒº,
        å¹¶å°†æŒ‡å‘æ–°çš„name=valueçš„å­—ç¬¦ä¸²çš„æŒ‡é’ˆå­˜æ”¾åœ¨è¯¥æŒ‡é’ˆè¡¨çš„æœ«å°¾,
        ç„¶ååˆå°†ä¸€ä¸ªç©ºæŒ‡é’ˆå­˜æ”¾åœ¨å…¶å, æœ€åä½¿environæŒ‡å‘æ–°æŒ‡é’ˆè¡¨.
        æ³¨æ„: åªå¤åˆ¶ç¯å¢ƒè¡¨, ç¯å¢ƒè¡¨ä¸­å­˜å‚¨çš„æ˜¯æŒ‡é’ˆ, åŸæ¥çš„å€¼ä¾æ—§å­˜å‚¨åœ¨æ ˆé¡¶ä¹‹ä¸Š
    2.  å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡å¢åŠ ä¸€ä¸ªæ–°name, åªéœ€è¦è°ƒç”¨realloc
        ä»¥åˆ†é…æ¯”åŸç©ºé—´å¤šå­˜æ”¾ä¸€ä¸ªæŒ‡é’ˆçš„ç©ºé—´, 
        ç„¶åå°†æŒ‡å‘æ–°çš„name=valueå­—ç¬¦ä¸²çš„æŒ‡é’ˆå­˜æ”¾åœ¨è¯¥è¡¨è¡¨å°¾, åé¢è·Ÿç€ä¸€ä¸ªç©ºæŒ‡é’ˆ
</code></pre>
<h3 id="7-10-å‡½æ•°setjmpå’Œlongjmp"><a href="#7-10-å‡½æ•°setjmpå’Œlongjmp" class="headerlink" title="7.10 å‡½æ•°setjmpå’Œlongjmp"></a>7.10 å‡½æ•°setjmpå’Œlongjmp</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setjmp</span><span class="params">(jmp_buf env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">longjmp</span><span class="params">(jmp_buf env, <span class="keyword">int</span> val)</span></span>; </span><br><span class="line"><span class="comment">// val ç”¨æ¥åŒºåˆ†ä¸åŒçš„longjmp, valä¼šä½œä¸ºsetjmpçš„è¿”å›å€¼</span></span><br></pre></td></tr></table></figure>

<pre><code>ç”¨äºå‡ºç°é”™è¯¯æ—¶, ç›´æ¥ä¸¢å¼ƒä¸­é—´è°ƒç”¨å‡½æ•°çš„æ ˆå¸§, ç›´æ¥é‡æ–°å›åˆ°setjmpçš„ä½ç½®
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;apue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">jmp_buf jmpbuffer;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;in %d\n&quot;</span>, a);</span><br><span class="line">    <span class="keyword">if</span> (a &gt; <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="built_in">longjmp</span>(jmpbuffer, <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">func</span>(a + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;out %d\n&quot;</span>, a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func1</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;in %d\n&quot;</span>, a);</span><br><span class="line">    <span class="keyword">if</span> (a &gt; <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">func1</span>(a + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;out %d\n&quot;</span>, a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">func1</span>(<span class="number">1</span>); <span class="comment">// æ™®é€šçš„å‡ºé”™è¿”å›æ–¹å¼, è¿˜éœ€è¦ä¸€å±‚ä¸€å±‚å›åˆ°è¢«è°ƒç”¨è€…å‡½æ•°é‚£é‡Œ, æœ€åæ‰å›åˆ°ç›®çš„ä½ç½®</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line">    x = <span class="built_in">setjmp</span>(jmpbuffer);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;setjmp %d\n&quot;</span>, x);</span><br><span class="line">    <span class="keyword">if</span> (x != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// printf(&quot;%d error&quot;, x);</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">func</span>(<span class="number">1</span>);<span class="comment">// ä½¿ç”¨longjmp, ç›´æ¥å›åˆ°setjmp</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<p><strong>è‡ªåŠ¨å˜é‡(å±€éƒ¨å˜é‡), å¯„å­˜å™¨å˜é‡(register)å’Œæ˜“å¤±å˜é‡(volatile)</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;apue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">f1</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">f2</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> jmp_buf jmpbuffer;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> globval;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> autoval;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">int</span> regival;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> volaval;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> statval;</span><br><span class="line">    globval = <span class="number">1</span>;</span><br><span class="line">    autoval = <span class="number">2</span>;</span><br><span class="line">    regival = <span class="number">3</span>;</span><br><span class="line">    volaval = <span class="number">4</span>;</span><br><span class="line">    statval = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setjmp</span>(jmpbuffer) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;after longjmp:\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;globval = %d, autoval = %d, regival %d, volaval = %d, statval = %d\n&quot;</span>, globval, autoval, regival, volaval, statval);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    globval = <span class="number">95</span>;</span><br><span class="line">    autoval = <span class="number">96</span>;</span><br><span class="line">    regival = <span class="number">97</span>;</span><br><span class="line">    volaval = <span class="number">98</span>;</span><br><span class="line">    statval = <span class="number">99</span>;</span><br><span class="line">    <span class="built_in">f1</span>(autoval, regival, volaval, statval);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">f1</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j, <span class="keyword">int</span> k, <span class="keyword">int</span> l)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;in f1():\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;globval = %d, autoval = %d, regival %d, volaval = %d, statval = %d\n&quot;</span>, globval, i, j, k, l);</span><br><span class="line">    <span class="built_in">f2</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">f2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">longjmp</span>(jmpbuffer, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// gcc volatile_jmp.c</span></span><br><span class="line"><span class="comment">// gcc -O volatile_jmp.c</span></span><br></pre></td></tr></table></figure>

<pre><code>å…¨å±€å˜é‡, é™æ€å˜é‡, æ˜“å¤±å˜é‡ä¸å—å½±å“
è‡ªåŠ¨å˜é‡å’Œå¯„å­˜å™¨å˜é‡ä¼˜åŒ–å‰åå˜åŒ–
æƒ³è¦ä¸å˜åŒ–, ä½¿ç”¨volatileå˜æˆæ˜“å¤±å˜é‡
</code></pre>
<h3 id="7-11-å‡½æ•°getrlimitå’Œsetrlimit"><a href="#7-11-å‡½æ•°getrlimitå’Œsetrlimit" class="headerlink" title="7.11 å‡½æ•°getrlimitå’Œsetrlimit"></a>7.11 å‡½æ•°getrlimitå’Œsetrlimit</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getrlimit</span><span class="params">(<span class="keyword">int</span> resource, struct rlimit *rlptr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setrlimit</span><span class="params">(<span class="keyword">int</span> resource, <span class="keyword">const</span> struct rlimit *rlptr)</span></span>;</span><br></pre></td></tr></table></figure>

<pre><code>æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ç»„èµ„æºé™åˆ¶, å…¶ä¸­ä¸€äº›å¯ä»¥ç”¨getrlimitå’Œsetrlimitå‡½æ•°æŸ¥è¯¢æˆ–è€…æ›´æ”¹
1. ä»»ä½•ä¸€ä¸ªè¿›ç¨‹éƒ½å¯ä»¥å°†ä¸€ä¸ªè½¯é™åˆ¶æ›´æ”¹ä¸ºå°äºæˆ–è€…ç­‰äºå…¶ç¡¬é™åˆ¶å€¼
2. ä»»ä½•ä¸€ä¸ªè¿›ç¨‹éƒ½å¯ä»¥é™ä½ç¡¬é™åˆ¶å€¼, ä½†æ˜¯å¿…é¡»å¤§äºæˆ–è€…ç­‰äºå…¶è½¯é™åˆ¶å€¼
3. åªæœ‰è¶…çº§ç”¨æˆ·å¯ä»¥æé«˜ç¡¬é™åˆ¶å€¼
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zinego</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">113k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">1:34</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"zinego","repo":"zinego.github.io","client_id":"dea7eb7ad85f46bab6fe","client_secret":"6107f50af24e60f1ed4da39d44c70aa68e21a592","admin_user":"zinego","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"c853ec00cc9d13bc22336b7d45d1416e"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
