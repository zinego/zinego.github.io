<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



















  
  
  
  

  
    
    
  

  
    
      
    

    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
    
    <link href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Noto Serif SC:300,300italic,400,400italic,700,700italic|Noto Serif SC:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="flyfish&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="flyfish&#39;s blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="flyfish&#39;s blog">






  <link rel="canonical" href="http://yoursite.com/page/2/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>flyfish's blog</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title"><i class="fa fa-bookmark-o"></i>&nbsp;flyfish's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>é¦–é¡µ</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>å…³äº</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>æ ‡ç­¾</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>åˆ†ç±»</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>å½’æ¡£</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-schedule">

    
    
    
      
    

    

    <a href="/have-fun.html" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>å…ƒç´ å‘¨æœŸè¡¨</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/13/Ginä¸­HTTPè¯·æ±‚çš„é“¾è·¯è¿½è¸ª/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="flyfish">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="flyfish's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/09/13/Ginä¸­HTTPè¯·æ±‚çš„é“¾è·¯è¿½è¸ª/" class="post-title-link" itemprop="http://yoursite.com/page/2/index.html">Ginä¸­HTTPè¯·æ±‚çš„é“¾è·¯è¿½è¸ª</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-09-13 13:54:39" itemprop="dateCreated datePublished" datetime="2020-09-13T13:54:39+08:00">2020-09-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-09-17 08:58:48" itemprop="dateModified" datetime="2020-09-17T08:58:48+08:00">2020-09-17</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ä¸€-ç›‘å¬"><a href="#ä¸€-ç›‘å¬" class="headerlink" title="ä¸€. ç›‘å¬"></a>ä¸€. ç›‘å¬</h1><p>Ginçš„è‡ªå®šä¹‰ç›‘å¬é€»è¾‘æ¯”è¾ƒç®€å•, åœ¨Golangæ ‡å‡†HTTPåº“ä¸Šå±‚åŸºæœ¬æ²¡æœ‰è¿›è¡Œä»€ä¹ˆå°è£…, ç›´æ¥è°ƒç”¨<code>http.ListenAndServe</code>è¿›è¡Œäº†ç›‘å¬.<br>å¯¹åº”çš„æºç :<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListenAndServe</span><span class="params">(addr <span class="keyword">string</span>, handler Handler)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	server := &amp;Server&#123;Addr: addr, Handler: handler&#125;</span><br><span class="line">	<span class="keyword">return</span> server.ListenAndServe()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *Server)</span> <span class="title">ListenAndServe</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> srv.shuttingDown() &#123;</span><br><span class="line">		<span class="keyword">return</span> ErrServerClosed</span><br><span class="line">	&#125;</span><br><span class="line">	addr := srv.Addr</span><br><span class="line">	<span class="keyword">if</span> addr == <span class="string">""</span> &#123;</span><br><span class="line">		addr = <span class="string">":http"</span></span><br><span class="line">	&#125;</span><br><span class="line">	ln, err := net.Listen(<span class="string">"tcp"</span>, addr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> srv.Serve(ln)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°<code>http.ListenAndServe</code>ä¸»è¦è¿›è¡Œä»¥ä¸‹å·¥ä½œ</p>
<ol>
<li>ç”Ÿæˆç›‘å¬å™¨(Listen)<ul>
<li>è§£æç›‘å¬åœ°å€&amp;ç«¯å£å·</li>
<li>è·å–æ–‡ä»¶æè¿°ç¬¦</li>
</ul>
</li>
<li>æ¥å—è¯·æ±‚(Serve)</li>
</ol>
<h2 id="1-1-ç”Ÿæˆç›‘å¬å™¨-Listen"><a href="#1-1-ç”Ÿæˆç›‘å¬å™¨-Listen" class="headerlink" title="1.1 ç”Ÿæˆç›‘å¬å™¨(Listen)"></a>1.1 ç”Ÿæˆç›‘å¬å™¨(Listen)</h2><blockquote>
<p>å…³é”®ä»£ç : net/sock_posix.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket returns a network file descriptor that is ready for</span></span><br><span class="line"><span class="comment">// asynchronous I/O using the network poller.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">socket</span><span class="params">(ctx context.Context, net <span class="keyword">string</span>, family, sotype, proto <span class="keyword">int</span>, ipv6only <span class="keyword">bool</span>, laddr, raddr sockaddr, ctrlFn <span class="keyword">func</span>(<span class="keyword">string</span>, <span class="keyword">string</span>, syscall.RawConn)</span> <span class="title">error</span>) <span class="params">(fd *netFD, err error)</span></span> &#123;</span><br><span class="line">    s, err := sysSocket(family, sotype, proto)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err = setDefaultSockopts(s, family, sotype, ipv6only); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        poll.CloseFunc(s)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> fd, err = newFD(s, family, sotype, net); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        poll.CloseFunc(s)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> laddr != <span class="literal">nil</span> &amp;&amp; raddr == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> sotype &#123;</span><br><span class="line">        <span class="keyword">case</span> syscall.SOCK_STREAM, syscall.SOCK_SEQPACKET:</span><br><span class="line">            <span class="keyword">if</span> err := fd.listenStream(laddr, listenerBacklog(), ctrlFn); err != <span class="literal">nil</span> &#123; <span class="comment">// æµç›‘å¬å™¨</span></span><br><span class="line">                fd.Close()</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> fd, <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">case</span> syscall.SOCK_DGRAM:</span><br><span class="line">            <span class="keyword">if</span> err := fd.listenDatagram(laddr, ctrlFn); err != <span class="literal">nil</span> &#123; <span class="comment">// æ•°æ®æŠ¥ç›‘å¬å™¨</span></span><br><span class="line">                fd.Close()</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> fd, <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := fd.dial(ctx, laddr, raddr, ctrlFn); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fd.Close()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fd, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>åœ¨è¯¥å‡½æ•°çš„ç¬¬ä¸€éƒ¨åˆ†, è¿›è¡Œäº†ç³»ç»Ÿè°ƒç”¨, åˆ›å»ºäº†ä¸€ä¸ªsocket(å…³äºåˆ›å»ºå¥—æ¥å­—ç­‰å¥—æ¥å­—åŸºç¡€çŸ¥è¯†, å‚è§<a href="https://docs.oracle.com/cd/E19253-01/819-7052/sockets-87164/index.html" target="_blank" rel="noopener">å¥—æ¥å­—åŸºç¡€çŸ¥è¯†</a>), æ­¤æ—¶çš„å‚æ•°åˆ†åˆ«ä¸º: </p>
<ul>
<li>family: AF_INET6 Internet IPv6 å’Œ IPv4 ç³»åˆ—</li>
<li>sotype: syscall.SOCK_STREAM å¯é é¢å‘é“¾æ¥å­—èŠ‚æµ-TCP</li>
<li>proto: ç¼ºçœ0. </li>
</ul>
</blockquote>
<blockquote>
<p>è¯¥å‡½æ•°çš„ç¬¬äºŒéƒ¨åˆ†, å¯¹å¥—æ¥å­—è®¾ç½®äº†é»˜è®¤é€‰é¡¹, æ³¨æ„æ­¤æ—¶ipv6only=false. (å…³äºå¥—æ¥å­—é€‰é¡¹çš„ç›¸å…³çŸ¥è¯†, å‚è§<a href="https://docs.oracle.com/cd/E19253-01/819-7052/sockets-49/index.html" target="_blank" rel="noopener">å¥—æ¥å­—é€‰é¡¹</a>)</p>
</blockquote>
<blockquote>
<p>æ¥ç€åˆ›å»ºäº†ä¸€ä¸ªæµç›‘å¬å™¨, ç‚¹å¼€<code>listenDatagram</code>, å¯ä»¥å‘ç°, åœ¨å‡½æ•°å†…éƒ¨, è¿›è¡Œäº†<code>syscall.Bind</code>çš„ç³»ç»Ÿè°ƒç”¨æ¥ç»‘å®š<a href="https://docs.oracle.com/cd/E19253-01/819-7052/sockets-6/index.html" target="_blank" rel="noopener">æœ¬åœ°åœ°å€</a>, è°ƒç”¨<code>syscall.Listen</code>æ¥è®¾ç½®ç›‘å¬å™¨å…è®¸ç§¯å‹é‡.<br>é€šè¿‡<a href="https://docs.oracle.com/cd/E19253-01/819-7052/sockets-8/index.html" target="_blank" rel="noopener">å»ºç«‹è¿æ¥</a>çš„æ–‡æ¡£â€”â€”<code>è¦æ¥æ”¶å®¢æˆ·æœºçš„è¿æ¥ï¼ŒæœåŠ¡å™¨å¿…é¡»åœ¨ç»‘å®šå…¶å¥—æ¥å­—ä¹‹åæ‰§è¡Œä¸¤ä¸ªæ­¥éª¤ã€‚ç¬¬ä¸€æ­¥æ˜¯è¯´æ˜å¯ä»¥æ’é˜Ÿå¤šå°‘è¿æ¥è¯·æ±‚ã€‚ç¬¬äºŒæ­¥æ¥å—è¿æ¥ã€‚</code><br>æˆ‘ä»¬å¯ä»¥å‘ç°ä¸€ä¸ªç–‘é—®, åœ¨socketå‡½æ•°ä¸­, ä»…ä»…è¿›è¡Œäº†ç¬¬ä¸€æ­¥æ“ä½œ, ä¹Ÿå°±æ˜¯è°ƒç”¨<code>syscall.Listen</code>æ¥è¯´æ˜å¯ä»¥æ’é˜Ÿå¤šå°‘è¿æ¥è¯·æ±‚, ä½†å¹¶æ²¡æœ‰è°ƒç”¨<code>syscall.Accept</code>æ¥æ¥å—è¿æ¥. å¾ˆç®€å•, æ¥å—è¿æ¥çš„ç³»ç»Ÿè°ƒç”¨åœ¨ä¸‹ä¸€éƒ¨åˆ†: <code>æ¥æ”¶è¯·æ±‚</code>.</p>
</blockquote>
<blockquote>
<p>é‚£ä¹ˆè¯¥å‡½æ•°çš„æœ€åä¸€éƒ¨åˆ†, fd.dialä¸»è¦åšäº†ä»€ä¹ˆå·¥ä½œå‘¢? å®é™…ä¸Šsocketå‡½æ•°ä¸ä»…ç”¨äºæœåŠ¡ç«¯ç›‘å¬, ä¹Ÿç”¨äºå®¢æˆ·ç«¯ä¸»åŠ¨å»ºç«‹è¿æ¥. å½“æœåŠ¡ç«¯è¿›è¡Œç›‘å¬æ—¶, èµ°fd.listenxxxxxçš„é€»è¾‘, è€Œæ¥ç€å°±ç›´æ¥é€€å‡ºè¯¥å‡½æ•°. å½“å®¢æˆ·ç«¯ç›‘å¬æ—¶, ç›´æ¥è¿›å…¥fd.dialçš„é€»è¾‘, è¿›å…¥è¯¥å‡½æ•°, ä¹Ÿå¯ä»¥çœ‹åˆ°, å†…éƒ¨è¿›è¡Œäº†<code>syscall.Connect</code>çš„ç³»ç»Ÿè°ƒç”¨. </p>
</blockquote>
<h2 id="1-2-æ¥å—è¯·æ±‚-Serve"><a href="#1-2-æ¥å—è¯·æ±‚-Serve" class="headerlink" title="1.2 æ¥å—è¯·æ±‚(Serve)"></a>1.2 æ¥å—è¯·æ±‚(Serve)</h2><p>é¦–å…ˆæ¥çœ‹ä¸€çœ‹æ³¨é‡Š</p>
<pre><code>// Serve accepts incoming connections on the Listener l, creating a
// new service goroutine for each. The service goroutines read requests and
// then call srv.Handler to reply to them.
// 
// Serveé€šè¿‡ç›‘å¬å™¨læ¥æ¥æ”¶è¿›æ¥çš„è¯·æ±‚, å¹¶ä¸ºæ¯ä¸€ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªåç¨‹. è¯¥åç¨‹è¯»å–è¯·æ±‚, ç„¶åè°ƒç”¨srv.Handlerè¿›è¡Œå“åº”
</code></pre><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *Server)</span> <span class="title">Serve</span><span class="params">(l net.Listener)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">	baseCtx := context.Background()</span><br><span class="line">	<span class="keyword">if</span> srv.BaseContext != <span class="literal">nil</span> &#123;</span><br><span class="line">		baseCtx = srv.BaseContext(origListener)</span><br><span class="line">		<span class="keyword">if</span> baseCtx == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(<span class="string">"BaseContext returned a nil context"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx := context.WithValue(baseCtx, ServerContextKey, srv)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		rw, e := l.Accept()</span><br><span class="line">		<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">			...</span><br><span class="line">			<span class="keyword">return</span> e</span><br><span class="line">		&#125;</span><br><span class="line">		connCtx := ctx</span><br><span class="line">		<span class="keyword">if</span> cc := srv.ConnContext; cc != <span class="literal">nil</span> &#123;</span><br><span class="line">			connCtx = cc(connCtx, rw)</span><br><span class="line">			<span class="keyword">if</span> connCtx == <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="built_in">panic</span>(<span class="string">"ConnContext returned nil"</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		tempDelay = <span class="number">0</span></span><br><span class="line">		c := srv.newConn(rw)</span><br><span class="line">		c.setState(c.rwc, StateNew) <span class="comment">// before Serve can return</span></span><br><span class="line">		<span class="keyword">go</span> c.serve(connCtx)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°, åœ¨è¿™ä¸ªå‡½æ•°ä¸­, é€šè¿‡å¾ªç¯å»ä¸æ–­çš„æ¥å—è¿æ¥, åœ¨æ›´åº•å±‚çš„åœ°æ–¹, <code>l.Accept()</code>ä¹Ÿè¿›è¡Œäº†å»ºç«‹è¿æ¥(<code>syscall.Accept</code>)çš„ç³»ç»Ÿè°ƒç”¨, å¹¶å°†socketè®¾ç½®ä¸ºéé˜»å¡å‹IO, è¿”å›çš„rwä¸ºä¸€ä¸ªTCPè¿æ¥<code>TCPConn</code>, æ¥ç€æ–°å¯åŠ¨ä¸€ä¸ªåç¨‹æ¥å¤„ç†è¯¥é“¾æ¥, ç„¶åå¼€å§‹ç­‰å¾…ä¸‹ä¸€æ¬¡<code>æ–°è¿æ¥</code>çš„åˆ°æ¥. æ¥ç€çœ‹ä¸€ä¸‹Golangå¦‚ä½•å¤„ç†ä¸€ä¸ªé“¾æ¥</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Serve a new connection.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *conn)</span> <span class="title">serve</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	c.remoteAddr = c.rwc.RemoteAddr().String()</span><br><span class="line">	ctx = context.WithValue(ctx, LocalAddrContextKey, c.rwc.LocalAddr())</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &amp;&amp; err != ErrAbortHandler &#123;</span><br><span class="line">			<span class="keyword">const</span> size = <span class="number">64</span> &lt;&lt; <span class="number">10</span></span><br><span class="line">			buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, size)</span><br><span class="line">			buf = buf[:runtime.Stack(buf, <span class="literal">false</span>)]</span><br><span class="line">			c.server.logf(<span class="string">"http: panic serving %v: %v\n%s"</span>, c.remoteAddr, err, buf)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> !c.hijacked() &#123;</span><br><span class="line">			c.<span class="built_in">close</span>()</span><br><span class="line">			c.setState(c.rwc, StateClosed)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// tls å¤„ç†é€»è¾‘...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// HTTP/1.x from here on.</span></span><br><span class="line"></span><br><span class="line">	ctx, cancelCtx := context.WithCancel(ctx)</span><br><span class="line">	c.cancelCtx = cancelCtx</span><br><span class="line">	<span class="keyword">defer</span> cancelCtx()</span><br><span class="line"></span><br><span class="line">	c.r = &amp;connReader&#123;conn: c&#125;</span><br><span class="line">	c.bufr = newBufioReader(c.r)</span><br><span class="line">	c.bufw = newBufioWriterSize(checkConnErrorWriter&#123;c&#125;, <span class="number">4</span>&lt;&lt;<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		w, err := c.readRequest(ctx)</span><br><span class="line">		<span class="keyword">if</span> c.r.remain != c.server.initialReadLimitSize() &#123;</span><br><span class="line">			<span class="comment">// If we read any bytes off the wire, we're active.</span></span><br><span class="line">			c.setState(c.rwc, StateActive)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Expect 100 Continue support</span></span><br><span class="line">		req := w.req</span><br><span class="line">		<span class="keyword">if</span> req.expectsContinue() &#123;</span><br><span class="line">			<span class="keyword">if</span> req.ProtoAtLeast(<span class="number">1</span>, <span class="number">1</span>) &amp;&amp; req.ContentLength != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="comment">// Wrap the Body reader with one that replies on the connection</span></span><br><span class="line">				req.Body = &amp;expectContinueReader&#123;readCloser: req.Body, resp: w&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> req.Header.get(<span class="string">"Expect"</span>) != <span class="string">""</span> &#123;</span><br><span class="line">			w.sendExpectationFailed()</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		c.curReq.Store(w)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> requestBodyRemains(req.Body) &#123;</span><br><span class="line">			registerOnHitEOF(req.Body, w.conn.r.startBackgroundRead)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			w.conn.r.startBackgroundRead()</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		serverHandler&#123;c.server&#125;.ServeHTTP(w, w.req)</span><br><span class="line">		w.cancelCtx()</span><br><span class="line">		<span class="keyword">if</span> c.hijacked() &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		w.finishRequest()</span><br><span class="line">		<span class="keyword">if</span> !w.shouldReuseConnection() &#123;</span><br><span class="line">			<span class="keyword">if</span> w.requestBodyLimitHit || w.closedRequestBodyEarly() &#123;</span><br><span class="line">				c.closeWriteAndWait()</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		c.setState(c.rwc, StateIdle)</span><br><span class="line">		c.curReq.Store((*response)(<span class="literal">nil</span>))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> !w.conn.server.doKeepAlives() &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> d := c.server.idleTimeout(); d != <span class="number">0</span> &#123;</span><br><span class="line">			c.rwc.SetReadDeadline(time.Now().Add(d))</span><br><span class="line">			<span class="keyword">if</span> _, err := c.bufr.Peek(<span class="number">4</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		c.rwc.SetReadDeadline(time.Time&#123;&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>åœ¨è¿™æ®µä»£ç ä¸­, æœ‰å¾ªç¯è¯»å–é“¾æ¥çš„é€»è¾‘. ä¸€å¼€å§‹è¿˜æœ‰äº›ç–‘é—®, Golangä¸æ˜¯æ¯æ¬¡è¯·æ±‚éƒ½ä¼šæœ‰ä¸€ä¸ªåç¨‹å¤„ç†å—? åæ¥æŸ¥äº†æŸ¥, å‘ç°æ˜¯HTTPçš„é•¿è¿æ¥. ç¡®åˆ‡çš„è¯´, å¹¶ä¸æ˜¯æ¯æ¬¡è¯·æ±‚éƒ½æœ‰ä¸€ä¸ªæ–°çš„åç¨‹å»å¤„ç†, è€Œæ˜¯æ¯æ¬¡æ–°çš„é“¾æ¥éƒ½æœ‰ä¸€ä¸ªæ–°çš„åç¨‹å¤„ç†. è€Œå¯¹äºHTTPé•¿è¿æ¥æ¥è¯´, å¤šæ¬¡è¯·æ±‚ç”±åŒä¸€ä¸ªåç¨‹å»å¤„ç†. ç„¶åå°±æœ‰äº†ä¸€æ¬¡è¿·ç³Šçš„è¿‡ç¨‹: </p>
</blockquote>
<h3 id="1-2-1-ä¸€æ¬¡çŠ¯è¿·ç³Šçš„éªŒè¯è¿‡ç¨‹"><a href="#1-2-1-ä¸€æ¬¡çŠ¯è¿·ç³Šçš„éªŒè¯è¿‡ç¨‹" class="headerlink" title="1.2.1 ä¸€æ¬¡çŠ¯è¿·ç³Šçš„éªŒè¯è¿‡ç¨‹"></a>1.2.1 ä¸€æ¬¡çŠ¯è¿·ç³Šçš„éªŒè¯è¿‡ç¨‹</h3><blockquote>
<p><img src="/2020/09/13/Ginä¸­HTTPè¯·æ±‚çš„é“¾è·¯è¿½è¸ª/1.png" alt="image.png"><br>å› ä¸ºæ˜¯HTTPé•¿è¿æ¥, æ‰€ä»¥å°±æƒ³éªŒè¯ä¸‹, ç„¶åæˆ‘ç”¨äº†Postmanæ¥è¯·æ±‚, ç”¨Golandæ¥æ‰“æ–­ç‚¹debug, å‘ç°æ¯æ¬¡å¤„ç†å®Œè¯·æ±‚, éƒ½ä¼šé˜»å¡åœ¨1817è¡Œçš„readRequesté‚£é‡Œ, æ­¤æ—¶ç›¸å½“äºç­‰å¾…è¯¥é“¾æ¥çš„ä¸‹ä¸€æ¬¡è¯·æ±‚.<br>åæ¥æˆ‘æ¢äº†curlæ¥è¯·æ±‚, ç„¶åå‘ç°å¤„ç†å®Œè¿™ä¸€æ¬¡è¯·æ±‚ä¹‹å, ä¾æ—§æ˜¯1817è¡Œä½†æ˜¯æ²¡æœ‰é˜»å¡, è¿”å›äº†EOFçš„err, </p>
</blockquote>
<h1 id="è¯·æ±‚é“¾è·¯"><a href="#è¯·æ±‚é“¾è·¯" class="headerlink" title="è¯·æ±‚é“¾è·¯"></a>è¯·æ±‚é“¾è·¯</h1><h1 id="å“åº”é“¾è·¯"><a href="#å“åº”é“¾è·¯" class="headerlink" title="å“åº”é“¾è·¯"></a>å“åº”é“¾è·¯</h1>
          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/07/Golangå¹¶å‘æ¨¡å‹/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="flyfish">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="flyfish's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/09/07/Golangå¹¶å‘æ¨¡å‹/" class="post-title-link" itemprop="http://yoursite.com/page/2/index.html">Golangå¹¶å‘æ¨¡å‹</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-09-07 22:51:45" itemprop="dateCreated datePublished" datetime="2020-09-07T22:51:45+08:00">2020-09-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-10-27 09:22:52" itemprop="dateModified" datetime="2020-10-27T09:22:52+08:00">2020-10-27</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Do not communicate by sharing memory; instead, share memory by communicating.</p>
</blockquote>
<h2 id="ä¸€-Channelåº•å±‚åŸç†"><a href="#ä¸€-Channelåº•å±‚åŸç†" class="headerlink" title="ä¸€. Channelåº•å±‚åŸç†"></a>ä¸€. Channelåº•å±‚åŸç†</h2><h2 id="äºŒ-Golangçš„GPMæ¨¡å‹"><a href="#äºŒ-Golangçš„GPMæ¨¡å‹" class="headerlink" title="äºŒ. Golangçš„GPMæ¨¡å‹"></a>äºŒ. Golangçš„GPMæ¨¡å‹</h2><ol>
<li>G: goroutine, </li>
<li>M: å†…æ ¸çº¿ç¨‹</li>
<li>P: ä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿçš„å¤„ç†å™¨(Processor), å®ƒç»´æŠ¤ä¸€ä¸ªRunnableçš„<code>g</code>é˜Ÿåˆ—, Méœ€è¦è·å¾—Pæ‰èƒ½è¿è¡ŒG</li>
</ol>
<h3 id="2-1-ä¸ºä»€ä¹ˆéœ€è¦P"><a href="#2-1-ä¸ºä»€ä¹ˆéœ€è¦P" class="headerlink" title="2.1 ä¸ºä»€ä¹ˆéœ€è¦P"></a>2.1 ä¸ºä»€ä¹ˆéœ€è¦P</h3><p>åœ¨Goçš„æ—©æœŸç‰ˆæœ¬, å¹¶æ²¡æœ‰Pè¿™ä¸ªç»“æ„, Méœ€è¦ä»ä¸€ä¸ªå…¨å±€çš„é˜Ÿåˆ—ä¸­è·å¾—å¯è¿è¡Œçš„goroutine, å› æ­¤éœ€è¦ä¸€ä¸ªå…¨å±€çš„é”. å½“å¹¶å‘é‡å¤§çš„æ—¶å€™, é”å°±æˆäº†ç“¶é¢ˆ. é‚£ä¹ˆä¸ºä»€ä¹ˆä¸ç›´æ¥å°†runqueueæ”¾å…¥Mä¸­?</p>
<blockquote>
<p>You might wonder now, why have contexts at all? Canâ€™t we just put the runqueues on the threads and get rid of contexts? Not really. The reason we have contexts is so that we can hand them off to other threads if the running thread needs to block for some reason.<br>An example of when we need to block, is when we call into a syscall. Since a thread cannot both be executing code and be blocked on a syscall, we need to hand off the context so it can keep scheduling.</p>
</blockquote>
<p>å³: å½“ä¸€ä¸ªçº¿ç¨‹è¢«é˜»å¡, å¯ä»¥å°†è¯¥çº¿ç¨‹ç­‰å¾…çš„å¯è¿è¡Œçš„Gè½¬ç§»åˆ°å…¶ä»–ç©ºé—²çš„Mä¸Šé¢<br>å¦å¤–, Go scheduler ä¼šå¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹ sysmonï¼Œç”¨æ¥æ£€æµ‹é•¿æ—¶é—´ï¼ˆè¶…è¿‡ 10 msï¼‰è¿è¡Œçš„ goroutineï¼Œå°†å…¶è°ƒåº¦åˆ° global runqueues. è¿™æ˜¯ä¸€ä¸ªå…¨å±€çš„ runqueueï¼Œä¼˜å…ˆçº§æ¯”è¾ƒä½.</p>
<h2 id="last-å…¶ä»–æ¦‚å¿µ"><a href="#last-å…¶ä»–æ¦‚å¿µ" class="headerlink" title="last. å…¶ä»–æ¦‚å¿µ"></a>last. å…¶ä»–æ¦‚å¿µ</h2><ol>
<li>è¶…çº¿ç¨‹: å¤šçº¿ç¨‹å¤„ç†å™¨å†…éƒ¨çš„ä¸¤ä¸ªé€»è¾‘å†…æ ¸æ¨¡æ‹Ÿæˆä¸¤ä¸ªç‰©ç†èŠ¯ç‰‡ï¼Œè®©å•ä¸ªå¤„ç†å™¨å°±èƒ½ä½¿ç”¨çº¿ç¨‹çº§çš„å¹¶è¡Œè®¡ç®—ï¼Œè¿›è€Œå…¼å®¹å¤šçº¿ç¨‹æ“ä½œç³»ç»Ÿå’Œè½¯ä»¶. </li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/13/åŸºäºFFmpegçš„è§†é¢‘æ°´å°å¤„ç†æ–¹æ¡ˆ/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="flyfish">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="flyfish's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/06/13/åŸºäºFFmpegçš„è§†é¢‘æ°´å°å¤„ç†æ–¹æ¡ˆ/" class="post-title-link" itemprop="http://yoursite.com/page/2/index.html">åŸºäºFFmpegçš„è§†é¢‘æ°´å°å¤„ç†æ–¹æ¡ˆ</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-06-13 16:13:04 / ä¿®æ”¹æ—¶é—´ï¼š20:41:48" itemprop="dateCreated datePublished" datetime="2020-06-13T16:13:04+08:00">2020-06-13</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/è§†é¢‘å¤„ç†/" itemprop="url" rel="index"><span itemprop="name">è§†é¢‘å¤„ç†</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ä¸€-èƒŒæ™¯"><a href="#ä¸€-èƒŒæ™¯" class="headerlink" title="ä¸€. èƒŒæ™¯"></a>ä¸€. èƒŒæ™¯</h2><blockquote>
<p>å› æ”¿ç­–éœ€è¦, äº”æœˆåº•æ”¶åˆ°äº†ä¸€ä¸ªåº”æ€¥è§†é¢‘æ°´å°çš„éœ€æ±‚, éœ€è¦å¯¹ä¸‹æ¸¸ç”Ÿäº§å‡ºæ¥çš„è§†é¢‘åœ¨è½¬ç ä¹‹å‰è¿›è¡ŒåŠ æ°´å°çš„å¤„ç†, æ¥å¯¹è§†é¢‘çš„<strong>ä¸åŒç‰‡æ®µ</strong>è¿›è¡Œæ ‡è®°</p>
</blockquote>
<h2 id="äºŒ-æ‰€éœ€å·¥å…·"><a href="#äºŒ-æ‰€éœ€å·¥å…·" class="headerlink" title="äºŒ. æ‰€éœ€å·¥å…·"></a>äºŒ. æ‰€éœ€å·¥å…·</h2><h3 id="1-FFmpeg"><a href="#1-FFmpeg" class="headerlink" title="1. FFmpeg"></a>1. FFmpeg</h3><blockquote>
<p>FFmpegæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯<a href="https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz" target="_blank" rel="noopener">ffmpeg v4.2.3-static</a>, æ–°ç‰ˆæœ¬çš„FFmpegè‡ªå¸¦åŠ æ°´å°åŠŸèƒ½, è€ç‰ˆæœ¬çš„å¯èƒ½éœ€è¦è‡ªå·±ç¼–è¯‘</p>
</blockquote>
<h3 id="2-Linuxå­—ä½“æ”¯æŒ"><a href="#2-Linuxå­—ä½“æ”¯æŒ" class="headerlink" title="2. Linuxå­—ä½“æ”¯æŒ"></a>2. Linuxå­—ä½“æ”¯æŒ</h3><ol>
<li>å®‰è£…fontconfig <code>yum install fontconfig</code>,</li>
<li>å°†å­—ä½“æ–‡ä»¶æ”¾å…¥<code>/usr/share/fonts/chinese</code>ç›®å½•ä¸­</li>
<li>æ‰§è¡Œ<code>fc-list :lang=zh</code>å°±å¯ä»¥çœ‹åˆ°å®‰è£…å¥½çš„å­—ä½“æ–‡ä»¶</li>
</ol>
<h3 id="3-ass-srt-å­—å¹•æ–‡ä»¶"><a href="#3-ass-srt-å­—å¹•æ–‡ä»¶" class="headerlink" title="3. ass(srt)å­—å¹•æ–‡ä»¶"></a>3. ass(srt)å­—å¹•æ–‡ä»¶</h3><h2 id="ä¸‰-FFmpegåŠ æ°´å°è§£å†³æ–¹æ¡ˆ"><a href="#ä¸‰-FFmpegåŠ æ°´å°è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ä¸‰. FFmpegåŠ æ°´å°è§£å†³æ–¹æ¡ˆ"></a>ä¸‰. FFmpegåŠ æ°´å°è§£å†³æ–¹æ¡ˆ</h2><h3 id="1-åŠ å›¾ç‰‡æ°´å°"><a href="#1-åŠ å›¾ç‰‡æ°´å°" class="headerlink" title="1. åŠ å›¾ç‰‡æ°´å°"></a>1. åŠ å›¾ç‰‡æ°´å°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i origin.mp4 -i watermark.png -filter_complex <span class="string">"overlay=x=main_w-overlay_w:y=main_h-overlay_h"</span> pic_watermark.mp4</span><br></pre></td></tr></table></figure>
<p>æ°´å°çš„ä½ç½®ç”±å¦‚ä¸‹å…­ä¸ªå‚æ•°æ¥ç•Œå®š.<br>å›¾ç‰‡æ°´å°çš„ä¼˜ç‚¹æ˜¯æ°´å°çš„æ ¼å¼(å­—ä½“,é¢œè‰²,é€æ˜åº¦ç­‰)å¯ä»¥ç”±UIè€å¸ˆæå‰ç”Ÿæˆ, ä¸ç”¨æ‰§è¡Œå‘½ä»¤æ—¶å»æ§åˆ¶<br>ä½†æ˜¯è¿™ç§æ°´å°æ–¹å¼åŠ å‡ºæ¥éƒ½æ˜¯æ•´ä¸ªè§†é¢‘éƒ½åŠ ä¸Šäº†æ°´å°, å¦‚æœæƒ³è¦æ§åˆ¶æŸä¸ªæ—¶é—´åŒºé—´å»åŠ æ°´å°, ä¸å¤ªå¥½æ§åˆ¶. è¿™æ ·ä¹Ÿå°±æ— æ³•æ»¡è¶³æœ¬æ¬¡éœ€æ±‚, pass. </p>
<ul>
<li>main_hä¸ºè¾“å…¥è§†é¢‘çš„é«˜åº¦, </li>
<li>main_wä¸ºè¾“å…¥è§†é¢‘çš„å®½åº¦, </li>
<li>overlay_hä¸ºä¼ å…¥å›¾ç‰‡çš„é«˜åº¦, </li>
<li>overlay_wä¸ºä¼ å…¥å›¾ç‰‡çš„å®½åº¦,</li>
<li>xä¸ºæ°´å°å·¦è¾¹ç•Œä¸è§†é¢‘å·¦è¾¹ç•Œçš„è·ç¦»</li>
<li>yä¸ºæ°´å°ä¸Šè¾¹ç•Œä¸è§†é¢‘ä¸Šè¾¹ç•Œçš„è·ç¦»</li>
</ul>
<p>åŠ å®Œæ°´å°çš„æ•ˆæœå¦‚ä¸‹å›¾<br><img src="/2020/06/13/åŸºäºFFmpegçš„è§†é¢‘æ°´å°å¤„ç†æ–¹æ¡ˆ/pic_watermark.png" alt="image.png"></p>
<h3 id="2-åŠ å­—å¹•æ°´å°-srt"><a href="#2-åŠ å­—å¹•æ°´å°-srt" class="headerlink" title="2. åŠ å­—å¹•æ°´å°[srt]"></a>2. åŠ å­—å¹•æ°´å°[srt]</h3><blockquote>
<p>å›¾ç‰‡æ°´å°æ— æ³•æ»¡è¶³éœ€æ±‚, æˆ‘ä»¬å†å¯»æ‰¾å…¶ä»–è§£å†³æ–¹æ¡ˆçš„æ—¶å€™å‘ç°<strong>ç»™è§†é¢‘å¤šä¸ªæ—¶é—´åŒºé—´åŠ æ°´å°</strong>ä¸<strong>ç”µå½±å­—å¹•</strong>æ¯”è¾ƒç±»ä¼¼, äºæ˜¯å¼€å§‹å¯»æ‰¾ç»™è§†é¢‘åŠ å­—å¹•çš„è§£å†³æ–¹æ¡ˆ. </p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i origin.mp4 -vf subtitles=watermark.srt srt_watermark.mp4</span><br></pre></td></tr></table></figure>
<p>å­—å¹•å†…å®¹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">00:00:16,266 --&gt; 00:01:00,359</span><br><span class="line">FFMPEG</span><br><span class="line"></span><br><span class="line">2</span><br><span class="line">00:01:16,266 --&gt; 00:10:25,359</span><br><span class="line">FFMPEG</span><br></pre></td></tr></table></figure></p>
<p>åŠ å‡ºæ¥çš„æ•ˆæœå¦‚ä¸‹å›¾, è¿™ç§æ–¹å¼å¯ä»¥è§£å†³æŒ‰æ—¶é—´åŒºé—´åŠ æ°´å°çš„éœ€æ±‚, ä½†æ˜¯æ— æ³•æŒ‡å®šå­—å¹•æ ¼å¼, æ— æ³•æŒ‡å®šå­—å¹•ä½ç½®, å°±æ˜¯å•çº¯çš„ç”µå½±å­—å¹•(è‡³å°‘æˆ‘æ²¡æ‰¾åˆ°ğŸ¤¦â€â™‚ï¸). è¿™ç§æ–¹å¼ä¹Ÿæ— æ³•æ»¡è¶³éœ€æ±‚, pass.<br><img src="/2020/06/13/åŸºäºFFmpegçš„è§†é¢‘æ°´å°å¤„ç†æ–¹æ¡ˆ/srt.png" alt="image.png"></p>
<h3 id="3-åŠ å­—å¹•æ°´å°-ass"><a href="#3-åŠ å­—å¹•æ°´å°-ass" class="headerlink" title="3. åŠ å­—å¹•æ°´å°[ass]"></a>3. åŠ å­—å¹•æ°´å°[ass]</h3><p>asså­—å¹•æ–‡ä»¶åŠ æ°´å°å¯ä»¥å®šåˆ¶å¾ˆå¤šä¸ªæ€§åŒ–çš„ä¸œè¥¿, è¯ä¸å¤šè¯´, ä¸Šå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i origin.mp4 -vf <span class="string">"ass=watermark.ass"</span> ass_watermark.mp4</span><br></pre></td></tr></table></figure>
<p>å­—å¹•æ–‡ä»¶å†…å®¹ä¸º:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[Script Info]</span><br><span class="line">Title: YYeTs</span><br><span class="line">Original Script: YYeTs</span><br><span class="line">Original Translation:</span><br><span class="line">Original Timing:</span><br><span class="line">Original Editing:</span><br><span class="line">Script Updated By:</span><br><span class="line">Update Details:</span><br><span class="line">ScriptType: v4.00+</span><br><span class="line">PlayResX: 384</span><br><span class="line">PlayResY: 288</span><br><span class="line">Timer: 100.0000</span><br><span class="line">Synch Point: 0</span><br><span class="line">WrapStyle: 0</span><br><span class="line">ScaledBorderAndShadow: no</span><br><span class="line"></span><br><span class="line">[Aegisub Project Garbage]</span><br><span class="line">Scroll Position: 483</span><br><span class="line">Active Line: 441</span><br><span class="line"></span><br><span class="line">[V4+ Styles]</span><br><span class="line">Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding</span><br><span class="line">Style: Default,HanziPen TC,24,&amp;H00FFFFFF,&amp;H00FFFFFF,&amp;H00FFFFFF,&amp;H00FFFFFF,0,0,0,0,100,100,0,0,1,0,1,3,5,10,10,134</span><br><span class="line"></span><br><span class="line">[Events]</span><br><span class="line">Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text</span><br><span class="line">Dialogue: 0,0:00:00.12,0:10:34.29,Default,NTP,0,0,0,,&#123;\alpha&amp;H72&amp;&#125;å¤§é±¼æµ·æ£ </span><br></pre></td></tr></table></figure></p>
<p>Asså­—å¹•æ–‡ä»¶æ¯”è¾ƒå¤æ‚, åæ­£æˆ‘æ˜¯è‡ªå·±æ‰‹å†™ä¸å‡ºæ¥, è¿™æ˜¯æˆ‘åœ¨ç½‘ä¸Šä¸‹è½½äº†ä¸€ä¸ªassæ–‡ä»¶, è‡ªå·±æ”¹äº†ä¸€äº›å‚æ•°çš„æœ€ç»ˆæ ·å­.<br>å…¶ä¸­ç¬¬ä¸€éƒ¨åˆ†<code>[Script Info]</code>å’Œç¬¬äºŒéƒ¨åˆ†<code>[Aegisub Project Garbage]</code>çš„æ„ä¹‰è¿™é‡Œä¸å…³æ³¨,<br>ç¬¬ä¸‰éƒ¨åˆ†<code>[V4+ Styles]</code>åŒ…å«äº†æ‰€æœ‰æ ·å¼çš„å®šä¹‰, <code>Format</code>è¡Œä¸<code>Style</code>è¡Œ ä¸ºé”®å€¼å¯¹, Formatä¸ºKey, Styleä¸ºValue, å¯ä»¥å®šä¹‰å¤šä¸ªStyle, æ ¹æ®Style.NameåŒºåˆ†.<br>ç¬¬å››éƒ¨åˆ†<code>[Events]</code>ä¸­, ä¾æ—§æ˜¯Formatä¸ºKey, Dialogueä¸ºæ¯ä¸ªæ—¶é—´åŒºé—´, å­—å¹•çš„å„ç§å‚æ•°, åŒ…æ‹¬èµ·æ­¢æ—¶é—´, æ ·å¼, ä»¥åŠæ–‡æ¡ˆ.<br>å…¶ä¸­ä¸€äº›Format.Keyçš„æ„ä¹‰å¦‚ä¸‹</p>
<ul>
<li>Name: æ ·å¼çš„åå­—</li>
<li>Fontname: å­—ä½“, ä¸­æ–‡å­—ä½“åœ¨Linuxå¯ä»¥é€šè¿‡fc-listæ‰¾åˆ°å¯¹åº”çš„è‹±æ–‡å</li>
<li>Fontsize: å­—ä½“å¤§å°</li>
<li>PrimaryColour: å­—å¹•é¢œè‰²</li>
<li>BackColour: å­—ä½“é˜´å½±é¢œè‰²</li>
<li>Bold: æ˜¯å¦åŠ ç²—</li>
<li>Italic: æ˜¯å¦æ–œä½“</li>
<li>Underline: æ˜¯å¦ä¸‹åˆ’çº¿</li>
<li>StrikeOut: æ˜¯å¦åˆ é™¤çº¿</li>
<li>ScaleX: ä¿®æ”¹å­—ä½“çš„å®½åº¦</li>
<li>ScaleY: ä¿®æ”¹å­—ä½“çš„é«˜åº¦</li>
<li>Spacing: å­—ç¬¦ä¹‹é—´é¢å¤–çš„é—´éš™</li>
<li>BorderStyle: è¾¹æ¡†çš„æ ·å¼ã€‚1 ä¸ºè¾¹æ¡† + é˜´å½±ï¼Œ3 ä¸ºä¸é€æ˜èƒŒæ™¯ã€‚</li>
<li>Outline: å¦‚æœ BorderStyle ä¸º 1ï¼Œå®ƒå®šä¹‰äº†æ–‡å­—è¾¹æ¡†çš„åƒç´ å®½åº¦ã€‚</li>
<li>Alignment: å­—å¹•ä½ç½®: 1,2,3 =&gt; å·¦ä¸‹, ä¸­ä¸‹, å³ä¸‹, 4,5,6 =&gt; å·¦ä¸­, ä¸­ä¸­, å³ä¸­, 7,8,9=&gt; å·¦ä¸Š, ä¸­ä¸Š, å³ä¸Š</li>
<li>MarginL: åˆ°å±å¹•å·¦è¾¹ç¼˜çš„è·ç¦»</li>
<li>MarginR: åˆ°å±å¹•å³è¾¹ç¼˜çš„è·ç¦»</li>
<li>MarginV: å±å¹•å‚ç›´è·ç¦», å¦‚æœæ˜¯åº•éƒ¨å­—å¹•, åˆ™æ˜¯å±å¹•åº•éƒ¨çš„è·ç¦»</li>
<li>Encoding: å®šä¹‰å­—ä½“çš„å­—ç¬¦é›†æˆ–ç¼–ç æ–¹å¼=&gt;0 ä¸ºè‹±æ–‡ï¼Œ134 ä¸ºç®€ä½“ä¸­æ–‡ï¼Œ136 ä¸ºç¹ä½“ä¸­æ–‡</li>
<li>æ ·å¼è¦†å†™ä»£ç : æ ·å¼ç›´æ¥æŒ‡å®šé€æ˜åº¦è¯•äº†å¾ˆå¤šæ¬¡éƒ½ä¸æˆåŠŸ, åªå¥½ä½¿ç”¨æ ·å¼è¦†å†™ä»£ç æ¥æ»¡è¶³é€æ˜åº¦çš„éœ€æ±‚. {\alpha&amp;H72&amp;}ä¸ºæ ·å¼è¦†å†™ä»£ç , å¯ä»¥é‡ç½®æ ·å¼, alphaæŒ‡å®šé€æ˜åº¦, 72/256=28% , å¤§æ¦‚28%çš„é€æ˜åº¦</li>
</ul>
<p>æ°´å°æ•ˆæœå¦‚ä¸‹, ç”¨çš„Macè‡ªå¸¦çš„<code>ç¿©ç¿©ä½“-ç®€</code>, å³ä¸‹, åº•éƒ¨10, å³å±å¹•10<br><img src="/2020/06/13/åŸºäºFFmpegçš„è§†é¢‘æ°´å°å¤„ç†æ–¹æ¡ˆ/ass.png" alt="image.png"></p>
<h2 id="å››-å‚è€ƒèµ„æ–™"><a href="#å››-å‚è€ƒèµ„æ–™" class="headerlink" title="å››. å‚è€ƒèµ„æ–™"></a>å››. å‚è€ƒèµ„æ–™</h2><ol>
<li><a href="https://moejj.com/ffmpeg-add-subtitles-and-watermark/" target="_blank" rel="noopener">ffmpegåŒæ—¶æ·»åŠ æ°´å°å’Œå­—å¹•ï¼Œè¯¦ç»†æ•™ç¨‹</a></li>
<li><a href="https://github.com/weizhenye/ASS/wiki/ASS-%E5%AD%97%E5%B9%95%E6%A0%BC%E5%BC%8F%E8%A7%84%E8%8C%83" target="_blank" rel="noopener">ASS å­—å¹•æ ¼å¼è§„èŒƒ</a></li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/Golangå¸¸è§é”™è¯¯/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="flyfish">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="flyfish's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/05/26/Golangå¸¸è§é”™è¯¯/" class="post-title-link" itemprop="http://yoursite.com/page/2/index.html">Golangå¸¸è§é”™è¯¯</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-05-26 00:30:51" itemprop="dateCreated datePublished" datetime="2020-05-26T00:30:51+08:00">2020-05-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-05-29 23:41:22" itemprop="dateModified" datetime="2020-05-29T23:41:22+08:00">2020-05-29</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-å˜é•¿interfaceå‚æ•°"><a href="#1-å˜é•¿interfaceå‚æ•°" class="headerlink" title="1. å˜é•¿interfaceå‚æ•°"></a>1. å˜é•¿interfaceå‚æ•°</h3><p>å˜é•¿interfaceä¼ å‚, ä¼ å…¥çš„æ•°ç»„å¦‚æœä¸åŠ <code>...</code>, å¯èƒ½ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªinterface, è€Œä¸ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªinterfaceæ•°ç»„. ä¾‹å¦‚:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calLen</span><span class="params">(src ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="built_in">len</span>(src), src)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test1</span><span class="params">(src ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	calLen(src)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test2</span><span class="params">(src ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	calLen(src...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	calLen(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">	test1(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">	test2(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 3 [1 2 3]</span></span><br><span class="line"><span class="comment">// 1 [[1 2 3]]</span></span><br><span class="line"><span class="comment">// 3 [1 2 3]</span></span><br></pre></td></tr></table></figure>
<h3 id="2-å¾ªç¯åˆå§‹åŒ–-å…¶å®ä¸ç®—å¸¸è§-ç®—è®¾è®¡çš„æ¯”è¾ƒå·®"><a href="#2-å¾ªç¯åˆå§‹åŒ–-å…¶å®ä¸ç®—å¸¸è§-ç®—è®¾è®¡çš„æ¯”è¾ƒå·®" class="headerlink" title="2. å¾ªç¯åˆå§‹åŒ–(å…¶å®ä¸ç®—å¸¸è§, ç®—è®¾è®¡çš„æ¯”è¾ƒå·®)"></a>2. å¾ªç¯åˆå§‹åŒ–(å…¶å®ä¸ç®—å¸¸è§, ç®—è®¾è®¡çš„æ¯”è¾ƒå·®)</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"log"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyStruct <span class="keyword">struct</span> &#123;</span><br><span class="line">	call <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	<span class="title">a</span>    <span class="title">int</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">var</span> <span class="title">myStruct</span> = <span class="title">MyStruct</span></span>&#123;a: <span class="number">1</span>, call: callFunction&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">callFunction</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"...."</span>, myStruct.a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°†ç¼–è¯‘æœŸçš„åˆå§‹åŒ–, æ”¹ä¸ºè¿è¡Œæ—¶çš„åˆå§‹åŒ–(initå‡½æ•°)å³å¯è§£å†³é—®é¢˜:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"log"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyStruct <span class="keyword">struct</span> &#123;</span><br><span class="line">	call <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	<span class="title">a</span>    <span class="title">int</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	myStruct.call = callFunction</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> myStruct = MyStruct&#123;a: <span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">callFunction</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">"...."</span>, myStruct.a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	myStruct.call()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/25/å€¼æ–¹æ³•è¿˜æ˜¯å¼•ç”¨æ–¹æ³•/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="flyfish">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="flyfish's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/05/25/å€¼æ–¹æ³•è¿˜æ˜¯å¼•ç”¨æ–¹æ³•/" class="post-title-link" itemprop="http://yoursite.com/page/2/index.html">å€¼æ–¹æ³•è¿˜æ˜¯å¼•ç”¨æ–¹æ³•</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-05-25 22:28:53" itemprop="dateCreated datePublished" datetime="2020-05-25T22:28:53+08:00">2020-05-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-05-26 00:30:54" itemprop="dateModified" datetime="2020-05-26T00:30:54+08:00">2020-05-26</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æ–‡ç« æ•´ç†è‡ª<strong><a href="https://www.qtmuniao.com/2020/01/06/go-value-pointer-method/" target="_blank" rel="noopener">Muniaoâ€™s blog</a></strong>, çº¯å±è‡ªè¡Œç¬”è®°</p>
<h2 id="1-åŒºåˆ«"><a href="#1-åŒºåˆ«" class="headerlink" title="1. åŒºåˆ«"></a>1. åŒºåˆ«</h2><p>å…³äºä¸¤è€…çš„åŒºåˆ«, åœ¨å®˜æ–¹ <a href="https://golang.org/doc/effective_go.html#pointers_vs_values" target="_blank" rel="noopener">effective go</a> æ–‡æ¡£ä¸­ï¼Œå¯¹ä¸¤è€…åŒºåˆ«å…¶å®æ˜¯æœ‰ç²¾ç¡®æè¿°çš„ï¼š</p>
<blockquote>
<p>The rule about pointers vs. values for receivers is that value methods can be invoked on pointers and values, but pointer methods can only be invoked on pointers.</p>
</blockquote>
<blockquote>
<p>There is a handy exception, though. When the value is addressable, the language takes care of the common case of invoking a pointer method on a value by inserting the address operator automatically.</p>
</blockquote>
<p>å¤§æ„å¦‚ä¸‹ï¼š</p>
<ol>
<li>å€¼æ–¹æ³•ï¼ˆvalue methodsï¼‰å¯ä»¥é€šè¿‡æŒ‡é’ˆå’Œå€¼è°ƒç”¨ï¼Œä½†æ˜¯æŒ‡é’ˆæ–¹æ³•ï¼ˆpointer methodsï¼‰åªèƒ½é€šè¿‡æŒ‡é’ˆæ¥è°ƒç”¨ã€‚</li>
<li>ä½†æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œå¦‚æœæŸä¸ªå€¼æ˜¯å¯å¯»å€çš„ï¼ˆaddressableï¼Œæˆ–è€…è¯´å·¦å€¼ï¼‰ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šåœ¨å€¼è°ƒç”¨æŒ‡é’ˆæ–¹æ³•æ—¶è‡ªåŠ¨æ’å…¥å–åœ°å€ç¬¦ï¼Œä½¿å¾—åœ¨æ­¤æƒ…å½¢ä¸‹çœ‹èµ·æ¥åƒæŒ‡é’ˆæ–¹æ³•ä¹Ÿå¯ä»¥é€šè¿‡å€¼æ¥è°ƒç”¨ã€‚</li>
</ol>
<h2 id="2-å–èˆ"><a href="#2-å–èˆ" class="headerlink" title="2. å–èˆ"></a>2. å–èˆ</h2><p>åœ¨å®šä¹‰ receiver ä¸ºå€¼è¿˜æ˜¯æŒ‡é’ˆæ—¶ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªè€ƒè™‘ç‚¹ï¼š</p>
<ol>
<li><strong>æ–¹æ³•æ˜¯å¦éœ€è¦ä¿®æ”¹ receiver æœ¬èº«ã€‚</strong> å¦‚æœéœ€è¦ï¼Œé‚£ receiver å¿…ç„¶è¦æ˜¯æŒ‡é’ˆäº†ã€‚</li>
<li><strong>æ•ˆç‡é—®é¢˜ã€‚</strong> å¦‚æœ receiver æ˜¯å€¼ï¼Œé‚£åœ¨æ–¹æ³•è°ƒç”¨æ—¶ä¸€å®šä¼šäº§ç”Ÿ struct æ‹·è´ï¼Œè€Œå¤§å¯¹è±¡æ‹·è´ä»£ä»·å¾ˆå¤§å“¦ã€‚</li>
<li><strong>ä¸€è‡´æ€§ã€‚</strong> å¯¹äºåŒä¸€ä¸ª struct çš„æ–¹æ³•ï¼Œvalue method å’Œ pointer method æ··æ‚ç”¨è‚¯å®šæ˜¯ä¸ä¼˜é›…çš„å•¦ã€‚</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/06/Redisæºç -è·³è·ƒè¡¨skipList/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="flyfish">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="flyfish's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/06/Redisæºç -è·³è·ƒè¡¨skipList/" class="post-title-link" itemprop="http://yoursite.com/page/2/index.html">Redisæºç -è·³è·ƒè¡¨skipList</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-03-06 19:35:17 / ä¿®æ”¹æ—¶é—´ï¼š19:39:38" itemprop="dateCreated datePublished" datetime="2019-03-06T19:35:17+08:00">2019-03-06</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Cè¯­è¨€/" itemprop="url" rel="index"><span itemprop="name">Cè¯­è¨€</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="è·³è·ƒè¡¨"><a href="#è·³è·ƒè¡¨" class="headerlink" title="è·³è·ƒè¡¨"></a>è·³è·ƒè¡¨</h2><h3 id="1-å†…å­˜åˆ†å¸ƒ"><a href="#1-å†…å­˜åˆ†å¸ƒ" class="headerlink" title="1. å†…å­˜åˆ†å¸ƒ"></a>1. å†…å­˜åˆ†å¸ƒ</h3><p><img src="/2019/03/06/Redisæºç -è·³è·ƒè¡¨skipList/./skiplist.png" alt="Alt text"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></span><br><span class="line">    sds ele;                            <span class="comment">// å…ƒç´ </span></span><br><span class="line">    <span class="keyword">double</span> score;                       <span class="comment">// èŠ‚ç‚¹çš„åˆ†æ•°, æ®æ­¤æ’å…¥æ—¶å¯¹èŠ‚ç‚¹è¿›è¡Œæ’åº</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span>     <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span>             <span class="comment">// å­ç»“æ„, å•å±‚</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span>  <span class="comment">// å½“å‰å±‚ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> span;             <span class="comment">// å½“å‰å±‚è·ç¦»ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»</span></span><br><span class="line">    &#125; level[];                          <span class="comment">// å¤šä¸ªå±‚, å…¶ä¸­, å¤´èŠ‚ç‚¹æœ‰64å±‚</span></span><br><span class="line">&#125; zskiplistNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">header</span>, *<span class="title">tail</span>;</span>  <span class="comment">// å¤´å°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> length;                 <span class="comment">// èŠ‚ç‚¹ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">int</span> level;                            <span class="comment">// å±‚æ•°æœ€å¤šçš„èŠ‚ç‚¹çš„å±‚æ•°</span></span><br><span class="line">&#125; zskiplist;</span><br></pre></td></tr></table></figure>
<pre><code>å¤´èŠ‚ç‚¹ä¸è¿›è¡Œå­˜å‚¨
</code></pre><h3 id="2-è·³è·ƒè¡¨çš„level"><a href="#2-è·³è·ƒè¡¨çš„level" class="headerlink" title="2. è·³è·ƒè¡¨çš„level"></a>2. è·³è·ƒè¡¨çš„level</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">zslRandomLevel</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> level = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 0xFFFF = 1111111111111111</span></span><br><span class="line"><span class="comment">     * 0xFFFF * 0.25 = 0011111111111111 </span></span><br><span class="line"><span class="comment">     * ä¹Ÿå°±æ˜¯æœ€é«˜ä¸¤ä½æœ‰æŸä½æ˜¯1çš„è¯, level+1, æ¦‚ç‡æ˜¯1/4</span></span><br><span class="line"><span class="comment">     * levelçš„æ•°å­¦æœŸæœ›æ˜¯4/3, æ»¡è¶³å‡ ä½•åˆ†å¸ƒ</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">while</span> ((random() &amp; <span class="number">0xFFFF</span>) &lt; (ZSKIPLIST_P * <span class="number">0xFFFF</span>))</span><br><span class="line">        level += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> (level &lt; ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>levelç”±ä»¥ä¸Šä»£ç ç”Ÿæˆ, æ¯æ¬¡level+1çš„æ¦‚ç‡æ˜¯1/4, å‡ºç°3/4çš„æ¦‚ç‡åœæ­¢å¾ªç¯, æ­¤æ—¶æ»¡è¶³å‡ ä½•åˆ†å¸ƒ, 
levelå€¼çš„æœŸæœ›æ˜¯1/(3/4) = 4 / 3
</code></pre><h3 id="3-è·³è·ƒè¡¨çš„æŸ¥æ‰¾"><a href="#3-è·³è·ƒè¡¨çš„æŸ¥æ‰¾" class="headerlink" title="3. è·³è·ƒè¡¨çš„æŸ¥æ‰¾"></a>3. è·³è·ƒè¡¨çš„æŸ¥æ‰¾</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = zsl-&gt;level - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</span><br><span class="line">           (x-&gt;level[i].forward-&gt;score &lt; curscore ||</span><br><span class="line">            (x-&gt;level[i].forward-&gt;score == curscore &amp;&amp;</span><br><span class="line">             sdscmp(x-&gt;level[i].forward-&gt;ele, ele) &lt; <span class="number">0</span>))) &#123;</span><br><span class="line">        x = x-&gt;level[i].forward;</span><br><span class="line">    &#125;</span><br><span class="line">    update[i] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>ç±»ä¼¼çš„ä»£ç åœ¨è·³è·ƒè¡¨æºç ä¸­å‡ºç°å¾ˆå¤šæ¬¡, æŸ¥æ‰¾çš„æ–¹å¼å¾ˆå·§å¦™.
é¦–å…ˆè·³è·ƒè¡¨çš„åˆ—ä¸åˆ—ä¹‹é—´æ˜¯ä»å°åˆ°å¤§çš„, æ¯ä¸€åˆ—æœ‰ç›¸åŒçš„score
æŸ¥æ‰¾æ—¶ä»é«˜levelæ¥è¿›è¡ŒæŸ¥æ‰¾, è¶…å‡ºscoreå¤§å°åˆ™è¿›è¡Œæ›´ä½levelçš„æŸ¥è¯¢, æ­¤æ—¶ä¼šä»é«˜å±‚è·³è·ƒåˆ°ä½å±‚
levelçš„æœŸæœ›å€¼ä¸º4/3. 
</code></pre><h3 id="4-æ’å…¥è·³è·ƒè¡¨"><a href="#4-æ’å…¥è·³è·ƒè¡¨" class="headerlink" title="4. æ’å…¥è·³è·ƒè¡¨"></a>4. æ’å…¥è·³è·ƒè¡¨</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Insert a new node in the skiplist. Assumes the element does not already</span></span><br><span class="line"><span class="comment"> * exist (up to the caller to enforce that). The skiplist takes ownership</span></span><br><span class="line"><span class="comment"> * of the passed SDS string 'ele'. */</span></span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslInsert</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, sds ele)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * update[i]è¡¨ç¤º ç¬¬iå±‚æ–°æ’å…¥çš„èŠ‚ç‚¹åº”è¯¥æ’å…¥åˆ°åœ¨update[i]åé¢</span></span><br><span class="line"><span class="comment">     * rankä»£è¡¨ç€update[i]ç‚¹ä¸headä¹‹é—´çš„è·ç¦»æ€»å’Œ</span></span><br><span class="line"><span class="comment">     * spanä»£è¡¨ç€å½“å‰levelä¸‹, å½“å‰èŠ‚ç‚¹ä¸ä¸‹ä¸€èŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> rank[ZSKIPLIST_MAXLEVEL];</span><br><span class="line">    <span class="keyword">int</span> i, level;</span><br><span class="line"></span><br><span class="line">    serverAssert(!isnan(score));</span><br><span class="line">    x = zsl-&gt;header;</span><br><span class="line">    <span class="keyword">for</span> (i = zsl-&gt;level - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">/* store rank that is crossed to reach the insert position */</span></span><br><span class="line">        rank[i] = i == (zsl-&gt;level - <span class="number">1</span>) ? <span class="number">0</span> : rank[i + <span class="number">1</span>];</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å½“x-&gt;level[i]æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹, ä¸”ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å€¼å°äºå½“å‰èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         * å…³äºå°äº:</span></span><br><span class="line"><span class="comment">         * 1. ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å€¼å°äºè¦æ’å…¥çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         * 2. ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å€¼ç­‰äºè¦æ’å…¥çš„èŠ‚ç‚¹, ä¸”ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å­—ç¬¦ä¸²å­—å…¸åºå°äºè¦æ’å…¥çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</span><br><span class="line">               (x-&gt;level[i].forward-&gt;score &lt; score ||</span><br><span class="line">                (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</span><br><span class="line">                 sdscmp(x-&gt;level[i].forward-&gt;ele, ele) &lt; <span class="number">0</span>))) &#123;</span><br><span class="line">            <span class="comment">// æ³¨æ„æ˜¯å…ˆåŠ åè¿­ä»£</span></span><br><span class="line">            rank[i] += x-&gt;level[i].span;</span><br><span class="line">            x = x-&gt;level[i].forward;</span><br><span class="line">        &#125;</span><br><span class="line">        update[i] = x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* we assume the element is not already inside, since we allow duplicated</span></span><br><span class="line"><span class="comment">     * scores, reinserting the same element should never happen since the</span></span><br><span class="line"><span class="comment">     * caller of zslInsert() should test in the hash table if the element is</span></span><br><span class="line"><span class="comment">     * already inside or not. */</span></span><br><span class="line">    level = zslRandomLevel();</span><br><span class="line">    <span class="keyword">if</span> (level &gt; zsl-&gt;level) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = zsl-&gt;level; i &lt; level; i++) &#123;</span><br><span class="line">            rank[i] = <span class="number">0</span>;</span><br><span class="line">            update[i] = zsl-&gt;header;</span><br><span class="line">            update[i]-&gt;level[i].span = zsl-&gt;length;</span><br><span class="line">        &#125;</span><br><span class="line">        zsl-&gt;level = level;</span><br><span class="line">    &#125;</span><br><span class="line">    x = zslCreateNode(level, score, ele);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; level; i++) &#123;</span><br><span class="line">        x-&gt;level[i].forward = update[i]-&gt;level[i].forward;</span><br><span class="line">        update[i]-&gt;level[i].forward = x;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* update span covered by update[i] as x is inserted here */</span></span><br><span class="line">        x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[<span class="number">0</span>] - rank[i]);</span><br><span class="line">        update[i]-&gt;level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* increment span for untouched levels */</span></span><br><span class="line">    <span class="keyword">for</span> (i = level; i &lt; zsl-&gt;level; i++) &#123;</span><br><span class="line">        update[i]-&gt;level[i].span++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿›æ˜¯å¤šæ­¥è¿›, é€€æ˜¯å•æ­¥é€€</span></span><br><span class="line">    x-&gt;backward = (update[<span class="number">0</span>] == zsl-&gt;header) ? <span class="literal">NULL</span> : update[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward)</span><br><span class="line">        x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        zsl-&gt;tail = x;</span><br><span class="line">    zsl-&gt;length++;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2019/03/06/Redisæºç -è·³è·ƒè¡¨skipList/./1.png" alt="Alt text"><br><img src="/2019/03/06/Redisæºç -è·³è·ƒè¡¨skipList/./2.png" alt="Alt text"></p>
<pre><code>æ’å…¥æ—¶å€™é¦–å…ˆæŸ¥è¯¢åˆ°è¯¥æ’å…¥çš„ä½ç½®, å®é™…ä¸Šæ˜¯ä¸€åˆ—.
ç„¶åè·å–éšæœºçš„level
è¿›è¡ŒèŠ‚ç‚¹çš„æ’å…¥. æ›´æ–°æ¯ä¸€å±‚çš„spanå€¼. 
å…¶ä¸­, å¯¹line54, line55è¡Œçš„è§£é‡Šå¦‚ä¸‹:
å¯¹æ¯”ç¬¬ä¸€å¼ å›¾, åœ¨åˆ—4å’Œåˆ—5ä¹‹é—´æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹, ä»–çš„level=5, æ’å…¥ä¹‹åçš„ç»“æœä¸ºç¬¬äºŒå¼ å›¾, æ–°æ’å…¥çš„æ•°æ®åœ¨ç¬¬äº”åˆ—
é‚£ä¹ˆåœ¨ç¬¬ä¸€ç« å›¾ä¸­, rank[0]=1+1+1+1=4; rank[3]=2+1=3,node[3]-&gt;level[3].span=2
é‚£ä¹ˆæ’å…¥ä¹‹å, x-&gt;level[3].span=update[3]-&gt;level[3].span-(rank[0]-rank[3])=2-(2-1)=1
è§ç¬¬äºŒå¼ å›¾. 
update[3]-&gt;level[3].span=(rank[0]-rank[3])+1=2
ä¸çŸ¥é“æ€ä¹ˆè¯´çš„æ›´æ¸…æ¥š, æˆ‘ä¹Ÿçœ‹äº†å¾ˆä¹…, è§£é‡Šå¦‚æ­¤, è‡ªå·±æ‚Ÿ...
</code></pre><h3 id="5-æ›´æ–°æŸèŠ‚ç‚¹"><a href="#5-æ›´æ–°æŸèŠ‚ç‚¹" class="headerlink" title="5. æ›´æ–°æŸèŠ‚ç‚¹"></a>5. æ›´æ–°æŸèŠ‚ç‚¹</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Update the score of an elmenent inside the sorted set skiplist.</span></span><br><span class="line"><span class="comment"> * Note that the element must exist and must match 'score'.</span></span><br><span class="line"><span class="comment"> * This function does not update the score in the hash table side, the</span></span><br><span class="line"><span class="comment"> * caller should take care of it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that this function attempts to just update the node, in case after</span></span><br><span class="line"><span class="comment"> * the score update, the node would be exactly at the same position.</span></span><br><span class="line"><span class="comment"> * Otherwise the skiplist is modified by removing and re-adding a new</span></span><br><span class="line"><span class="comment"> * element, which is more costly.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The function returns the updated element skiplist node pointer. */</span></span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslUpdateScore</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> curscore, sds ele, <span class="keyword">double</span> newscore)</span> </span>&#123;</span><br><span class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We need to seek to element to update to start: this is useful anyway,</span></span><br><span class="line"><span class="comment">     * we'll have to update or remove it. */</span></span><br><span class="line">    x = zsl-&gt;header;</span><br><span class="line">    <span class="keyword">for</span> (i = zsl-&gt;level - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</span><br><span class="line">               (x-&gt;level[i].forward-&gt;score &lt; curscore ||</span><br><span class="line">                (x-&gt;level[i].forward-&gt;score == curscore &amp;&amp;</span><br><span class="line">                 sdscmp(x-&gt;level[i].forward-&gt;ele, ele) &lt; <span class="number">0</span>))) &#123;</span><br><span class="line">            x = x-&gt;level[i].forward;</span><br><span class="line">        &#125;</span><br><span class="line">        update[i] = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Jump to our element: note that this function assumes that the</span></span><br><span class="line"><span class="comment">     * element with the matching score exists. */</span></span><br><span class="line">    x = x-&gt;level[<span class="number">0</span>].forward;</span><br><span class="line">    serverAssert(x &amp;&amp; curscore == x-&gt;score &amp;&amp; sdscmp(x-&gt;ele, ele) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the node, after the score update, would be still exactly</span></span><br><span class="line"><span class="comment">     * at the same position, we can just update the score without</span></span><br><span class="line"><span class="comment">     * actually removing and re-inserting the element in the skiplist. */</span></span><br><span class="line">    <span class="keyword">if</span> ((x-&gt;backward == <span class="literal">NULL</span> || x-&gt;backward-&gt;score &lt; newscore) &amp;&amp;</span><br><span class="line">        (x-&gt;level[<span class="number">0</span>].forward == <span class="literal">NULL</span> || x-&gt;level[<span class="number">0</span>].forward-&gt;score &gt; newscore)) &#123;</span><br><span class="line">        x-&gt;score = newscore;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* No way to reuse the old node: we need to remove and insert a new</span></span><br><span class="line"><span class="comment">     * one at a different place. */</span></span><br><span class="line">    zslDeleteNode(zsl, x, update);</span><br><span class="line">    zskiplistNode *newnode = zslInsert(zsl, newscore, x-&gt;ele);</span><br><span class="line">    <span class="comment">/* We reused the old node x-&gt;ele SDS string, free the node now</span></span><br><span class="line"><span class="comment">     * since zslInsert created a new one. */</span></span><br><span class="line">    x-&gt;ele = <span class="literal">NULL</span>;</span><br><span class="line">    zslFreeNode(x);</span><br><span class="line">    <span class="keyword">return</span> newnode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>æ›´æ–°èŠ‚ç‚¹scoreæ—¶, å› ä¸ºscoreæ›´æ–°ä¹‹å, ä¸ºäº†ä¿è¯é¡ºåºæ€§, éœ€è¦å¯¹åˆ—è¿›è¡Œè°ƒæ•´, ä¸å¦‚ç›´æ¥åˆ é™¤èŠ‚ç‚¹, 
ç„¶ååœ¨åˆé€‚ä½ç½®æ·»åŠ æ–°çš„åˆ—
</code></pre>
          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/05/Redisæºç -å­—å…¸dict/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="flyfish">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="flyfish's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/05/Redisæºç -å­—å…¸dict/" class="post-title-link" itemprop="http://yoursite.com/page/2/index.html">Redisæºç -å­—å…¸dict</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-03-05 11:56:29 / ä¿®æ”¹æ—¶é—´ï¼š15:33:14" itemprop="dateCreated datePublished" datetime="2019-03-05T11:56:29+08:00">2019-03-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Cè¯­è¨€/" itemprop="url" rel="index"><span itemprop="name">Cè¯­è¨€</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="å­—å…¸-å“ˆå¸Œè¡¨"><a href="#å­—å…¸-å“ˆå¸Œè¡¨" class="headerlink" title="å­—å…¸/å“ˆå¸Œè¡¨"></a>å­—å…¸/å“ˆå¸Œè¡¨</h2><h3 id="1-å†…å­˜å¸ƒå±€"><a href="#1-å†…å­˜å¸ƒå±€" class="headerlink" title="1. å†…å­˜å¸ƒå±€"></a>1. å†…å­˜å¸ƒå±€</h3><p><img src="/2019/03/05/Redisæºç -å­—å…¸dict/./dict.png" alt="Alt text"></p>
<p><strong>è¯¥å›¾æ–°æ ‡ç­¾é¡µæ‰“å¼€çœ‹</strong></p>
<h4 id="1-1-dict"><a href="#1-1-dict" class="headerlink" title="1.1 dict"></a>1.1 dict</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dict</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></span><br><span class="line">    dictType *type;          <span class="comment">// type</span></span><br><span class="line">    <span class="keyword">void</span> *privdata;          <span class="comment">// paivate data</span></span><br><span class="line">    dictht ht[<span class="number">2</span>];            <span class="comment">// hash table</span></span><br><span class="line">    <span class="keyword">long</span> rehashidx;          <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> iterators; <span class="comment">/* number of iterators currently running */</span></span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure>
<pre><code>å…¶ä¸­typeæŒ‡å‘dictType, ä»£è¡¨ç€ä¸åŒç±»å‹çš„è¯å…¸. 
privdata ç§æœ‰æ•°æ®, ä½†æ˜¯æˆ‘æš‚æ—¶æ²¡æ˜ç™½æ˜¯ä»€ä¹ˆæ„æ€.
æ¯ä¸ªè¯å…¸æœ‰ä¸¤ä¸ªhashè¡¨, ä¸€ä¸ªç”¨äºæ­£å¸¸ä½¿ç”¨, ä¸€ä¸ªç”¨äºrehash
rehashidxå¯¹åº”rehashæ—¶åŸhashè¡¨çš„rehashçš„ä¸‹æ ‡, éšç€rehashçš„è¿›è¡Œ, rehashidxç§»åŠ¨
iteratorså¯¹åº”è¿­ä»£å™¨
</code></pre><h4 id="1-2-dictht"><a href="#1-2-dictht" class="headerlink" title="1.2 dictht"></a>1.2 dictht</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hash table </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span> &#123;</span></span><br><span class="line">    dictEntry **table;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> used;</span><br><span class="line">&#125; dictht;</span><br></pre></td></tr></table></figure>
<pre><code>æ¯ä¸ªhashè¡¨åŒ…å«ä¸€ä¸ªæ•°ç»„, æ¯ä¸ªæ•°ç»„çš„å…ƒç´ æŒ‡å‘ä¸€ä¸ªé“¾è¡¨, hash çš„æ—¶å€™, å°†key hashæˆi,
é‚£ä¹ˆè¯¥å…ƒç´ å°±ä¼šè¢«æ·»åŠ åˆ°ht[0][i]åé¢.
sizeæŒ‡çš„æ˜¯hashè¡¨ä¸­æ•°ç»„å…ƒç´ çš„ä¸ªæ•°
sizemask=size-1 , å› ä¸ºå…ƒç´ çš„ä¸‹æ ‡æ˜¯ä»0~size-1çš„
usedä»£è¡¨å·²ç»å ç”¨çš„æ¡¶çš„ä¸ªæ•°(æ¡¶=æ•°ç»„å…ƒç´ , æ•°ç»„å…ƒç´ å¯ä»¥çœ‹æˆæ˜¯æ¡¶çš„å…¥å£)
</code></pre><h4 id="1-3-dictType"><a href="#1-3-dictType" class="headerlink" title="1.3 dictType"></a>1.3 dictType</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hashè¡¨çš„ç±»å‹, å¯¹äºä¸åŒçš„ç±»å‹, å®ç°çš„æ–¹æ³•ä¸åŒ </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictType</span> &#123;</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * this is a pointer named 'keyDup', it point to a function,</span></span><br><span class="line"><span class="comment">     * and that function's return type is void*, parameters are two pointers */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> (*hashFunction)(<span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj);</span><br><span class="line">    <span class="keyword">int</span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);</span><br><span class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj);</span><br><span class="line">&#125; dictType;</span><br></pre></td></tr></table></figure>
<pre><code>hashè¡¨çš„ç±»å‹, 
å…¶ä¸­`uint64_t (*hashFunction)(const void *key);`ç±»ä¼¼äºè¿™ç§ç»“æ„, ä»£è¡¨ç€: 
hashFunctionæ˜¯ä¸€ä¸ªæŒ‡é’ˆ, æŒ‡å‘ä¸€ä¸ªå‡½æ•°, è¯¥å‡½æ•°ä»¥uint64_tç±»å‹ä¸ºè¿”å›å€¼, å‚æ•°æ˜¯`const void *key`
</code></pre><h4 id="1-4-dictEntry"><a href="#1-4-dictEntry" class="headerlink" title="1.4 dictEntry"></a>1.4 dictEntry</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hash è¡¨ä¸­å•ä¸ªç»“æ„</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *key;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> *val;     <span class="comment">//type val(string, struct)</span></span><br><span class="line">        <span class="keyword">uint64_t</span> u64;  <span class="comment">//type unsigned 64</span></span><br><span class="line">        <span class="keyword">int64_t</span> s64;   <span class="comment">//type signed 64</span></span><br><span class="line">        <span class="keyword">double</span> d;      <span class="comment">// type double</span></span><br><span class="line">    &#125; v;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; dictEntry;</span><br></pre></td></tr></table></figure>
<pre><code>ä¸€ä¸ªhashå…ƒç´ 
key = key
v æ˜¯unionç±»å‹, å¯ä»¥å®¹çº³å„ç§ç±»å‹çš„å€¼
nextå¦‚ä¸Šå›¾
</code></pre><h3 id="2-hash"><a href="#2-hash" class="headerlink" title="2. hash"></a>2. hash</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * d -&gt; å­—å…¸</span></span><br><span class="line"><span class="comment"> * key -&gt; é”®</span></span><br><span class="line"><span class="comment"> * hash -&gt; è¢«hashçš„key</span></span><br><span class="line"><span class="comment"> * existing -&gt; è¿”å›å­˜åœ¨çš„entry</span></span><br><span class="line"><span class="comment"> * å¦‚æœå·²ç»å­˜åœ¨, è¿”å›-1 </span></span><br><span class="line"><span class="comment"> * å¦‚æœä¸å­˜åœ¨, è¿”å›å¯ä»¥è¢«hashçš„ä¸€ä¸ªæ¡¶çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">long</span> _dictKeyIndex(dict *d, <span class="keyword">const</span> <span class="keyword">void</span> *key, <span class="keyword">uint64_t</span> hash, dictEntry **existing) &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> idx, table;</span><br><span class="line">    dictEntry *he;</span><br><span class="line">    <span class="keyword">if</span> (existing) *existing = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Expand the hash table if needed */</span></span><br><span class="line">    <span class="keyword">if</span> (_dictExpandIfNeeded(d) == DICT_ERR)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (table = <span class="number">0</span>; table &lt;= <span class="number">1</span>; table++) &#123;</span><br><span class="line">        idx = hash &amp; d-&gt;ht[table].sizemask;</span><br><span class="line">        <span class="comment">/* Search if this slot does not already contain the given key */</span></span><br><span class="line">        he = d-&gt;ht[table].table[idx];</span><br><span class="line">        <span class="keyword">while</span> (he) &#123;</span><br><span class="line">            <span class="keyword">if</span> (key == he-&gt;key || dictCompareKeys(d, key, he-&gt;key)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (existing) *existing = he;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            he = he-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å¦‚æœæ²¡æœ‰æ­£åœ¨è¢«rehash, é‚£ä¹ˆç›´æ¥é€€å‡º, æ­¤æ—¶æ‰¾åˆ°äº†ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„idx,</span></span><br><span class="line"><span class="comment">         * å¦‚æœæ­£åœ¨è¢«rehash, é‚£ä¹ˆåˆ°ht[1]ä¸­å¯»æ‰¾, æ‰¾ä¸åˆ°çš„è¯, è¿”å›ä¸€ä¸ªht[1]ä¸­å¯ä»¥ä½¿ç”¨çš„idx,</span></span><br><span class="line"><span class="comment">         * ä¿è¯äº†ä¸ä¼šæ–°å¢çš„æ•°æ®ä¸ä¼šè¢«hashåˆ°ht[0]ä¸­</span></span><br><span class="line"><span class="comment">         **/</span></span><br><span class="line">        <span class="keyword">if</span> (!dictIsRehashing(d)) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> idx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¦‚æœkeyå·²ç»å­˜åœ¨, è¿”å›NULL, è€Œä¸”å¦‚æœexistingéç©º, å®ƒä¼šè¢«å¡«å……ä¸ºå·²ç»å­˜åœ¨çš„entry, </span></span><br><span class="line"><span class="comment"> * å¦‚æœkeyè¢«æ·»åŠ , è¿”å›è¢«æ·»åŠ çš„hash entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">dictEntry *<span class="title">dictAddRaw</span><span class="params">(dict *d, <span class="keyword">void</span> *key, dictEntry **existing)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> index;</span><br><span class="line">    dictEntry *entry;</span><br><span class="line">    dictht *ht;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dictIsRehashing(d)) _dictRehashStep(d);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Get the index of the new element, or -1 if</span></span><br><span class="line"><span class="comment">     * the element already exists. */</span></span><br><span class="line">    <span class="keyword">if</span> ((index = _dictKeyIndex(d, key, dictHashKey(d, key), existing)) == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate the memory and store the new entry.</span></span><br><span class="line"><span class="comment">     * Insert the element in top, with the assumption that in a database</span></span><br><span class="line"><span class="comment">     * system it is more likely that recently added entries are accessed</span></span><br><span class="line"><span class="comment">     * more frequently. */</span></span><br><span class="line">    ht = dictIsRehashing(d) ? &amp;d-&gt;ht[<span class="number">1</span>] : &amp;d-&gt;ht[<span class="number">0</span>];</span><br><span class="line">    entry = zmalloc(<span class="keyword">sizeof</span>(*entry));</span><br><span class="line">    entry-&gt;next = ht-&gt;table[index];</span><br><span class="line">    ht-&gt;table[index] = entry;</span><br><span class="line">    ht-&gt;used++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the hash entry fields. */</span></span><br><span class="line">    dictSetKey(d, entry, key);</span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>å…³äºhash , ä¸åŒç±»å‹è°ƒç”¨çš„æ˜¯ä¸åŒçš„hashæ–¹æ³•(è§dictType)
å­—ç¬¦ä¸²ç±»å‹, è°ƒç”¨çš„æ˜¯siphash, å…³äºè¿™ç§hashæ–¹æ³•, æˆ‘ä¹Ÿæ²¡çœ‹æ‡‚... 
å…³äºå­˜å‚¨, ä¸€ä¸ªkeyè¢«hashæˆintç±»å‹çš„å€¼h,
h&amp;sizemaskè·å¾—ä¸€ä¸ªå¯ä»¥å­˜å‚¨åœ¨hashtableä¸­çš„ä¸€ä¸ªæ¡¶çš„ä¸‹æ ‡.
ç„¶åå¼€è¾Ÿç©ºé—´, èµ‹å€¼, å°†entryæ·»åŠ åˆ°æ¡¶çš„èµ·å§‹ä½ç½®
</code></pre><h3 id="3-rehash"><a href="#3-rehash" class="headerlink" title="3. rehash"></a>3. rehash</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictRehash</span><span class="params">(dict *d, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> empty_visits = n * <span class="number">10</span>; <span class="comment">/* Max number of empty buckets to visit. */</span></span><br><span class="line">    <span class="keyword">if</span> (!dictIsRehashing(d)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (n-- &amp;&amp; d-&gt;ht[<span class="number">0</span>].used != <span class="number">0</span>) &#123;</span><br><span class="line">        dictEntry *de, *nextde;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Note that rehashidx can't overflow as we are sure there are more</span></span><br><span class="line"><span class="comment">         * elements because ht[0].used != 0 */</span></span><br><span class="line">        assert(d-&gt;ht[<span class="number">0</span>].size &gt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>)d-&gt;rehashidx);</span><br><span class="line">        <span class="keyword">while</span> (d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            d-&gt;rehashidx++;</span><br><span class="line">            <span class="keyword">if</span> (--empty_visits == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        de = d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx];</span><br><span class="line">        <span class="comment">/* Move all the keys in this bucket from the old to the new hash HT */</span></span><br><span class="line">        <span class="keyword">while</span> (de) &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> h;</span><br><span class="line"></span><br><span class="line">            nextde = de-&gt;next;</span><br><span class="line">            <span class="comment">/* Get the index in the new hash table */</span></span><br><span class="line">            h = dictHashKey(d, de-&gt;key) &amp; d-&gt;ht[<span class="number">1</span>].sizemask;</span><br><span class="line">            de-&gt;next = d-&gt;ht[<span class="number">1</span>].table[h];</span><br><span class="line">            d-&gt;ht[<span class="number">1</span>].table[h] = de;</span><br><span class="line">            d-&gt;ht[<span class="number">0</span>].used--;</span><br><span class="line">            d-&gt;ht[<span class="number">1</span>].used++;</span><br><span class="line">            de = nextde;</span><br><span class="line">        &#125;</span><br><span class="line">        d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx] = <span class="literal">NULL</span>;</span><br><span class="line">        d-&gt;rehashidx++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if we already rehashed the whole table... */</span></span><br><span class="line">    <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].used == <span class="number">0</span>) &#123;</span><br><span class="line">        zfree(d-&gt;ht[<span class="number">0</span>].table);</span><br><span class="line">        d-&gt;ht[<span class="number">0</span>] = d-&gt;ht[<span class="number">1</span>];</span><br><span class="line">        _dictReset(&amp;d-&gt;ht[<span class="number">1</span>]);</span><br><span class="line">        d-&gt;rehashidx = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* More to rehash... */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>å½“hashè¡¨ç©ºé—´è¿›è¡Œresize/expandæ—¶, éœ€è¦rehash, rehashçš„è¿‡ç¨‹å¦‚ä¸‹: 
1.  å°†ht[1]æŒ‡å‘æ–°å¼€è¾Ÿçš„ç©ºé—´
2.  å°†ht[0]è¿ç§»åˆ°ht[1]ä¸­, è¿ç§»å‰å, åŒä¸€ä¸ªå…ƒç´ è·å¾—çš„æ¡¶çš„ä¸‹æ ‡å¯èƒ½å˜åŒ–(å› ä¸ºsizemaskçš„å˜åŒ–)
3.  rehashæ˜¯ä¸€æ¡¶ä¸€æ¡¶çš„è¿ç§»çš„, ä¼´éšç€rehashidxçš„å¢åŠ , ä¿è¯ht[0]ä¸­å°äºrehashidxçš„æ¡¶ä¸­æ— å…ƒç´ 
4.  å¯¹äºrehashè¿‡ç¨‹ä¸­æ–°å¢çš„å…ƒç´ , å¦‚æœht[0]ä¸­å·²ç»å­˜åœ¨è¯¥key, é‚£ä¹ˆå°±è¿”å›, å¦‚æœä¸å­˜åœ¨,
    é‚£ä¹ˆå°±åœ¨ht[1]ä¸­æ–°å¢è¯¥key,è¯¦æƒ…è§dictAddRawå’Œ_dictKeyIndexæ–¹æ³•
5.  rehashè¿‡ç¨‹å‘ç”Ÿåœ¨å¯¹dictè¿›è¡Œå¢åˆ æ”¹æŸ¥æ—¶, æ¯æ¬¡æ‰§è¡Œ_dictRehashStepä¸€æ¬¡,
    æ—¢ä¿è¯äº†rehashè¿‡ç¨‹çš„è¿›è¡Œ, åˆå°†è€—æ—¶æ¯”è¾ƒé•¿çš„æ•´ä¸ªrehashè¿‡ç¨‹å‡åˆ†åˆ°æ¯æ¬¡æ“ä½œä¸­
6.  rehashè¿‡ç¨‹æ‰§è¡Œå®Œæˆä¹‹å, ht[0]è¢«é‡Šæ”¾, ç„¶åht[0]æŒ‡å‘ht[1], ht[1]æŒ‡å‘ç©º,
    rehashidxè¢«ç½®ä¸ºé›¶, rehashç»“æŸ, ht[0]åˆæˆä¸ºå”¯ä¸€ä½¿ç”¨ä¸­çš„hashè¡¨
</code></pre><h3 id="4-å­—å…¸çš„éå†"><a href="#4-å­—å…¸çš„éå†" class="headerlink" title="4. å­—å…¸çš„éå†"></a>4. å­—å…¸çš„éå†</h3><p>è¯¦æƒ…è§<a href="https://blog.csdn.net/gqtcgq/article/details/50533336" target="_blank" rel="noopener">Redisæºç è§£æï¼š04å­—å…¸çš„éå†dictScan</a></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/28/Redisæºç -åŠ¨æ€å­—ç¬¦ä¸²sds/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="flyfish">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="flyfish's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/02/28/Redisæºç -åŠ¨æ€å­—ç¬¦ä¸²sds/" class="post-title-link" itemprop="http://yoursite.com/page/2/index.html">Redisæºç -åŠ¨æ€å­—ç¬¦ä¸²sds</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-02-28 18:41:08 / ä¿®æ”¹æ—¶é—´ï¼š19:21:57" itemprop="dateCreated datePublished" datetime="2019-02-28T18:41:08+08:00">2019-02-28</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Cè¯­è¨€/" itemprop="url" rel="index"><span itemprop="name">Cè¯­è¨€</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="åŠ¨æ€å­—ç¬¦ä¸²sds"><a href="#åŠ¨æ€å­—ç¬¦ä¸²sds" class="headerlink" title="åŠ¨æ€å­—ç¬¦ä¸²sds"></a>åŠ¨æ€å­—ç¬¦ä¸²sds</h2><h3 id="å†…å­˜å¸ƒå±€"><a href="#å†…å­˜å¸ƒå±€" class="headerlink" title="å†…å­˜å¸ƒå±€"></a>å†…å­˜å¸ƒå±€</h3><p><img src="/2019/02/28/Redisæºç -åŠ¨æ€å­—ç¬¦ä¸²sds/./sds.png" alt="Alt text"></p>
<h3 id="sdså¤´ç»“æ„"><a href="#sdså¤´ç»“æ„" class="headerlink" title="sdså¤´ç»“æ„"></a>sdså¤´ç»“æ„</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span> *sds;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Note: sdshdr5 is never used, we just access the flags byte directly.</span></span><br><span class="line"><span class="comment"> * However is here to document the layout of type 5 SDS strings. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) <span class="title">sdshdr5</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, and 5 msb of string length */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) <span class="title">sdshdr8</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> len;         <span class="comment">/* used */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> alloc;       <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) <span class="title">sdshdr16</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> len;        <span class="comment">/* used */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> alloc;      <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) <span class="title">sdshdr32</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> len;        <span class="comment">/* used */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> alloc;      <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) <span class="title">sdshdr64</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> len;        <span class="comment">/* used */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> alloc;      <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<pre><code>sdshdræ˜¯å­˜å‚¨sdså­—ç¬¦ä¸²çš„ä¿¡æ¯
å…¶ä¸­lenä¸ºå­—ç¬¦ä¸²çš„é•¿åº¦, 
allocå­˜å‚¨çš„æ˜¯bufæŒ‡é’ˆåˆ†é…ç©ºé—´çš„å¤§å°, 
flagsè¡¨ç¤ºå­—ç¬¦ä¸²çš„ç±»å‹,5,8,16,32,64 
å…¶ä¸­sdshdr5ä¸ä½¿ç”¨
</code></pre><hr>
<pre><code>__attribute__æœºåˆ¶: 
æ˜¯gnuçš„ä¸€å¤§ç‰¹è‰², å¯ä»¥è®¾ç½®å‡½æ•°å±æ€§, å˜é‡å±æ€§å’Œç±»å‹å±æ€§
å…¶ä½ç½®çº¦æŸä¸€èˆ¬æ”¾åœ¨å£°æ˜çš„å°¾éƒ¨`;`ä¹‹å‰
packedé€‰é¡¹ä»£è¡¨è¯¥ç»“æ„ä½¿ç”¨æœ€å°çš„å¯¹é½æ–¹å¼
</code></pre><hr>
<pre><code>lenä¸ºå·²ä½¿ç”¨çš„å­—ç¬¦ä¸²çš„é•¿åº¦
allocæ˜¯åˆ†é…çš„æ€»ç©ºé—´çš„é•¿åº¦(ä¸åŒ…æ‹¬header)
flagsæ˜¯ç±»å‹, flagsçš„å€¼ä¸º0,1,2,3,4 , åˆ†åˆ«å¯¹åº”sdshdr5, sdshdr8, sdshdr16, sdshdr32, sdshdr64
bufæ˜¯å­—ç¬¦ä¸²æŒ‡é’ˆèµ·ç‚¹, ä½¿ç”¨ç©ºæ•°ç»„, ä¸å ç”¨ç»“æ„ä½“ç©ºé—´, ä»£è¡¨headeræœ«å°¾, å­—ç¬¦ä¸²èµ·ç‚¹
</code></pre><h3 id="headerçš„éƒ¨åˆ†å®"><a href="#headerçš„éƒ¨åˆ†å®" class="headerlink" title="headerçš„éƒ¨åˆ†å®"></a>headerçš„éƒ¨åˆ†å®</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDS_HDR_VAR(T, s) struct sdshdr##T *sh = (void *)((s) - (sizeof(struct sdshdr##T)));</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDS_HDR(T, s) ((struct sdshdr##T *)((s) - (sizeof(struct sdshdr##T))))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDS_TYPE_5_LEN(f) ((f) &gt;&gt; SDS_TYPE_BITS)</span></span><br><span class="line"><span class="comment">/** è®¡ç®—é•¿åº¦, fæ˜¯flag, åªå­˜å‚¨ä¸‰ä½, ç§»åŠ¨ä¹‹åä¸º0, å› ä¸ºsdshdrä¸ä½¿ç”¨, ç›´æ¥è¿”å›0 **/</span></span><br></pre></td></tr></table></figure>
<p><strong>SDS_HDR_VAR</strong></p>
<pre><code>å£°æ˜ä¸€ä¸ªsh, æŒ‡å‘sçš„å¤´èµ·å§‹åœ°å€
## å°†ä¸¤ä¸ªå®å‚æ•°æ‹¼æ¥
æ¯”å¦‚, å¦‚æœè°ƒç”¨SDS_HDR_VAR(8,s)
é‚£ä¹ˆè°ƒç”¨å®çš„ç»“æœæ˜¯:  
struct sdshdr8 *sh = (void *)((s) - (sizeof(struct sdshdr8)));
this is amazing!!! 
è¯¥å®çš„ä½œç”¨æ˜¯è®¡ç®—sdsèµ·å§‹åœ°å€
</code></pre><hr>
<p><strong>SDS_HDR</strong></p>
<pre><code>ç›´æ¥è¿”å›ä¸€ä¸ªsh, æŒ‡å‘sçš„å¤´èµ·å§‹åœ°å€
</code></pre><hr>
<p><strong>SDS_TYPE_5_LEN</strong></p>
<pre><code>è®¡ç®—é•¿åº¦, fæ˜¯flag, åªå­˜å‚¨ä¸‰ä½, ç§»åŠ¨ä¹‹åä¸º0, å› ä¸ºsdshdr5ä¸ä½¿ç”¨, ç›´æ¥è¿”å›0
</code></pre><h3 id="headerçš„éƒ¨åˆ†å‡½æ•°"><a href="#headerçš„éƒ¨åˆ†å‡½æ•°" class="headerlink" title="headerçš„éƒ¨åˆ†å‡½æ•°"></a>headerçš„éƒ¨åˆ†å‡½æ•°</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> size_t <span class="title">sdslen</span><span class="params">(<span class="keyword">const</span> sds s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags = s[<span class="number">-1</span>];</span><br><span class="line">    <span class="keyword">switch</span> (flags &amp; SDS_TYPE_MASK) &#123;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_5:</span><br><span class="line">            <span class="keyword">return</span> SDS_TYPE_5_LEN(flags);</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_8:</span><br><span class="line">            <span class="keyword">return</span> SDS_HDR(<span class="number">8</span>, s)-&gt;len;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_16:</span><br><span class="line">            <span class="keyword">return</span> SDS_HDR(<span class="number">16</span>, s)-&gt;len;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_32:</span><br><span class="line">            <span class="keyword">return</span> SDS_HDR(<span class="number">32</span>, s)-&gt;len;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_64:</span><br><span class="line">            <span class="keyword">return</span> SDS_HDR(<span class="number">64</span>, s)-&gt;len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>è¿”å›sçš„å­—ç¬¦ä¸²é•¿åº¦
å…³äºs[-1]:
    1. sæŒ‡å‘çš„æ˜¯å­—ç¬¦ä¸²çš„ä½ç½®, åœ¨è¿™é‡Œå°±æ˜¯sdshdrä¸­bufçš„åœ°å€
    2. ç»“æ„ä½“ä¸­ç©ºæ•°ç»„ä¸å ç”¨å­˜å‚¨ç©ºé—´, æ•°ç»„æŒ‡å‘ä¸€ä¸ªåœ°å€, åœ¨è¿™é‡Œå°±æ˜¯sçš„èµ·å§‹åœ°å€.
    3. æ‰€ä»¥s=buf, s[-1]=flag
    4. s[-1]æ˜¯çœŸçš„éªšæ“ä½œ...
</code></pre><h3 id="sdsçš„å‡½æ•°æ€»ç»“"><a href="#sdsçš„å‡½æ•°æ€»ç»“" class="headerlink" title="sdsçš„å‡½æ•°æ€»ç»“"></a>sdsçš„å‡½æ•°æ€»ç»“</h3><h4 id="å¼€è¾Ÿ"><a href="#å¼€è¾Ÿ" class="headerlink" title="å¼€è¾Ÿ"></a>å¼€è¾Ÿ</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆå§‹åŒ–ä¸€ä¸ªsds, initä¸ºå­—ç¬¦ä¸²èµ·å§‹åœ°å€, initlenä¸ºé•¿åº¦</span></span><br><span class="line"><span class="function">sds <span class="title">sdsnewlen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *init, <span class="keyword">size_t</span> initlen)</span></span>; </span><br><span class="line"><span class="comment">//åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„sds</span></span><br><span class="line"><span class="function">sds <span class="title">sdsempty</span><span class="params">(<span class="keyword">void</span>)</span></span>; </span><br><span class="line"><span class="comment">//newä¸€ä¸ªsds, å­—ç¬¦ä¸²çš„å€¼ä¸ºinit</span></span><br><span class="line"><span class="function">sds <span class="title">sdsnew</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *init)</span></span>;</span><br><span class="line"><span class="comment">//å¤åˆ¶ä¸€ä¸ªsds</span></span><br><span class="line"><span class="function">sds <span class="title">sdsdup</span><span class="params">(<span class="keyword">const</span> sds s)</span> </span>;</span><br><span class="line"><span class="comment">//ä½¿sdsä¸­çš„free spaceèƒ½å®¹çº³addlené•¿åº¦çš„å­—ç¬¦ä¸². ä¸å¤Ÿå¼€è¾Ÿç©ºé—´, è¶³å¤Ÿä¸å¼€è¾Ÿ</span></span><br><span class="line"><span class="function">sds <span class="title">sdsMakeRoomFor</span><span class="params">(sds s, <span class="keyword">size_t</span> addlen)</span> </span>;</span><br></pre></td></tr></table></figure>
<h4 id="é‡Šæ”¾"><a href="#é‡Šæ”¾" class="headerlink" title="é‡Šæ”¾"></a>é‡Šæ”¾</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é‡Šæ”¾sdsç©ºé—´</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsfree</span><span class="params">(sds s)</span></span>;</span><br><span class="line"><span class="comment">//æ¸…é™¤æ‰æœ«å°¾çš„ç©ºé—²ç©ºé—´, ä»¥å…ç©ºé—´å ç”¨è¿‡å¤š</span></span><br><span class="line"><span class="function">sds <span class="title">sdsRemoveFreeSpace</span><span class="params">(sds s)</span></span>;</span><br><span class="line"><span class="comment">//æ¸…é™¤sdsä¸­çš„å­—ç¬¦ä¸², å³å°†stringéƒ¨åˆ†å˜æˆfree space</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsclear</span><span class="params">(sds s)</span></span>;</span><br></pre></td></tr></table></figure>
<h4 id="æ›´æ–°-amp-è·å–header"><a href="#æ›´æ–°-amp-è·å–header" class="headerlink" title="æ›´æ–°&amp;è·å–header"></a>æ›´æ–°&amp;è·å–header</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é€šè¿‡ç±»å‹è·å¾—ç»“æ„ä½“å¤§å°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">sdsHdrSize</span><span class="params">(<span class="keyword">char</span> type)</span></span>; </span><br><span class="line"><span class="comment">//é€šè¿‡å­—ç¬¦ä¸²é•¿åº¦è·å¾—ç±»å‹</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">char</span> <span class="title">sdsReqType</span><span class="params">(<span class="keyword">size_t</span> string_size)</span></span>; </span><br><span class="line"><span class="comment">//æ›´æ–°sdsä¸­çš„lenå­—æ®µ, ä»…ä»…æ˜¯æ›´æ–°è¯¥å­—æ®µ. </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsupdatelen</span><span class="params">(sds s)</span></span>;</span><br><span class="line"><span class="comment">//è·å–åŒ…æ‹¬sdså¤´åœ¨å†…çš„å ç”¨ç©ºé—´æ€»é‡</span></span><br><span class="line"><span class="keyword">size_t</span> sdsAllocSize(sds s);</span><br><span class="line"><span class="comment">//è·å–è·å¾—hdrçš„èµ·å§‹åœ°å€</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">sdsAllocPtr</span><span class="params">(sds s)</span> </span>;</span><br><span class="line"><span class="comment">//æ ¹æ®incr(å¯æ­£å¯è´Ÿ), è°ƒæ•´lenå¤§å°. æ›´æ–°lenå’Œç»“å°¾'\0'</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsIncrLen</span><span class="params">(sds s, <span class="keyword">ssize_t</span> incr)</span> </span>;</span><br><span class="line"><span class="comment">//ä½¿å¾—sdsä¸­çš„stringå¢é•¿åˆ°lençš„é•¿åº¦, å¤šå‡ºçš„éƒ¨åˆ†é‡ç½®ä¸º0, å¦‚æœlenè¾ƒå°, ä¸æ“ä½œ</span></span><br><span class="line"><span class="function">sds <span class="title">sdsgrowzero</span><span class="params">(sds s, <span class="keyword">size_t</span> len)</span></span>;</span><br></pre></td></tr></table></figure>
<h4 id="æ‹¼æ¥"><a href="#æ‹¼æ¥" class="headerlink" title="æ‹¼æ¥"></a>æ‹¼æ¥</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdscatlen</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">void</span> *t, <span class="keyword">size_t</span> len)</span> </span>;</span><br><span class="line"><span class="function">sds <span class="title">sdscat</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *t)</span> </span>;</span><br><span class="line"><span class="function">sds <span class="title">sdscatsds</span><span class="params">(sds s, <span class="keyword">const</span> sds t)</span> </span>;</span><br><span class="line"><span class="comment">//è½¬ä¹‰æ‹¼æ¥</span></span><br><span class="line"><span class="function">sds <span class="title">sdscatrepr</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *p, <span class="keyword">size_t</span> len)</span></span></span><br></pre></td></tr></table></figure>
<h4 id="æ‹·è´"><a href="#æ‹·è´" class="headerlink" title="æ‹·è´"></a>æ‹·è´</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdscpylen</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *t, <span class="keyword">size_t</span> len)</span> </span>;</span><br><span class="line"><span class="function">sds <span class="title">sdscpy</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *t)</span> </span>;</span><br></pre></td></tr></table></figure>
<h4 id="æ•´å‹è½¬sds"><a href="#æ•´å‹è½¬sds" class="headerlink" title="æ•´å‹è½¬sds"></a>æ•´å‹è½¬sds</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sdsll2str</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">long</span> <span class="keyword">long</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sdsull2str</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> v)</span></span>;</span><br><span class="line"><span class="function">sds <span class="title">sdsfromlonglong</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> value)</span> </span>;</span><br></pre></td></tr></table></figure>
<h4 id="æ ¼å¼åŒ–è¾“å‡º"><a href="#æ ¼å¼åŒ–è¾“å‡º" class="headerlink" title="æ ¼å¼åŒ–è¾“å‡º"></a>æ ¼å¼åŒ–è¾“å‡º</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdscatvprintf</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, va_list ap)</span> </span>;</span><br><span class="line"><span class="function">sds <span class="title">sdscatprintf</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>;</span><br><span class="line"><span class="comment">// ç±»ä¼¼äºsdscatprintf, ä½†æ˜¯æ¯”sdscatprintfå¿«, åŠŸèƒ½ä»…é™äºä¸Šé¢çš„ç±»å‹</span></span><br><span class="line"><span class="function">sds <span class="title">sdscatfmt</span><span class="params">(sds s, <span class="keyword">char</span> <span class="keyword">const</span> *fmt, ...)</span> </span>;</span><br></pre></td></tr></table></figure>
<h4 id="å­—ç¬¦ä¸²å¸¸ç”¨æ“ä½œ"><a href="#å­—ç¬¦ä¸²å¸¸ç”¨æ“ä½œ" class="headerlink" title="å­—ç¬¦ä¸²å¸¸ç”¨æ“ä½œ"></a>å­—ç¬¦ä¸²å¸¸ç”¨æ“ä½œ</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdstrim</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *cset)</span> </span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsrange</span><span class="params">(sds s, <span class="keyword">ssize_t</span> start, <span class="keyword">ssize_t</span> end)</span> </span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdstolower</span><span class="params">(sds s)</span> </span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdstoupper</span><span class="params">(sds s)</span> </span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sdscmp</span><span class="params">(<span class="keyword">const</span> sds s1, <span class="keyword">const</span> sds s2)</span> </span>;</span><br><span class="line"><span class="function">sds *<span class="title">sdssplitlen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">ssize_t</span> len, <span class="keyword">const</span> <span class="keyword">char</span> *sep, <span class="keyword">int</span> seplen, <span class="keyword">int</span> *count)</span> </span>;</span><br><span class="line"><span class="comment">//é‡Šæ”¾ç”±sdssplitlenå¼€è¾Ÿçš„ç©ºé—´</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsfreesplitres</span><span class="params">(sds *tokens, <span class="keyword">int</span> count)</span> </span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_hex_digit</span><span class="params">(<span class="keyword">char</span> c)</span> </span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hex_digit_to_int</span><span class="params">(<span class="keyword">char</span> c)</span> </span>;</span><br><span class="line"><span class="function">sds *<span class="title">sdssplitargs</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *line, <span class="keyword">int</span> *argc)</span> </span>;</span><br><span class="line"><span class="comment">// å°†å­—ç¬¦ä¸²ä¸­çš„formå­—ç¬¦æ›¿æ¢æˆto</span></span><br><span class="line"><span class="function">sds <span class="title">sdsmapchars</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *from, <span class="keyword">const</span> <span class="keyword">char</span> *to, <span class="keyword">size_t</span> setlen)</span> </span>;</span><br><span class="line"><span class="function">sds <span class="title">sdsjoin</span><span class="params">(<span class="keyword">char</span> **argv, <span class="keyword">int</span> argc, <span class="keyword">char</span> *sep)</span> </span>;</span><br><span class="line"><span class="function">sds <span class="title">sdsjoinsds</span><span class="params">(sds *argv, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> *sep, <span class="keyword">size_t</span> seplen)</span> </span>;</span><br></pre></td></tr></table></figure>
<p><code>`</code></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/28/Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="flyfish">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="flyfish's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/02/28/Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°/" class="post-title-link" itemprop="http://yoursite.com/page/2/index.html">Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-02-28 15:55:16 / ä¿®æ”¹æ—¶é—´ï¼š15:58:34" itemprop="dateCreated datePublished" datetime="2019-02-28T15:55:16+08:00">2019-02-28</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Cè¯­è¨€/" itemprop="url" rel="index"><span itemprop="name">Cè¯­è¨€</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>æœ¬æ–‡è½¬è½½è‡ª<a href="http://blog.sina.com.cn/s/blog_3fe961ae0100nf1l.html" target="_blank" rel="noopener">Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°</a></strong></p>
<h3 id="Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°"><a href="#Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°" class="headerlink" title="Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°"></a>Cè¯­è¨€å®ç°å¯å˜å‚æ•°å‡½æ•°</h3><pre><code>Cè¯­è¨€ä¸­å¯å˜å‚æ•°åˆ—è¡¨æ˜¯é€šè¿‡å®æ¥å®ç°çš„ï¼Œè¿™äº›å®å®šä¹‰äºstdarg.hå¤´æ–‡ä»¶ï¼Œå®ƒæ˜¯æ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ã€‚
Cè¯­è¨€çš„å¯å˜å‚æ•°å‡½æ•°ä¸»è¦è¦ç”¨åˆ°äº†ä¸€ä¸ªç±»å‹va_listå’Œä¸‰ä¸ªå®â€”â€”va_startã€va_argå’Œva_endã€‚
Cè¯­è¨€çš„å¯å˜å‚æ•°å‡½æ•°å¿…é¡»ä»¥æŸç§æ–¹å¼æä¾›å‚æ•°çš„ä¸ªæ•°ã€‚

æˆ‘ä»¬å¯ä»¥å£°æ˜ä¸€ä¸ªç±»å‹ä¸ºva_listçš„å˜é‡ï¼Œä¸è¿™å‡ ä¸ªå®é…åˆä½¿ç”¨ï¼Œè®¿é—®å‚æ•°çš„å€¼ã€‚è¿™ä¸ªå˜é‡é€šè¿‡è°ƒç”¨va_startæ¥åˆå§‹åŒ–ã€‚
å®ƒçš„ç¬¬1ä¸ªå‚æ•°æ˜¯va_listå˜é‡çš„åå­—ï¼Œ
ç¬¬2ä¸ªå‚æ•°æ˜¯çœç•¥å·å‰æœ€åä¸€ä¸ªæœ‰åå­—çš„å‚æ•°ã€‚
åˆå§‹åŒ–è¿‡ç¨‹æŠŠvar_argå˜é‡è®¾ç½®ä¸ºæŒ‡å‘å¯å˜å‚æ•°éƒ¨åˆ†çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚
ä¸ºäº†è®¿é—®å‚æ•°ï¼Œéœ€è¦ä½¿ç”¨va_argï¼Œè¿™ä¸ªå®æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šva_listå˜é‡å’Œå‚æ•°åˆ—è¡¨ä¸­ä¸‹ä¸€ä¸ªå‚æ•°çš„ç±»å‹ã€‚
va_argè¿”å›è¿™ä¸ªå‚æ•°çš„å€¼ï¼Œå¹¶ä½¿var_argæŒ‡å‘ä¸‹ä¸€ä¸ªå¯å˜å‚æ•°ã€‚
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯å˜å‚æ•°å¿…é¡»ä»å¤´åˆ°å°¾æŒ‰ç…§é¡ºåºè®¿é—®ï¼Œä¸å¯ä»¥ä¸€å¼€å§‹å°±è®¿é—®å‚æ•°åˆ—è¡¨ä¸­é—´çš„å‚æ•°ã€‚
å½“è®¿é—®å®Œæ¯•æœ€åä¸€ä¸ªå¯å˜å‚æ•°ä¹‹åï¼Œéœ€è¦è°ƒç”¨va_endã€‚
ç»™ä¸€æ®µç¤ºä¾‹ä»£ç ï¼š
</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="comment">//å‡½æ•°è‡³å°‘éœ€è¦ä¸€ä¸ªç¡®å®šçš„å‚æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">average</span><span class="params">(<span class="keyword">int</span> n_values,...)</span></span>&#123;</span><br><span class="line">    va_list var_arg;</span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    <span class="keyword">float</span> sum=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–ï¼Œå‡†å¤‡è®¿é—®å¯å˜å‚æ•°ï¼Œå®ƒçš„ç¬¬1ä¸ªå‚æ•°æ˜¯va_listå˜é‡çš„åå­—ï¼Œç¬¬2ä¸ªå‚æ•°æ˜¯çœç•¥å·å‰æœ€åä¸€ä¸ªæœ‰åå­—çš„å‚æ•°ã€‚</span></span><br><span class="line">    va_start(var_arg,n_values);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å–å„ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="keyword">for</span>(count=<span class="number">0</span>;count&lt;n_values;count++)&#123;</span><br><span class="line">        sum+=va_arg(var_arg,<span class="keyword">int</span>);        </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®Œæˆ</span></span><br><span class="line">    va_end(var_arg);</span><br><span class="line">    <span class="keyword">return</span> sum/n_values; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%f\n"</span>,average(<span class="number">5</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">5</span>));</span><br><span class="line">    system(<span class="string">"pause"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/28/å…³äº__attribute__æœºåˆ¶/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="flyfish">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="flyfish's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/02/28/å…³äº__attribute__æœºåˆ¶/" class="post-title-link" itemprop="http://yoursite.com/page/2/index.html">å…³äº__attribute__æœºåˆ¶</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-02-28 15:26:12 / ä¿®æ”¹æ—¶é—´ï¼š15:37:02" itemprop="dateCreated datePublished" datetime="2019-02-28T15:26:12+08:00">2019-02-28</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Cè¯­è¨€/" itemprop="url" rel="index"><span itemprop="name">Cè¯­è¨€</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="attribute-æœºåˆ¶"><a href="#attribute-æœºåˆ¶" class="headerlink" title="__attribute__æœºåˆ¶"></a>__attribute__æœºåˆ¶</h2><p><strong>æœ¬æ–‡è½¬è½½è‡ª:<a href="http://rungame.me/blog/2016/09/21/attribute-syntax/" target="_blank" rel="noopener">GNU C ä¸­çš„__attribute__æœºåˆ¶</a></strong></p>
<pre><code>__attribute__ æ˜¯ GCC æä¾›çš„ä¸€ç§è¯­æ³•,å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨ç¼–è¯‘æ—¶å¯¹å£°æ˜çš„å‡½æ•°ã€å˜é‡å’Œç±»å‹åšä¸€äº›ç‰¹æ®Šå¤„ç†æˆ–è€…æ˜¯æ£€æŸ¥æ“ä½œã€‚

__attribute__ çš„è¯­æ³•æ ¼å¼ä¸º: __attribute__ ((attribute-list)) , 
attribute-list æ˜¯æŒ‡ä»¤é›† , __attribute__ å‡ºç°åœ¨å‡½æ•°ã€å˜é‡å’Œç±»å‹å£°æ˜çš„ â€œ;â€ å‰ã€‚

__attribute__ æœ‰ä¸‰ç±»,åˆ†åˆ«ä¸º
    1. å‡½æ•°å±æ€§(Function Attribute) 
    2. å˜é‡å±æ€§(Variable Attribute) 
    3. ç±»å‹å±æ€§(Type Attribute)
</code></pre><h3 id="ä¸€-å‡½æ•°å±æ€§"><a href="#ä¸€-å‡½æ•°å±æ€§" class="headerlink" title="ä¸€. å‡½æ•°å±æ€§"></a>ä¸€. å‡½æ•°å±æ€§</h3><h4 id="1-format-archetype-string-index-first-to-check"><a href="#1-format-archetype-string-index-first-to-check" class="headerlink" title="1. format (archetype, string-index, first-to-check)"></a>1. format (archetype, string-index, first-to-check)</h4><pre><code>format å±æ€§é€šè¿‡æŒ‡å®š printf, scanf, strftime æˆ– strfmon ç­‰æ–¹æ³•æ¥æ£€æµ‹å‡½æ•°çš„å‚æ•°æ˜¯å¦åŒæ ·é€‚ç”¨äºè¿™äº›æŒ‡å®šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ–¹æ³•
,å¦‚æœä¸é€‚ç”¨,ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶çš„å°±ä¼šå‘å‡ºè­¦å‘Š,ä»è€Œå‘ç°é”™è¯¯ã€‚
</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">my_printf</span> <span class="params">(<span class="keyword">int</span> value, <span class="keyword">const</span> <span class="keyword">char</span> *my_format, ...)</span> __<span class="title">attribute__</span> <span class="params">((format (<span class="built_in">printf</span>, <span class="number">2</span>, <span class="number">3</span>)))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    my_printf(<span class="number">0</span>, <span class="string">"age = %d\n"</span>,<span class="number">17</span>);</span><br><span class="line">    my_printf(<span class="number">0</span>, <span class="string">"age = %d\n"</span>,<span class="string">"17"</span>);</span><br><span class="line">    my_printf(<span class="number">0</span>, <span class="string">"age = %d name = %s\n"</span>,<span class="number">17</span>,<span class="string">"sbxfc"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>ä¸Šé¢ç¤ºä¾‹ä¸­, format å±æ€§çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šäº†ä¸€ä¸ª printf æ–¹æ³•,
ç¬¬äºŒä¸ªå‚æ•° string-index è¡¨ç¤ºå‡½æ•° my_printf é‡Œæ ¼å¼åŒ–å‚æ•°æ˜¯æ€»å‚æ•°çš„ç¬¬å‡ ä¸ª,è¿™é‡Œæˆ‘ä»¬çš„æ ¼å¼åŒ–å‚æ•° my_format æ˜¯ç¬¬2ä¸ªå‚æ•°,
format å±æ€§çš„ç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤º,å‚æ•°é›†åˆ (â€¦) ä»å‡½æ•° my_printf çš„ç¬¬å‡ ä¸ªå‚æ•°å¼€å§‹å‡ºç°ã€‚

å¦‚æ— æ„å¤–,ä¸Šè¿°ç¤ºä¾‹åœ¨ gcc ç¼–è¯‘æ—¶ä¼šæç¤ºä»¥ä¸‹è­¦å‘Šä¿¡æ¯:
å»æ‰__attribute__å±æ€§,è¯¥ç¤ºä¾‹åˆ™ä¸ä¼šæç¤ºé”™è¯¯,ä½†è¿è¡Œæ—¶ä¼šå‡ºé”™ã€‚
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -c main.c</span><br><span class="line">main.c:12:31: warning: format specifies <span class="built_in">type</span> <span class="string">'int'</span> but the argument has <span class="built_in">type</span></span><br><span class="line">  <span class="string">'char *'</span> [-Wformat]</span><br><span class="line">my_printf(0, <span class="string">"age = %d\n"</span>,<span class="string">"17"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="2-noreturn"><a href="#2-noreturn" class="headerlink" title="2. noreturn"></a>2. noreturn</h4><pre><code>noreturn å±æ€§è¡¨ç¤ºå…¶æŒ‡å®šçš„å‡½æ•°æ²¡æœ‰è¿”å›å€¼,å½“ç¼–è¯‘å™¨æ‰§è¡Œåˆ°è¿™æ—¶,è¦é¢å¯¹ç°å®,ä¸è¦å¤§æƒŠå°æ€ª(~æ…Œå¿™æŠ¥é”™~)ã€‚
</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="comment">/*__attribute__((noreturn))*/</span> onExit();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onExit</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (state == <span class="number">1</span>) &#123;</span><br><span class="line">        onExit();</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    test(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨gcc -c -Wall test.cç¼–è¯‘</span></span><br></pre></td></tr></table></figure>
<h4 id="3-deprecated"><a href="#3-deprecated" class="headerlink" title="3. deprecated"></a>3. deprecated</h4><pre><code>deprecated å±æ€§å¯ä»¥ç”¨æ¥æ ‡è¯†ä¸€ä¸ªé¢„è®¡å°†ä¼šè¢«å¼ƒç”¨çš„å‡½æ•°,å¦‚æœå¼€å‘è€…ä½¿ç”¨è¯¥å‡½æ•°,ç¼–è¯‘æ—¶å°±ä¼šå‘å‡ºè­¦å‘Š,
å¹¶æç¤ºå‡ºé”™çš„è¡Œæ•°ã€‚è­¦å‘Šä¿¡æ¯åªä¼šåœ¨å¼€å‘è€…è°ƒç”¨è¯¥å‡½æ•°æ—¶æ‰ä¼šæç¤º,
deprecated ä¹Ÿå¯ä»¥ç”¨äºå˜é‡å’Œç±»å‹ã€‚
</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">old_fn</span> <span class="params">()</span> __<span class="title">attribute__</span> <span class="params">((deprecated))</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">old_fn</span> <span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">int</span> (*fn_ptr)() = old_fn;</span><br></pre></td></tr></table></figure>
<pre><code>åœ¨ä¸Šé¢ç¤ºä¾‹ä¸­,åªä¼šåœ¨ç¬¬3è¡Œæå‡ºè­¦å‘Š:
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">main.c:7:19: warning: <span class="string">'old_fn'</span> is deprecated [-Wdeprecated-declarations]</span><br><span class="line">int (*fn_ptr)() = old_fn;</span><br><span class="line">                    ^</span><br><span class="line">main.c:6:5: note: <span class="string">'old_fn'</span> has been explicitly marked deprecated here</span><br><span class="line">int old_fn ();</span><br></pre></td></tr></table></figure>
<h4 id="4-constructor-amp-destructor"><a href="#4-constructor-amp-destructor" class="headerlink" title="4. constructor &amp; destructor"></a>4. constructor &amp; destructor</h4><pre><code>è®¾ç½® constructor å±æ€§å¯ä»¥ä½¿å‡½æ•°åœ¨ main æ–¹æ³•ä¹‹å‰æ‰§è¡Œ,è€Œè®¾ç½® destructor å¯ä»¥ä½¿å‡½æ•°åœ¨ main æ–¹æ³•ä¹‹åæ‰§è¡Œã€‚
</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__((constructor)) <span class="function"><span class="keyword">void</span> <span class="title">before_func</span> <span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"before \n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((destructor)) <span class="function"><span class="keyword">void</span> <span class="title">after_func</span> <span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"after \n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"main func \n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>constructor ã€ destructor å‡½æ•°ä¹Ÿå¯ä»¥è®¾ç½®æ‰§è¡Œçš„ä¼˜å…ˆçº§:
__attribute__((constructor(PRIORITY)))
__attribute__((destructor(PRIORITY)))
</code></pre><h3 id="äºŒ-å˜é‡å±æ€§"><a href="#äºŒ-å˜é‡å±æ€§" class="headerlink" title="äºŒ. å˜é‡å±æ€§"></a>äºŒ. å˜é‡å±æ€§</h3><h4 id="1-aligned-alignment"><a href="#1-aligned-alignment" class="headerlink" title="1. aligned (alignment)"></a>1. aligned (alignment)</h4><pre><code>aligned å±æ€§è®©å…¶æŒ‡å®šçš„å˜é‡æˆ–ç»“æ„ä½“æˆå‘˜æŒ‰ alignment å­—èŠ‚å¤§å°å¯¹é½ã€‚
å¦‚æœå…¶ä¸­å¯¹é½é•¿åº¦æœ‰é•¿åº¦å¤§äº alignmentçš„,åˆ™æŒ‰ç…§æœ€å¤§å¯¹é½é•¿åº¦æ¥å¯¹é½ã€‚
</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»“æ„ä½“çš„å¯¹é½å€¼ä¸º8</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span> a;</span><br><span class="line">  <span class="keyword">int</span> x[<span class="number">2</span>] __attribute__ ((aligned (<span class="number">8</span>)));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> s0 = <span class="keyword">sizeof</span>(struct foo);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"s0 = %d\n"</span>,s0);<span class="comment">//print s0 = 16</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-packed"><a href="#2-packed" class="headerlink" title="2. packed"></a>2. packed</h4><pre><code>packed å±æ€§ç”¨äºè®¾ç½®å˜é‡æˆ–ç»“æ„ä½“æˆå‘˜ä»¥æœ€å°çš„å¯¹é½æ–¹å¼å¯¹é½ã€‚
åœ¨ä¸‹é¢çš„ç»“æ„ä½“ä¸­,ç”±äº x å·²ç»ä½¿ç”¨ packed è¿›è¡Œå¯¹é½,æ‰€ä»¥æ­¤æ—¶ç»“æ„ä½“ä»¥ a çš„sizeæ¥å¯¹é½:
</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span>&#123;</span></span><br><span class="line">  <span class="keyword">char</span> a;</span><br><span class="line">  <span class="keyword">int</span> x[<span class="number">2</span>] __attribute__ ((packed));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> s0 = <span class="keyword">sizeof</span>(struct foo);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"s0 = %d\n"</span>,s0);<span class="comment">//print s0 = 9</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä¸‰-ç±»å‹å±æ€§"><a href="#ä¸‰-ç±»å‹å±æ€§" class="headerlink" title="ä¸‰. ç±»å‹å±æ€§"></a>ä¸‰. ç±»å‹å±æ€§</h3><h4 id="1-packed"><a href="#1-packed" class="headerlink" title="1. packed"></a>1. packed</h4><pre><code>å¦‚æœ packed å±æ€§ç”¨åœ¨ struct æˆ– union ä¸Š,è¡¨ç¤ºè¯¥ç»“æ„çš„æˆå‘˜å˜é‡æŒ‰ç…§ç´§å‡‘æ¨¡å¼å¯¹é½,
å³ä»¥å˜é‡çš„å®é™…å ç”¨å­—èŠ‚å¯¹é½,ä¸ç”¨ç¼–è¯‘å™¨è¿›è¡Œä¼˜åŒ–å¯¹é½ã€‚å¦‚æœç”¨åœ¨ enum ä¸Š,åˆ™è¡¨ç¤ºä½¿ç”¨æœ€å°çš„æ•´æ•°æ¥å­˜å‚¨æšä¸¾ç±»å‹ã€‚
</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">my_unpacked_struct</span>&#123;</span></span><br><span class="line">  <span class="keyword">char</span> c;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">my_packed_struct</span> &#123;</span></span><br><span class="line">   <span class="keyword">char</span> c;</span><br><span class="line">   <span class="keyword">int</span>  i;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">my_unpacked_struct</span> <span class="title">s</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> s0 = <span class="keyword">sizeof</span>(struct my_unpacked_struct);</span><br><span class="line">  <span class="keyword">int</span> s1 = <span class="keyword">sizeof</span>(struct my_packed_struct);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"s0 = %d,s1 = %d\n"</span>,s0,s1);<span class="comment">//print s0 = 8,s1 = 13</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/default.png" alt="flyfish">
            
              <p class="site-author-name" itemprop="name">flyfish</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">34</span>
                    <span class="site-state-item-name">æ—¥å¿—</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">åˆ†ç±»</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">25</span>
                    <span class="site-state-item-name">æ ‡ç­¾</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">flyfish</span>

  

  
</div>


  <div class="powered-by">ç”± <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨ v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
